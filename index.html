<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta id="viewportMeta" name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArciWeb - PGA StatsKeeper v.5.21(Gallery Edition)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --accent-green: #2ecc71;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --highlight-gold: #f1c40f;
            --border-radius: 12px;
            --transition: 0.2s ease;
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --modal-z: 1000;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header & Layout --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-left { display: flex; flex-direction: column; gap: 5px; }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .version { font-size: 0.6rem; color: var(--text-muted); margin-left: 5px; vertical-align: middle; }

        .header-ranks { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 5px; }
        .header-rank-link {
            font-size: 0.75rem; color: var(--accent-green); cursor: pointer;
            text-decoration: none; border-bottom: 1px dotted var(--accent-green); transition: var(--transition);
        }
        .header-rank-link:hover { color: var(--highlight-gold); border-bottom-color: var(--highlight-gold); }
        
        /* Nový štýl pre Amateur Rank (KFT) */
        .header-rank-link.amateur-rank {
            color: #bdc3c7; border-bottom-color: #bdc3c7;
        }
        .header-rank-link.amateur-rank:hover {
            color: #fff; border-bottom-color: #fff;
        }

        .header-icons { display: flex; gap: 15px; align-items: center; }
        .icon-btn {
            background: none; border: none; color: var(--text-main);
            font-size: 1.4rem; cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .icon-btn:hover { transform: scale(1.1); color: var(--accent-green); }

        /* --- Search --- */
        .search-container { margin-bottom: 15px; position: relative; }
        #playerSearch {
            width: 100%; padding: 12px 15px; border-radius: var(--border-radius);
            border: 1px solid #444; background-color: var(--card-bg);
            color: var(--text-main); font-size: 1rem; box-sizing: border-box;
        }
        #searchResults {
            position: absolute; top: 100%; left: 0; width: 100%;
            background-color: var(--card-bg); border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 100;
            max-height: 250px; overflow-y: auto; display: none; border: 1px solid #555;
        }
        .search-item { padding: 12px 15px; border-bottom: 1px solid #444; cursor: pointer; }
        .search-item:hover { background-color: #444; }

        /* --- Filters --- */
        #filterContainer { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .filter-section { width: 100%; }
        .filter-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }

        .filter-row { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; }
        .btn-full-width { width: 100%; display: block; text-align: center; }

        .filter-btn {
            padding: 8px 12px; border-radius: 8px; border: 1px solid #444;
            cursor: pointer; font-weight: 600; font-size: 0.85rem;
            transition: var(--transition); display: flex; align-items: center;
            justify-content: center; user-select: none;
            background-color: var(--card-bg); color: var(--text-muted); flex: 1;
        }
        .filter-btn:hover { background-color: #3d3d3d; }
        .filter-btn.active { background-color: var(--accent-green); color: #000; border-color: var(--accent-green); }
        .filter-btn.empty { opacity: 0.4; pointer-events: none; }
        
        .filter-btn.important-tour { 
            border: 1px solid var(--highlight-gold); color: var(--highlight-gold); 
            box-shadow: 0 0 5px rgba(241, 196, 15, 0.2);
        }
        .filter-btn.important-tour.active { 
            background-color: var(--highlight-gold); color: #000; 
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }
        .filter-btn.significant-tour { border: 1px dashed var(--accent-blue); color: var(--accent-blue); }
        .filter-btn.significant-tour.active { background-color: var(--accent-blue); color: #fff; }

        .dropdown-filter {
            width: 100%; background: var(--card-bg); border: 1px solid #444;
            color: white; padding: 10px; border-radius: 8px; text-align: left;
            position: relative; cursor: pointer;
        }
        .dropdown-content {
            display: none; flex-wrap: wrap; gap: 5px; padding: 10px;
            background: var(--card-bg); border: 1px solid #444; border-radius: 8px;
            margin-top: 5px; max-height: 200px; overflow-y: auto;
        }
        .dropdown-content.show { display: flex; }

        /* --- Table --- */
        .table-container {
            overflow-x: auto; background-color: var(--card-bg);
            border-radius: var(--border-radius); padding: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #444; font-size: 0.85rem; }
        td:nth-child(2), th:nth-child(2) { text-align: left; min-width: 120px; }
        th { cursor: pointer; color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 0.7rem; white-space: nowrap; }
        th:hover { color: var(--text-main); text-decoration: underline; }
        
        .player-row:hover { background-color: rgba(255,255,255,0.05); cursor: pointer; }
        .important-row { background-color: rgba(241, 196, 15, 0.15); color: var(--highlight-gold); font-weight: 500; }
        .significant-row { background-color: rgba(52, 152, 219, 0.15); color: var(--accent-blue); }
        
        /* --- Modal / Popup System --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; animation: fadeIn 0.2s forwards; z-index: 1000;
        }
        /* Dynamické vrstvenie pre viacero okien */
        .modal-overlay.stacked { 
    background: rgba(0,0,0,0.6); 
    backdrop-filter: none; /* TOTO JE KĽÚČOVÁ OPRAVA */
    -webkit-backdrop-filter: none;
}

        .modal {
            background-color: var(--bg-color);
            border-radius: 16px;
            width: 95%; max-width: 900px; max-height: 92vh;
            overflow-y: auto; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            border: 1px solid #333; display: flex; flex-direction: column;
            color: var(--text-main);
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg);
            position: sticky; top: 0; z-index: 100;
        }
        .modal-header h2 { margin: 0; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 10px;}
        .close-btn { background: none; border: none; color: #fff; font-size: 1.8rem; cursor: pointer; }
        .modal-body { padding: 20px; overflow-y: auto; }

        /* --- Profile Grid Layout --- */
        .profile-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; overflow-x: auto; }
        .profile-tab {
            flex: 1; min-width: 80px; padding: 10px; text-align: center; background: var(--card-bg);
            border-radius: 8px; cursor: pointer; border: 1px solid transparent; color: #aaa;
        }
        .profile-tab.active { background: var(--accent-green); color: #000; font-weight: bold; }

        .profile-filters-area { 
            margin-bottom: 20px; 
            background: var(--card-bg);
            padding: 10px; border-radius: 8px; 
        }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }

        .stat-box {
            background: var(--card-bg); padding: 12px 5px;
            border-radius: 8px; text-align: center;
            display: flex; flex-direction: column; justify-content: center;
            border: 1px solid #3d3d3d; min-height: 70px;
        }
        .stat-box.highlight { border-color: var(--highlight-gold); background: rgba(241, 196, 15, 0.05); }
        .stat-box.season-highlight { border-color: var(--accent-blue); background: rgba(52, 152, 219, 0.05); }
        
        .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.1rem; font-weight: 700; color: #fff; }
        .stat-value.gold { color: var(--highlight-gold); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.blue { color: var(--accent-blue); }
        .rank-clickable { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .rank-clickable:hover { color: var(--accent-green); }

        .player-card-container {
            display: flex; 
            flex-direction: column; /* Aby sa veci ukladali pod seba */
            justify-content: flex-end; /* Texty zarovnáme úplne dole */
            
            background: linear-gradient(145deg, #333 0%, #000 100%);
            padding: 0; /* Vymažeme padding, aby fotka bola až po okraj */
            border-radius: 12px; margin-bottom: 20px;
            border: 2px solid #444; box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            align-items: center; position: relative; 
            
            min-height: 480px; /* Zväčšená výška karty */
            overflow: hidden; 
            transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
        }

.player-card-container.gold { 
    /* Viacstupňový gradient pre efekt zlatého odlesku */
    background: linear-gradient(135deg, #BF953F 0%, #FCF6BA 25%, #B38728 50%, #FBF5B7 75%, #AA771C 100%);
    border-color: #fff; 
    box-shadow: 0 0 30px rgba(251, 245, 183, 0.6);
}

.player-card-container.silver { 
    /* Striedanie sivej a bielej pre efekt lešteného striebra */
    background: linear-gradient(135deg, #E2E2E2 0%, #FFFFFF 25%, #9E9E9E 50%, #FFFFFF 75%, #8A8A8A 100%);
    border-color: #fff; 
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
}

.player-card-container.bronze { 
    /* Hlboká meď s jasným svetlým pruhom uprostred */
    background: linear-gradient(135deg, #804A00 0%, #FFC880 25%, #B06F20 50%, #FFC880 75%, #804A00 100%);
    border-color: #fff; 
    box-shadow: 0 0 25px rgba(255, 200, 128, 0.4);
}

.player-card-container.green { 
    /* Ponechané bez zmeny */
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); 
    border-color: #fff; 
    box-shadow: 0 0 20px rgba(46, 204, 113, 0.3);
}

.player-card-container.blue { 
    background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%);
    border-color: #aaa; 
    box-shadow: 0 0 20px rgba(96, 108, 136, 0.4);
}

.player-card-container.grey { 
    /* Názov triedy je 'grey', ale farba je jasná svetlo-modrá */
    background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    border-color: #fff; 
    box-shadow: 0 0 25px rgba(102, 166, 255, 0.5);
}


.player-card-container.cherry { 
    /* Výrazná hlboká višňová, prechádzajúca do jasnej červenej */
    background: linear-gradient(135deg, #960018 0%, #FF0844 100%);
    border-color: #fff; 
    box-shadow: 0 0 25px rgba(255, 8, 68, 0.4);
}

        /* Box pre OVR (Vpravo hore) */
        .card-ovr-box {
            position: absolute;
            top: 20px; right: 20px;
            width: 80px; height: 100px;
            background: #1e272e; 
            clip-path: polygon(0% 0%, 100% 0%, 100% 85%, 50% 100%, 0% 85%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-top: 2px solid rgba(255,255,255,0.2);
            z-index: 10;
        }
        .card-ovr-val { font-size: 2.5rem; font-weight: 900; line-height: 1; letter-spacing: -2px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .card-ovr-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-top: 0px; opacity: 0.8; }
        
        /* Box pre MENO (Vľavo hore - Len text bez rámčeka) */
        .card-name-box {
            position: absolute;
            top: 25px; left: 25px;
            z-index: 10;
            display: flex;
            align-items: flex-start;
        }
        .card-name-text {
            color: #fff; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
            font-size: 1.4rem; /* Zväčšené písmo */
            text-align: left;
            line-height: 1.1;
            /* Silný tieň aby bolo meno čitateľné na každom pozadí */
            text-shadow: 3px 3px 0 #000, 0 0 10px rgba(0,0,0,0.5);
        }


        /* Fotka */
 .card-player-img {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; object-position: top center;
    z-index: 0; opacity: 1; pointer-events: none;
    transform: scale(0.95);  

        }
        .card-player-img:hover { transform: scale(1.05); transition: transform 5s ease; }

        /* Informácie (Atribúty) - upravené centrovanie */
        .card-info { 
            width: 100%; position: relative; z-index: 5; 
            padding: 80px 20px 20px 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
            text-align: center; text-shadow: 0 2px 5px rgba(0,0,0,1);
        }
        
        .card-attrs { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; 
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
        }
        
        /* Centrovanie atribútov k sebe */
        .attr-row { 
            display: flex; 
            justify-content: center; /* Toto to dá do stredu */
            align-items: center; 
            padding: 2px 0; 
            gap: 8px; /* Medzera medzi PWR a číslom */
        }
        .attr-name { color: #ddd; font-size: 0.85rem; font-weight: 600; text-align: right; }
        .attr-val { font-weight: bold; color: #fff; font-size: 1.1rem; text-align: left; }
        .attr-val.high { color: #2ecc71; }
        .attr-val.low { color: #e74c3c; }

        /* --- TROPHY ROOM & GALLERY --- */
        .trophy-section {
            background: var(--card-bg);
            padding: 20px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid #444; position: relative;
        }
        .trophy-title { 
            font-size: 0.9rem; text-transform: uppercase; color: #aaa; letter-spacing: 1px; 
            margin-bottom: 20px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .trophy-grid { 
            display: flex; flex-direction: column; align-items: center; gap: 40px; justify-content: flex-start; 
            max-height: 600px; overflow-y: auto; padding: 30px 20px 20px 20px;
        }
        .trophy-item {
            flex-shrink: 0;display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            position: relative; width: 130px;
        }
        .trophy-item:hover { transform: scale(1.1); z-index: 5; }
        .trophy-inner { position: relative; display: flex; justify-content: center; align-items: center; }
        .trophy-img {
            width: auto; height: 190px; object-fit: contain;
            filter: drop-shadow(0 5px 8px rgba(0,0,0,0.6)); transition: transform 0.3s ease;
        }
        .trophy-item:hover .trophy-img { transform: scale(1.15) rotate(-3deg); filter: drop-shadow(0 28px 32px rgba(0,0,0,0.8)); }
        .m-silver { font-size: 7.2rem; filter: drop-shadow(0 0 34px #dfe6e9); opacity: 0.9; }
        .m-bronze { font-size: 5.2rem; filter: drop-shadow(0 0 24px #cd6133); opacity: 0.9; }
        .trophy-date { 
            font-size: 0.7rem; color: #fff; margin-top: 8px; opacity: 0; transition: 0.2s; 
            position: absolute; bottom: -35px; background: rgba(0,0,0,0.95); 
            padding: 4px 8px; border-radius: 4px; border: 1px solid var(--highlight-gold); white-space: nowrap;
            pointer-events: none; z-index: 10; text-align: center; font-weight: bold;
        }
        .trophy-item:hover .trophy-date { opacity: 1; bottom: -45px; }

        /* --- GLOBAL GALLERY STYLES --- */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 15px; padding: 10px;
        }
        .gallery-item {
            display: flex; flex-direction: column; align-items: center; text-align: center;
            background: var(--card-bg); padding: 10px; border-radius: 8px;
            border: 1px solid #333; transition: 0.2s; position: relative;
        }
        .gallery-item.locked { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; }
        .gallery-item.unlocked { cursor: pointer; border-color: var(--accent-green); }
        .gallery-item.unlocked:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(46, 204, 113, 0.3); }
        .gallery-label { font-size: 0.75rem; color: #888; margin-top: 8px; font-weight: bold; }
        .gallery-item.unlocked .gallery-label { color: var(--highlight-gold); }

        /* --- NEMESIS SYSTEM --- */
        .rivalry-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .rival-box { 
            flex: 1; min-width: 140px; background: var(--card-bg);
            padding: 12px; border-radius: 8px; border: 1px solid #333; 
            text-align: center; transition: 0.2s; position: relative; overflow: hidden;
        }
        .rival-box:hover { transform: translateY(-3px); border-color: #555; }
        .rival-title { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1px; margin-bottom: 8px; }
        .rival-name { font-size: 1.1rem; font-weight: bold; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rival-stat { font-size: 0.85rem; color: #ccc; }
        .rival-score { font-weight: bold; color: var(--highlight-gold); }
        .rival-icon { font-size: 2rem; display: block; margin-bottom: 5px; opacity: 0.8; }
        .rival-box.bunny { border-bottom: 2px solid var(--accent-green); background: linear-gradient(0deg, rgba(46,204,113,0.05), var(--card-bg)); }
        .rival-box.nemesis { border-bottom: 2px solid var(--accent-red); background: linear-gradient(0deg, rgba(231,76,60,0.05), var(--card-bg)); }

        /* --- GRAPH Styles --- */
        .graph-section { background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #3d3d3d; }
        .graph-container { width: 100%; height: 200px; position: relative; }
        .graph-tooltip {
            position: absolute; background: rgba(0,0,0,0.9); color: #fff;
            padding: 6px 12px; border-radius: 4px; font-size: 0.8rem;
            pointer-events: none; display: none; z-index: 100;
            white-space: nowrap; border: 1px solid var(--accent-green);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .graph-path {
            fill: none; stroke: var(--highlight-gold); stroke-width: 2.5;
            stroke-linecap: round; stroke-linejoin: round;
            filter: drop-shadow(0 0 4px rgba(241, 196, 15, 0.4));
            animation: drawLine 1s ease forwards;
        }
        .graph-dot {
            fill: var(--card-bg); stroke: var(--accent-green); stroke-width: 2;
            r: 3.5; transition: r 0.2s, fill 0.2s; cursor: pointer;
        }
        .graph-dot:hover { r: 6; fill: var(--accent-green); stroke: #fff; }
        @keyframes drawLine { from { stroke-dasharray: 1000; stroke-dashoffset: 1000; } to { stroke-dasharray: 1000; stroke-dashoffset: 0; } }

        /* --- ACHIEVEMENTS Styles --- */
        .achievements-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px; margin-bottom: 30px; padding: 15px;
            background: var(--card-bg); border-radius: 8px;
            align-items: start;
        }
        .badge {
            width: 100%; aspect-ratio: 1/1; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; position: relative;
            transition: transform 0.2s; border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .badge:hover { transform: scale(1.1); z-index: 2; }
        .badge.locked { background-color: #333; color: #555; filter: grayscale(100%); border: 1px dashed #555; }
        .badge.unlocked {
            background: linear-gradient(135deg, #f1c40f 0%, #b8860b 100%);
            color: #000; border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.4);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* --- ACHIEVEMENT DETAILS MODAL STYLES --- */
        .ach-header { text-align: center; padding: 20px; background: var(--bg-color); border-bottom: 1px solid #444; }
        .ach-icon-large { font-size: 4rem; margin-bottom: 10px; display: block; }
        .ach-title { font-size: 1.5rem; color: var(--highlight-gold); margin: 0; }
        .ach-desc { color: #ccc; font-style: italic; margin-top: 5px; }
        .ach-stat-bar { background: #333; height: 20px; border-radius: 10px; margin: 15px 20px; position: relative; overflow: hidden; }
        .ach-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 1s ease; }
        .ach-stat-text { text-align: center; color: #fff; font-weight: bold; margin-bottom: 15px; }
        .ach-player-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 20px; max-height: 400px; overflow-y: auto; }
        .ach-player-card { background: var(--card-bg); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #444; cursor: pointer; transition: 0.2s; }
        .ach-player-card:hover { border-color: var(--highlight-gold); background: #383838; }

        /* --- GLOBAL ACHIEVEMENT LIST STYLE --- */
        .global-ach-list { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .global-ach-item { 
            display: flex; align-items: center; background: var(--card-bg); 
            padding: 10px; border-radius: 8px; border: 1px solid #444; 
            cursor: pointer; transition: background 0.2s; 
        }
        .global-ach-item:hover { background: #383838; border-color: var(--accent-green); }
        .global-ach-icon { font-size: 2rem; margin-right: 15px; min-width: 50px; text-align: center; }
        .global-ach-info { flex: 1; }
        .global-ach-name { font-weight: bold; color: var(--highlight-gold); }
        .global-ach-desc { font-size: 0.85rem; color: #ccc; }
        .global-ach-count { font-weight: bold; color: var(--accent-green); font-size: 1.2rem; }
        
        /* --- PLAYER PROFILE RECORDS STYLE --- */
        .profile-records-container { margin-bottom: 20px; background: #252525; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .profile-records-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .profile-record-item { background: #333; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #555; transition: transform 0.2s; }
        .profile-record-item:hover { transform: scale(1.03); border-color: var(--highlight-gold); }
        .p-rec-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        .p-rec-name { font-size: 0.7rem; color: #aaa; text-transform: uppercase; font-weight: bold; }
        .p-rec-val { font-size: 1rem; color: var(--highlight-gold); font-weight: bold; margin-top: 2px; }

        /* --- ENHANCED COMPARATOR Styles --- */
        .vs-container { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .vs-select { flex: 1; padding: 12px; background: var(--card-bg); color: #fff; border: 1px solid #444; border-radius: 8px; font-size:1rem; min-width: 150px; }
        .vs-badge { font-weight:bold; font-size:1.2rem; color:var(--accent-red); background:#222; padding:5px 15px; border-radius:20px; border:1px solid var(--accent-red); }
        .vs-filters { width: 100%; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap; }
        .vs-detailed-grid {
            display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 2px;
            background: #333; border-radius: 8px; overflow: hidden;
            margin-bottom: 15px; border: 1px solid #444;
        }
        .vs-cell { padding: 10px 5px; text-align: center; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; position: relative;}
        .vs-label-cell { background: #222; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; padding: 10px 2px; }
        .vs-header { grid-column: 1 / -1; background: #151515; padding: 10px; text-align: center; font-weight: bold; color: var(--highlight-gold); letter-spacing: 1px; border-bottom:1px solid #444; }
        .val-better { color: var(--accent-green); text-shadow: 0 0 5px rgba(46, 204, 113, 0.3); font-weight: bold; z-index: 1;}
        .val-worse { color: var(--accent-red); opacity: 0.7; font-size: 0.85rem; }
        .val-draw { color: var(--highlight-gold); opacity: 0.8; }
        
        /* Hall of Fame Record Box */
        .record-box {
            display: flex; align-items: center; background: var(--card-bg);
            border: 1px solid #3d3d3d; border-radius: 8px; padding: 8px 12px;
            cursor: pointer; transition: var(--transition);
        }
        .record-box:hover { background: #383838; border-color: var(--accent-green); }
        .record-icon { font-size: 1.8rem; margin-right: 12px; min-width: 40px; text-align: center; }
        .record-info { flex: 1; text-align: left; }
        .record-title { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; transition: color 0.2s; }
        .record-title:hover { color: var(--highlight-gold); text-decoration: underline; }
        .record-holder { font-size: 0.95rem; font-weight: bold; color: var(--highlight-gold); }
        .record-val { font-size: 0.85rem; color: #fff; margin-top: 2px; }

        /* --- ELO & BADGES --- */
        .elo-badge {
            background: #2c3e50; color: #fff; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8rem; border: 1px solid #444; cursor: pointer; margin-left: 5px;
            vertical-align: middle; transition: 0.2s; font-weight: bold;
        }
        .elo-badge:hover { background: var(--accent-blue); border-color: #fff; transform: scale(1.05); }

        /* --- Settings & Slots --- */
        .slot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .slot-card { background: var(--card-bg); padding: 10px; border-radius: 8px; border: 1px solid #444; text-align: center; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 6px; margin-top: 10px; }
        .theme-btn { padding: 10px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.75rem; border: 2px solid transparent; color: #fff; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .theme-btn:hover { transform: scale(1.05); z-index: 2; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .theme-btn.active { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; transition: 0.2s; }
        .btn-green { background: var(--accent-green); color: #000; }
        .btn-red { background: var(--accent-red); }
        .btn-grey { background: #555; }
        .btn-blue { background: var(--accent-blue); }
        .btn:hover { filter: brightness(1.1); }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; margin: 2px; }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            th, td { font-size: 0.75rem; padding: 6px 3px; }
            .modal-header h2 { font-size: 1rem; }
            .profile-tabs { flex-wrap: wrap; }
            .achievements-grid { grid-template-columns: repeat(5, 1fr); }
            .vs-container { flex-direction: column; gap:5px; }
            .vs-select { width: 100%; }
            .record-box { padding: 8px; }
            .record-icon { font-size: 1.4rem; margin-right: 8px; }
            .player-card-container { flex-direction: column; text-align: center; }
            .card-attrs { grid-template-columns: repeat(2, 1fr); width: 100%; }
            .card-ovr-box { width: 70px; height: 85px; }
            .card-ovr-val { font-size: 2rem; }
        }

/* --- VITRINE / SHOWCASE STYLES --- */
.vitrine-modal {
    background: radial-gradient(circle at center, #fdfdfd 0%, #e8e8e8 40%, #c0c0c0 100%);
    width: 100% !important; 
    height: 100% !important;
    max-width: 100vw !important; 
    max-height: 100vh !important;
    border: none !important;
    border-radius: 0 !important;
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    
    /* --- ZMENA TU: Zarovnanie hore namiesto stredu --- */
    justify-content: flex-start !important; 
    padding-top: 80px !important; /* Odstup od horného okraja (aby to nebolo pod tlačidlami) */
    /* ------------------------------------------------ */

    box-shadow: inset 0 0 100px rgba(0,0,0,0.1) !important;
}


            .vitrine-content {
                text-align: center;
                position: relative;
                z-index: 2;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .vitrine-img {
                max-height: 70vh;
                max-width: 90vw;
                filter: drop-shadow(0 30px 40px rgba(0,0,0,0.6));
                animation: floatTrophy 5s ease-in-out infinite;
                transition: transform 0.3s ease;
                cursor: zoom-in;
                margin-top: 50px;
            }

            .vitrine-img:hover {
                transform: scale(1.05);
            }

            /* --- UPRAVENÉ ŠTÝLY PRE VITRÍNU --- */
            
            /* Sezóna úplne hore */
            .vitrine-season-label {
                font-size: 0.6rem;
                text-transform: uppercase;
                letter-spacing: 2px;
                margin-bottom: 5px;
                font-weight: 600;
                opacity: 0.7;
            }

            /* Víťaz - teraz veľkým písmom pod sezónou */
            .vitrine-winner {
                font-size: 2.2rem; /* Zväčšené */
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: #b8860b;
                margin-bottom: 20px; /* Odstup od obrázka */
                line-height: 1;
                cursor: pointer;
                transition: transform 0.2s, color 0.2s;
                text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .vitrine-winner:hover {
                transform: scale(1.05); color: #d4af37;
            }

            /* Názov turnaja - teraz zas hore */
            .vitrine-title {
                margin-top: 20px;
                margin-bottom: 0;
                font-size: 1.5rem;
                color: #333;
                font-weight: 300;
                text-transform: uppercase;
                letter-spacing: 3px;
                text-shadow: 0 2px 4px rgba(255,255,255,0.8);
                font-family: 'Segoe UI', sans-serif;
                order: - 1;
            }


            .vitrine-close {
                position: absolute;
                top: 30px;
                right: 40px;
                font-size: 3rem;
                color: #555;
                background: none;
                border: none;
                cursor: pointer;
                transition: 0.2s;
                z-index: 10;
            }

            .vitrine-close:hover {
                color: #000;
                transform: scale(1.2) rotate(90deg);
            }

            .clickable-header {
                cursor: pointer;
                transition: color 0.2s;
                text-decoration: underline;
                text-decoration-style: dotted;
            }
            .clickable-header:hover {
                color: var(--highlight-gold);
            }
            
            /* Navigačné šípky pre Vitrínu */
            .vitrine-nav-btn {
                position: absolute; top: 50%; transform: translateY(-50%);
                background: rgba(0,0,0,0.1); color: #555; border: 1px solid rgba(0,0,0,0.1);
                font-size: 2.5rem; padding: 10px 20px; cursor: pointer;
                border-radius: 50%; transition: 0.3s; z-index: 20;
            }
            .vitrine-nav-btn:hover { background: rgba(0,0,0,0.8); color: #fff; border-color: #fff; }
            .v-prev { left: 40px; }
            .v-next { right: 40px; }

            @keyframes floatTrophy {
                0%, 100% { transform: translateY(0px) rotate(0deg); }
                50% { transform: translateY(-20px) rotate(0.5deg); }
            }

/* --- ŠTÝL PRE VEĽKÚ FOTKU HRÁČA (PHOTOSHOP STYLE) --- */
.vitrine-player-img {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    height: auto;
    max-height: 30vh; /* Fotka bude siahať max do polovice obrazovky */
    width: auto;
    max-width: 95vw;
    object-fit: contain;
    filter: drop-shadow(0 -5px 15px rgba(0,0,0,0.5));
    z-index: 1; /* Bude pod textom ak sa prekrývajú, pre popredie daj vyššie číslo */
    pointer-events: none;
}


/* --- VITRINE THEME MENU --- */
.vitrine-theme-wrapper {
    position: absolute;
    top: 30px;
    left: 40px;
    z-index: 100;
}

.vitrine-theme-btn {
    background: rgba(255, 255, 255, 0.3);
    border: 1px solid rgba(0, 0, 0, 0.1);
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    color: #333;
    font-size: 0.9rem;
    backdrop-filter: blur(5px);
    transition: 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
}

.vitrine-theme-btn:hover {
    background: rgba(255, 255, 255, 0.6);
    transform: scale(1.05);
}

.vitrine-theme-list {
    display: none;
    position: absolute;
    top: 45px;
    left: 0;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    width: 220px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    padding: 5px 0;
    text-align: left;
}

.vitrine-theme-list.show { display: block; animation: fadeIn 0.2s; }

.v-theme-item {
    padding: 8px 15px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #333;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.v-theme-item:last-child { border-bottom: none; }
.v-theme-item:hover { background: #f0f0f0; }

.v-preview-dot {
    width: 12px; height: 12px; border-radius: 50%;
    border: 1px solid #ccc; display: inline-block;
}

        /* --- ARCINEWS SYSTEM 2.0 --- */
        .news-modal-body { display: flex; flex-direction: column; height: 100%; padding: 0; overflow: hidden; }
        
        /* Top Navigation Bar */
        .news-nav-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #2c3e50; padding: 10px 15px; color: #fff; border-bottom: 2px solid #1a252f;
            flex-shrink: 0;
        }
        .news-date-display { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1rem; color: #f1c40f; }
        .news-controls { display: flex; gap: 10px; }
        
        /* Paper Switcher (Carousel) */
        .paper-switcher {
            display: flex; gap: 5px; overflow-x: auto; padding: 10px; background: #34495e;
            border-bottom: 1px solid #2c3e50; flex-shrink: 0;
        }
        .paper-tab {
            padding: 6px 12px; background: rgba(0,0,0,0.3); color: #ccc; border-radius: 4px;
            cursor: pointer; font-size: 0.8rem; white-space: nowrap; transition: 0.2s; border: 1px solid transparent;
        }
        .paper-tab:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .paper-tab.active { background: var(--accent-green); color: #000; font-weight: bold; border-color: #fff; }

        /* Main Content Area */
        .news-content-area { flex: 1; overflow-y: auto; padding: 0; position: relative; }

        /* Common List Styles */
        .news-list-container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .news-list-item { 
            margin-bottom: 15px; padding: 15px; cursor: pointer; position: relative;
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .news-list-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .news-tag { 
            font-size: 0.7rem; font-weight: bold; text-transform: uppercase; 
            padding: 3px 6px; display: inline-block; margin-bottom: 5px; color: #fff;
        }
        .fav-star {
            position: absolute; top: 10px; right: 10px; font-size: 1.5rem; color: #ccc; 
            cursor: pointer; transition: 0.2s; z-index: 5;
        }
        .fav-star:hover, .fav-star.active { color: #f1c40f; transform: scale(1.2); }

        /* --- THEMES (10 Druhov Novín) --- */
        
        /* 1. ArciNews (Classic) */
        .theme-arci { background-color: #f4f1ea; font-family: 'Georgia', serif; color: #1a1a1a; }
        .theme-arci .news-list-item { background: #fff; border: 1px solid #ccc; border-left: 5px solid #2c3e50; }
        .theme-arci .article-headline { font-family: 'Impact', sans-serif; }

        /* 2. The Golf Gazette (Elegant/Serif) */
        .theme-gazette { background-color: #fff; font-family: 'Times New Roman', serif; color: #000; }
        .theme-gazette .news-list-item { border-bottom: 2px solid #000; padding-left: 0; padding-right: 0; }
        .theme-gazette .news-header-title { font-family: 'Old English Text MT', serif; text-align: center; font-size: 3rem; border-bottom: 3px double #000; margin-bottom: 20px; }

        /* 3. Daily Divot (Tabloid) */
        .theme-divot { background-color: #ffe6e6; font-family: 'Arial', sans-serif; color: #a00; }
        .theme-divot .news-list-item { background: #ffcccc; border: 2px solid #a00; transform: rotate(-1deg); margin-bottom: 20px; }
        .theme-divot .news-list-item:nth-child(even) { transform: rotate(1deg); }
        .theme-divot .news-list-headline { font-weight: 900; text-transform: uppercase; font-style: italic; }

        /* 4. Green Jacket Journal (Premium) */
        .theme-green { background-color: #003300; font-family: 'Palatino Linotype', serif; color: #f1c40f; }
        .theme-green .news-list-item { background: #004d00; border: 1px solid #f1c40f; border-radius: 4px; }
        .theme-green .news-list-perex { color: #ccc; }

        /* 5. The Bunker (Dark Mode) */
        .theme-bunker { background-color: #121212; font-family: 'Roboto', sans-serif; color: #e0e0e0; }
        .theme-bunker .news-list-item { background: #1e1e1e; border-left: 4px solid #555; }
        .theme-bunker .news-list-headline { color: #fff; }

        /* 6. ClubHouse Social (App Style) */
        .theme-social { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; color: #333; }
        .theme-social .news-list-item { background: #fff; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; }
        .theme-social .news-header-title { font-size: 1.5rem; color: #1877f2; font-weight: bold; text-align: left; }

        /* 7. Fairway Insider (Minimalist) */
        .theme-insider { background-color: #fafafa; font-family: 'Helvetica Neue', sans-serif; color: #444; }
        .theme-insider .news-list-item { border-top: 1px solid #eee; padding: 20px 0; }
        .theme-insider .news-list-headline { font-weight: 300; font-size: 1.8rem; letter-spacing: -1px; color: #000; }

        /* 8. Eagle Eye (Tech/Neon) */
        .theme-tech { background-color: #050510; font-family: 'Courier New', monospace; color: #00ff00; }
        .theme-tech .news-list-item { border: 1px solid #00ff00; background: rgba(0, 255, 0, 0.05); }
        .theme-tech .news-list-headline { text-shadow: 0 0 5px #00ff00; }

        /* 9. Caddie's Diary (Paper/Handwritten) */
        .theme-diary { background-color: #fdf6e3; font-family: 'Comic Sans MS', cursive; color: #5d4037; }
        .theme-diary .news-list-item { border-bottom: 1px dashed #8d6e63; background: repeating-linear-gradient(#fdf6e3, #fdf6e3 24px, #e0f2f1 25px); line-height: 25px; }

        /* 10. The 19th Hole (Pub Style) */
        .theme-pub { background-color: #3e2723; font-family: 'Impact', sans-serif; color: #ffecb3; background-image: radial-gradient(#4e342e 15%, transparent 16%); background-size: 20px 20px;}
        .theme-pub .news-list-item { background: #5d4037; border: 4px solid #8d6e63; border-radius: 2px; box-shadow: 5px 5px 0 #271c19; }
        
        /* Article Full View Overrides */
        .article-full-content { max-width: 800px; margin: 0 auto; padding: 40px; background: inherit; min-height: 100%; }




        #fileInput, #slotFileInput, #seasonFileInput { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <h1>ArciWeb - PGA StatsKeeper <span class="version">v5.21</span></h1>
            <div class="header-ranks">
                <span class="header-rank-link" style="color:var(--highlight-gold)" onclick="showRankTable('PGA')">PGA Rank</span>
                <span class="header-rank-link" style="color:var(--accent-blue)" onclick="showRankTable('Official')">Official Rank</span>
                <span class="header-rank-link" style="color:var(--accent-red)" onclick="showRankTable('Tour')">Tour Rank</span>
                <span class="header-rank-link" style="color:var(--accent-red)" onclick="showRankTable('EA')">EA Rank</span>
                <span class="header-rank-link" style="color:var(--accent-red)" onclick="showRankTable('Association')">Association Rank</span>
                <span class="header-rank-link" style="color:var(--highlight-gold)" onclick="showRankTable('FEDEX')">FED EX Rank</span>
                <span class="header-rank-link" style="color:#2c3e50; background:#fff; padding:0 4px; border-radius:3px;" onclick="showRankTable('ELO')">ELO Rank</span>
                <span class="header-rank-link amateur-rank" onclick="showRankTable('Amateur')">Amateur Rank</span>
            </div>
        </div>
        <div class="header-icons">
            <button class="icon-btn" onclick="showGlobalPlayerCards()" title="Rebríček Hráčov (Cards)">🃏</button>
            <button class="icon-btn" onclick="openGlobalAchievementsList()" title="Zoznam Achievementov">🏅</button>
            <button class="icon-btn" onclick="openHallOfFame()" title="Sieň slávy">🏆</button>
            <button class="icon-btn" onclick="openComparator()" title="Porovnávač (Head-to-Head)">🆚</button>
            <button class="icon-btn" onclick="openArciNews()" title="ArciNews">📰</button>
            <button class="icon-btn" onclick="openTrophyGallery()" title="Galéria Trofejí (Všetky)">🖼️</button>
            <button class="icon-btn" onclick="openSettings()" title="Nastavenia">&#9881;</button>
        </div>
    </header>

    <div class="search-container">
        <input type="text" id="playerSearch" placeholder="Vyhľadať hráča..." oninput="handleSearch(this.value)">
        <div id="searchResults"></div>
    </div>

    <div id="filterContainer">
        <div class="filter-section">
            <span class="filter-label">Tour</span>
            <div class="filter-row">
                <button class="filter-btn active" id="btn-tour-all" onclick="setTourFilter('ALL')">Všetky</button>
                <button class="filter-btn" id="btn-tour-KFT" onclick="setTourFilter('KFT')">KFT</button>
                <button class="filter-btn" id="btn-tour-PGA" onclick="setTourFilter('PGA')">PGA</button>
                <button class="filter-btn" id="btn-tour-EA SPORTS" onclick="setTourFilter('EA SPORTS')">EA Sports</button>
                <button class="filter-btn" id="btn-tour-THE PLAYERS" onclick="setTourFilter('THE PLAYERS')">The Players</button>
                <button class="filter-btn" id="btn-tour-FED EX" onclick="setTourFilter('FED EX')">FED EX</button>
            </div>
        </div>

        <div class="filter-section">
            <span class="filter-label">Dôležitosť</span>
            <div class="dropdown-filter" onclick="toggleImportanceDropdown()">
                <span id="importanceFilterLabel">Všetky</span>
                <span style="float:right">▼</span>
            </div>
            <div id="importanceDropdown" class="dropdown-content">
                </div>
        </div>

        <div class="filter-section">
            <span class="filter-label">Sezóna</span>
            <div class="dropdown-filter" onclick="toggleSeasonDropdown()">
                <span id="seasonFilterLabel">Všetky</span>
                <span style="float:right">▼</span>
            </div>
            <div id="seasonDropdown" class="dropdown-content">
                </div>
        </div>

        <div class="filter-section">
             <span class="filter-label">Turnaje</span>
             <div class="dropdown-filter" onclick="toggleEventDropdown()">
                 <span id="eventFilterLabel">Všetky turnaje</span>
                 <span style="float:right">▼</span>
             </div>
             <div id="eventDropdown" class="dropdown-content">
                 </div>
        </div>
        
        <div class="filter-section">
             <button class="filter-btn btn-full-width" id="weekToggleBtn" onclick="toggleWeekView()">Zobraziť konkrétne týždne (Súbory)</button>
             <div id="weeksContainer" class="filter-row" style="display:none; margin-top:10px;"></div>
        </div>
    </div>

    <div class="table-container">
        <table id="mainTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
    <input type="file" id="fileInput" accept=".txt" multiple onchange="handleFiles(this.files)">
    <input type="file" id="slotFileInput" accept=".json" onchange="finishSlotUpload(this.files)">
    <input type="file" id="seasonFileInput" accept=".txt" multiple onchange="handleSeasonFiles(this.files)">
    
    <div id="popupsLayer"></div>
<script>
    const colorSchemes = {
        'Gold': { bg: '#000000', card: '#1c1c1c', text: '#ffd700', accent: '#ffec8b' },
        'Silver': { bg: '#2c3e50', card: '#bdc3c7', text: '#2c3e50', accent: '#ecf0f1' },
        'Bronze': { bg: '#1a120b', card: '#302113', text: '#e8dace', accent: '#cd7f32' },
        'Copper': { bg: '#261109', card: '#421d0f', text: '#ffe0d6', accent: '#b87333' },
        'Platinum': { bg: '#1a1a1a', card: '#333333', text: '#e5e4e2', accent: '#00bfff' },
        'Titanium': { bg: '#1c1c20', card: '#2b2b30', text: '#dcdcdc', accent: '#708090' },
        'Carbon': { bg: '#0d0d0d', card: '#1a1a1a', text: '#cccccc', accent: '#d32f2f' },
        'Steel': { bg: '#191f26', card: '#2c3642', text: '#dfe4ea', accent: '#70a1ff' },
        'RoseGold': { bg: '#29181b', card: '#42242b', text: '#ffc2cd', accent: '#b76e79' },
        'Onyx': { bg: '#050505', card: '#141414', text: '#ffffff', accent: '#7f8c8d' },
        'Diamond': { bg: '#0f151c', card: '#1a2633', text: '#b9f2ff', accent: '#00ffff' },
        'Sun': { bg: '#ffcc00', card: '#ffe066', text: '#000000', accent: '#d35400' },
        'Bumblebee': { bg: '#1a1a00', card: '#333300', text: '#ffff00', accent: '#ffffff' },
        'Banana': { bg: '#2e2e00', card: '#4a4a00', text: '#ffffe0', accent: '#ffe135' },
        'Lemon': { bg: '#1a1a00', card: '#333300', text: '#ffffe6', accent: '#fff700' },
        'GoldRush': { bg: '#1a1200', card: '#332400', text: '#ffebcd', accent: '#daa520' },
        'Orange': { bg: '#331400', card: '#662900', text: '#fff0e6', accent: '#ffa500' },
        'Tangerine': { bg: '#e65100', card: '#ff833a', text: '#000000', accent: '#ffe0b2' },
        'Tiger': { bg: '#1a0d00', card: '#331a00', text: '#ff9900', accent: '#ffcc00' },
        'Amber': { bg: '#2b1d00', card: '#4d3300', text: '#ffbf00', accent: '#ffdb4d' },
        'Halloween': { bg: '#1a0500', card: '#2b0e00', text: '#ff6600', accent: '#993300' },
        'Apricot': { bg: '#2b1608', card: '#4a260e', text: '#ffccb3', accent: '#fbceb1' },
        'Ferrari': { bg: '#330000', card: '#cc0000', text: '#ffffff', accent: '#ffff00' },
        'Lava': { bg: '#1a0500', card: '#330a00', text: '#ffebd9', accent: '#ff4500' },
        'Ruby': { bg: '#2b0000', card: '#520000', text: '#ffe6e6', accent: '#e0115f' },
        'Crimson': { bg: '#330000', card: '#4d0000', text: '#ffcccc', accent: '#dc143c' },
        'Cherry': { bg: '#2b0000', card: '#420000', text: '#ffcccc', accent: '#ff4d4d' },
        'Brick': { bg: '#2b1100', card: '#4d1f00', text: '#ffcc99', accent: '#b22222' },
        'Wine': { bg: '#1a000d', card: '#33001a', text: '#e6ccff', accent: '#722f37' },
        'Blood': { bg: '#1a0000', card: '#330000', text: '#ff0000', accent: '#800000' },
        'Mars': { bg: '#2b0a05', card: '#4a1209', text: '#ffcccb', accent: '#bc2732' },
        'Inferno': { bg: '#140500', card: '#290a00', text: '#ff4500', accent: '#ffa500' },
        'Volcanic': { bg: '#120505', card: '#260a0a', text: '#ffdddd', accent: '#ff3333' },
        'Magenta': { bg: '#1a001a', card: '#330033', text: '#ff00ff', accent: '#ff00ff' },
        'Amethyst': { bg: '#1a001a', card: '#330033', text: '#f2e6ff', accent: '#9966cc' },
        'Velvet': { bg: '#1a001a', card: '#2e002e', text: '#ffccff', accent: '#800080' },
        'Indigo': { bg: '#0f001a', card: '#1f0033', text: '#e6ccff', accent: '#4b0082' },
        'Plum': { bg: '#1a051a', card: '#2e0a2e', text: '#ffe6ff', accent: '#dda0dd' },
        'HotPink': { bg: '#1a000d', card: '#33001a', text: '#ffe6f2', accent: '#ff69b4' },
        'Bubblegum': { bg: '#1f0a14', card: '#3d1428', text: '#ffe6f7', accent: '#ffadd6' },
        'Orchid': { bg: '#1a0d1a', card: '#2e1a2e', text: '#f2e6ff', accent: '#da70d6' },
        'Grape': { bg: '#12001a', card: '#240033', text: '#f3e6ff', accent: '#800080' },
        'Lavender': { bg: '#201a23', card: '#2e2532', text: '#ffffff', accent: '#a663cc' },
        'Barbie': { bg: '#330019', card: '#660033', text: '#ffccdd', accent: '#e0218a' },
        'Electric': { bg: '#00001a', card: '#000033', text: '#ffffff', accent: '#00ffff' },
        'Ocean': { bg: '#001f3f', card: '#003366', text: '#7FDBFF', accent: '#39CCCC' },
        'Sapphire': { bg: '#00002b', card: '#000052', text: '#e6e6ff', accent: '#0f52ba' },
        'Sky': { bg: '#00264d', card: '#004080', text: '#e6f2ff', accent: '#3399ff' },
        'Cobalt': { bg: '#001a33', card: '#003366', text: '#ffffff', accent: '#0047ab' },
        'Frozen': { bg: '#0c1b29', card: '#152d42', text: '#d0efff', accent: '#00a8ff' },
        'DeepSea': { bg: '#001a23', card: '#00303d', text: '#e0f7fa', accent: '#00bcd4' },
        'Midnight': { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9', accent: '#38bdf8' },
        'Azure': { bg: '#003333', card: '#006666', text: '#e0ffff', accent: '#00ffff' },
        'Blueprint': { bg: '#001a33', card: '#003366', text: '#ffffff', accent: '#4da6ff' },
        'Navy': { bg: '#00001a', card: '#000040', text: '#ccccff', accent: '#000080' },
        'Toxic': { bg: '#0d1f0d', card: '#1a3d1a', text: '#ccffcc', accent: '#adff2f' },
        'Matrix': { bg: '#000000', card: '#0a140a', text: '#00ff00', accent: '#00cc00' },
        'Emerald': { bg: '#00260e', card: '#004d1c', text: '#e6ffe6', accent: '#50c878' },
        'Lime': { bg: '#0d1a00', card: '#1a3300', text: '#f2ffe6', accent: '#32cd32' },
        'Forest': { bg: '#1a2f1a', card: '#2f4f2f', text: '#dbebdb', accent: '#90ee90' },
        'Mint': { bg: '#182f2a', card: '#254a43', text: '#e0f2f1', accent: '#00b894' },
        'Jungle': { bg: '#0a1a0a', card: '#143314', text: '#d9f2d9', accent: '#228b22' },
        'Olive': { bg: '#1a1a00', card: '#333300', text: '#ffffcc', accent: '#808000' },
        'Alien': { bg: '#051405', card: '#0f290f', text: '#39ff14', accent: '#00ff00' },
        'Cactus': { bg: '#0f1a0f', card: '#1f331f', text: '#e0f2e0', accent: '#5f9ea0' },
        'Grass': { bg: '#001a00', card: '#003300', text: '#ccffcc', accent: '#008000' },
        'Cyberpunk': { bg: '#050505', card: '#121212', text: '#fcee0a', accent: '#00fff5' },
        'Synthwave': { bg: '#1a0b2e', card: '#2b1055', text: '#fff', accent: '#ff007f' },
        'NeonPink': { bg: '#1a0011', card: '#330022', text: '#ff0080', accent: '#ff1493' },
        'NeonBlue': { bg: '#000a1a', card: '#001f4d', text: '#00ccff', accent: '#00ffff' },
        'NeonGreen': { bg: '#001a05', card: '#00330a', text: '#39ff14', accent: '#00ff00' },
        'Laser': { bg: '#0a0a0a', card: '#1f1f1f', text: '#ffffff', accent: '#ff3333' },
        'Arcade': { bg: '#140014', card: '#290029', text: '#00ffcc', accent: '#ff00ff' },
        'Glitch': { bg: '#0d0d0d', card: '#1a1a1a', text: '#00ff00', accent: '#ff0000' },
        'Plasma': { bg: '#12001a', card: '#240033', text: '#e0ccff', accent: '#9933ff' },
        'Tron': { bg: '#00111a', card: '#002233', text: '#ccf2ff', accent: '#00eeee' },
        'Miami': { bg: '#001a1a', card: '#003333', text: '#ff66b2', accent: '#00cccc' },
        'Berry': { bg: '#1a001a', card: '#33001a', text: '#ffe6ff', accent: '#cc00cc' },
        'Kiwi': { bg: '#111a00', card: '#223300', text: '#eeffee', accent: '#8ee53f' },
        'Watermelon': { bg: '#001a0d', card: '#00331a', text: '#ffcccc', accent: '#ff6b6b' },
        'DragonFruit': { bg: '#1a0011', card: '#330022', text: '#ffffff', accent: '#ff0055' },
        'Peach': { bg: '#331a00', card: '#663300', text: '#ffe0b2', accent: '#ff9800' },
        'Blueberry': { bg: '#00001a', card: '#000033', text: '#ccccff', accent: '#4682b4' },
        'Candy': { bg: '#2c001e', card: '#4a0033', text: '#ffd1dc', accent: '#ff69b4' },
        'Chocolate': { bg: '#1f1a17', card: '#362f2b', text: '#e6dace', accent: '#d2691e' },
        'Coffee': { bg: '#1a110d', card: '#33221a', text: '#dcc6ba', accent: '#8b4513' },
        'MintChoco': { bg: '#0a1a15', card: '#152b22', text: '#d9f2e6', accent: '#3eb489' },
        'Rainbow': { bg: '#1a1a1a', card: '#2d2d2d', text: '#ffffff', accent: '#ff0000', border: '#00ff00' },
        'Default': { bg: '#1e1e1e', card: '#2d2d2d', text: '#ffffff', accent: '#2ecc71' },
        'NightMode': { bg: '#050505', card: '#0f0f0f', text: '#cccccc', accent: '#444444' },
        'Abyss': { bg: '#020202', card: '#0a0a0a', text: '#555555', accent: '#333333' },
        'Shadow': { bg: '#121212', card: '#1f1f1f', text: '#a0a0a0', accent: '#606060' },
        'Obsidian': { bg: '#141414', card: '#202020', text: '#e0e0e0', accent: '#6c5ce7' },
        'Slate': { bg: '#272b33', card: '#3b404d', text: '#ffffff', accent: '#d08770' },
        'Gothic': { bg: '#0d0d0d', card: '#1a1a1a', text: '#888888', accent: '#440000' },
        'Storm': { bg: '#12121a', card: '#242433', text: '#e6e6fa', accent: '#483d8b' },
        'Vampire': { bg: '#0a0000', card: '#1a0000', text: '#ff9999', accent: '#ff0000' },
        'Ninja': { bg: '#111111', card: '#222222', text: '#33ff33', accent: '#000000' },
        'Retro': { bg: '#2c3e50', card: '#34495e', text: '#ecf0f1', accent: '#e67e22' }
    };

// --- DEFINÍCIA 20 TÉM PRE VITRÍNU ---
const vitrineThemes = {
    'Clean White': { bg: 'radial-gradient(circle at center, #fdfdfd 0%, #e8e8e8 40%, #c0c0c0 100%)', text: '#333' },
    '10-11-12-13': { bg: 'radial-gradient(circle at center, #2c3e50 0%, #000000 100%)', text: '#fff' },
    '23': { bg: 'radial-gradient(circle at center, #f1c40f 0%, #b8860b 100%)', text: '#000' },
    '20': { bg: 'linear-gradient(to top, #30cfd0 0%, #330867 100%)', text: '#fff' },
    '15-19-22-25': { bg: 'linear-gradient(to top, #0ba360 0%, #3cba92 100%)', text: '#fff' },
    '40-41-42': { bg: 'linear-gradient(to right, #ff8177 0%, #ff867a 0%, #ff8c7f 21%, #f99185 52%, #cf556c 78%, #b12a5b 100%)', text: '#fff' },
    '17-21-28-37-39': { bg: 'linear-gradient(to top, #6a11cb 0%, #2575fc 100%)', text: '#fff' },
    '38': { bg: 'radial-gradient(circle at center, #434343 0%, #000000 100%)', text: '#fff' },
    '24-27': { bg: 'linear-gradient(to right, #ed213a, #93291e)', text: '#fff' },
    '33': { bg: 'linear-gradient(to top, #d7d2cc 0%, #304352 100%)', text: '#fff' },
    '18': { bg: 'linear-gradient(to right, #00f260, #0575e6)', text: '#fff' },
    '14-16': { bg: 'linear-gradient(to top, #fad0c4 0%, #ffd1ff 100%)', text: '#333' },
    '05-06-07': { bg: 'linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)', text: '#333' },
    '26': { bg: 'linear-gradient(to top, #e6b980 0%, #eacda3 100%)', text: '#333' },
    '43-44': { bg: 'radial-gradient(circle at center, #0f9b0f 0%, #000000 100%)', text: '#fff' },
    '45': { bg: 'linear-gradient(to top, #000000 0%, #434343 100%)', text: '#e0e0e0' },
    '30-31-32-34-35-36': { bg: 'linear-gradient(to right, #636363, #a2ab58)', text: '#fff' },
    '08-09': { bg: 'linear-gradient(to top, #e6e9f0 0%, #eef1f5 100%)', text: '#333' },
    '01-02-03-04': { bg: 'linear-gradient(to top, #accbee 0%, #e7f0fd 100%)', text: '#333' },
    '29': { bg: 'linear-gradient(to right, #ff4b1f, #ff9068)', text: '#fff' }
};

    const achievementsDef = [
        // ... (tvoje pôvodné achievementy nechaj tu) ...
        { id: 'shark', icon: '🦈', name: 'Shark', desc: '3 a viac výhier.', cat: 'wins' },
        { id: 'dominator', icon: '👑', name: 'Dominator', desc: '10 a viac výhier.', cat: 'wins' },
        { id: 'goat', icon: '🐐', name: 'GOAT', desc: '20 a viac výhier.', cat: 'wins' },
        { id: 'imp_man', icon: '⭐', name: 'Important Man', desc: 'Výhra v Dôležitom (!) turnaji.', cat: 'wins' },
        { id: 'maj_man', icon: '🎖️', name: 'Major Man', desc: 'Výhra vo Významnom (=) turnaji.', cat: 'wins' },
        { id: 'maj_champ', icon: '🏆', name: 'Major Champ', desc: 'Výhra v Dôležitom (!) aj Významnom (=) turnaji.', cat: 'wins' },
        { id: 'trophy_hunt', icon: '🪙', name: 'Trophy Hunter', desc: 'Získal FED EX trofej.', cat: 'wins' },
        { id: 'pga_king', icon: '⛳', name: 'PGA King', desc: 'Vyhral 5 PGA turnajov.', cat: 'wins' },
        { id: 'ea_game', icon: '🎮', name: "It is in the Game", desc: 'Vyhral EA Sports turnaj.', cat: 'wins' },
        { id: 'poty', icon: '🕺', name: 'Player of the Year', desc: 'Vyhral Players Turnaj.', cat: 'wins' },
        { id: 'world_1', icon: '🌍', name: 'World No.1', desc: 'Hráč dosiahol 1. miesto v Official Rankingu.', cat: 'wins' },
        { id: 'master_all', icon: '🪐', name: 'Master of Everything', desc: 'Vyhral PGA, EA, Players aj FED EX turnaj.', cat: 'wins' },
        { id: 'us_champ', icon: '🗽', name: 'US Champ', desc: 'Vyhral turnaj s názvom US Open!', cat: 'wins' },
        { id: 'opener', icon: '🕰️', name: 'Opener', desc: 'Vyhral turnaj s názvom The Open!', cat: 'wins' },
        { id: 'defender', icon: '🛡️', name: 'Trophy Defender', desc: 'Vyhral dva turnaje po sebe.', cat: 'wins' },
        { id: 'champion', icon: '🏅', name: 'Champion', desc: '15+ výhier a titul FED EX.', cat: 'wins' },
        { id: 'high_roller', icon: '💰', name: 'High Roller', desc: 'Celkový zisk viac ako 5 000 bodov.', cat: 'points' },
        { id: 'tycoon', icon: '🏦', name: 'Tycoon', desc: 'Celkový zisk viac ako 10 000 bodov.', cat: 'points' },
        { id: 'legend', icon: '🧞', name: 'Legend', desc: 'Viac ako 20 000 bodov a aspoň 10 vyhranych turnajov.', cat: 'points' },
        { id: 'veteran', icon: '🎖️', name: 'Veteran', desc: 'Odohraných 50+ turnajov.', cat: 'stamina' },
        { id: 'iron_man', icon: '🤖', name: 'Iron Man', desc: 'Odohraných 100+ turnajov.', cat: 'stamina' },
        { id: 'immortal', icon: '🧛', name: 'Immortal', desc: 'Odohraných 200+ turnajov.', cat: 'stamina' },
        { id: 'marathon', icon: '🏃', name: 'Marathon', desc: 'Odohraných viac ako 5000 jamiek.', cat: 'stamina' },
        { id: 'iron_hand', icon: '🦾', name: 'Iron Hand', desc: 'Odohraných viac ako 20 000 jamiek.', cat: 'stamina' },
        { id: 'sniper', icon: '🎯', name: 'Sniper', desc: 'Aspoň 1 Ace (Hole-in-one).', cat: 'aim' },
        { id: 'eagle_eye', icon: '🦅', name: 'Eagle Eye', desc: '20 a viac Eagles.', cat: 'aim' },
        { id: 'albatross', icon: '🐦‍🔥', name: 'Albatross', desc: 'Aspoň 1 Double Eagle.', cat: 'aim' },
        { id: 'birdie_mach', icon: '🐦', name: 'Birdie Machine', desc: '100 a viac Birdies.', cat: 'aim' },
        { id: 'birdie_king', icon: '🦜', name: 'Birdie King', desc: '200 a viac Birdies.', cat: 'aim' },
        { id: 'par_master', icon: '⚖️', name: 'Par Master', desc: '1000 a viac Parov.', cat: 'aim' },
        { id: 'elite', icon: '🎩', name: 'Elite', desc: 'Top 5 aspoň 10-krát.', cat: 'consist' },
        { id: 'podium', icon: '🥉', name: 'Podium', desc: 'Top 5 aspoň 20-krát.', cat: 'consist' },
        { id: 'consistency', icon: '📉', name: 'Consistency', desc: 'Top 20 aspoň 30-krát.', cat: 'consist' },
        { id: 'top10_reg', icon: '📊', name: 'Top 10 Reg', desc: 'Top 20 aspoň 50-krát.', cat: 'consist' },
        { id: 'cut_master', icon: '✂️', name: 'Cut Master', desc: 'Prešiel cez CUT aspoň 50-krát.', cat: 'consist' },
        { id: 'survivor', icon: '🏝️', name: 'Survivor', desc: 'Prešiel cez CUT aspoň 100-krát.', cat: 'consist' },
        { id: 'sub62', icon: '🔥', name: 'Sub-62 Club', desc: 'Zahral kolo pod 62 rán.', cat: 'special' },
        { id: 'scratch', icon: '🏌️', name: 'Scratch', desc: 'Celkový priemer úderov pod 69.9.', cat: 'special' },
        { id: 'safe_play', icon: '🛡️', name: 'Safe Player', desc: 'Počet Parov je viac ako dvadsatnásobok Bogeys.', cat: 'special' },
        { id: 'aggressive', icon: '⚔️', name: 'Aggressive', desc: 'Počet Birdies je vyšší ako počet Parov.', cat: 'special' },
        { id: 'player_badge', icon: '🧢', name: 'Player', desc: 'Zúčastnil sa turnaja Players.', cat: 'special' },
        { id: 'under_par', icon: '📉', name: 'Deep Under Par', desc: 'Hráč má celkové skóre Par menej ako - 50.', cat: 'special' },
        { id: 'solid', icon: '🧱', name: 'Solid', desc: 'Priemer úderov menší ako 3.90.', cat: 'special' },
        { id: 'never_back', icon: '💪', name: 'Never Back Down', desc: 'R1 >= 80, ale aj tak prešiel CUT.', cat: 'special' },
        { id: 'lucky7', icon: '🍀', name: 'Lucky 7', desc: '7 Achievementov + 7x Top 5.', cat: 'special' },
        
        // --- NOVÝCH 40 ACHIEVEMENTOV ---
        
        // KFT & Specialized Wins
        { id: 'ea_grad', icon: '🎓', name: 'EA Graduate', desc: 'Vyhral aspoň 2 turnaje na EA Tour.', cat: 'wins' },
        { id: 'ea_legend', icon: '🚜', name: 'EA Legend', desc: 'Vyhral 3 a viac turnajov na EA Tour.', cat: 'wins' },
        { id: 'grand_slam', icon: '🌍', name: 'Global Conqueror', desc: 'Vyhral na PGA, FED Ex aj EA Sports Tour.', cat: 'wins' },
        { id: 'silver_col', icon: '🥈', name: 'Silver Collector', desc: 'Získal 5x druhé miesto.', cat: 'wins' },
        { id: 'bronze_col', icon: '🥉', name: 'Bronze Medalist', desc: 'Získal 5x tretie miesto.', cat: 'wins' },
        
        // Rounds & Scoring
        { id: 'mr_59', icon: '👽', name: 'Mr. 59', desc: 'Zahral magické kolo pod 60 rán.', cat: 'special' },
        { id: 'club_65', icon: '🔥', name: 'Club 65', desc: 'Zahral 10 kôl pod 65 rán.', cat: 'special' },
        { id: 'sunday_roaring', icon: '🦁', name: 'Sunday Roar', desc: 'Priemer 4. kola je lepší ako 68.0.', cat: 'special' },
        { id: 'fast_starter', icon: '🚀', name: 'Fast Starter', desc: 'Priemer 1. kola je lepší ako 68.0.', cat: 'special' },
        { id: 'comeback_king', icon: '🆙', name: 'Comeback King', desc: 'Priemer 4. kola je aspoň o 2 rany lepší ako priemer 1. kola.', cat: 'special' },
        
        // Streaks & Consistency
        { id: 'heating_up', icon: '🌡️', name: 'Heating Up', desc: '3x Top 10 v rade za sebou.', cat: 'consist' },
        { id: 'on_fire', icon: '🔥', name: 'On Fire', desc: '5x Top 10 v rade za sebou.', cat: 'consist' },
        { id: 'cut_streak', icon: '🧱', name: 'Brick Wall', desc: 'Prešiel cez CUT 10-krát v rade.', cat: 'consist' },
        { id: 'invincible', icon: '🛡️', name: 'Invincible', desc: 'Prešiel cez CUT 20-krát v rade.', cat: 'consist' },
        { id: 'top_percent', icon: '📊', name: 'Top Tier', desc: 'Viac ako 40% účastí skončilo v Top 5 (min. 10 turnajov).', cat: 'consist' },
        
        // Volume & Season Stats
        { id: 'birdie_god', icon: '⚡', name: 'Birdie God', desc: '500 a viac Birdies.', cat: 'aim' },
        { id: 'eagle_nest', icon: '🦅', name: 'Eagle Nest', desc: '10 a viac Eagles v jednej sezóne.', cat: 'aim' },
        { id: 'par_hoarder', icon: '📦', name: 'Par Hoarder', desc: '2000 a viac Parov celkovo.', cat: 'aim' },
        { id: 'sniper_elite', icon: '🎯', name: 'Sniper Elite', desc: '3 a viac Hole-in-One celkovo.', cat: 'aim' },
        { id: 'clean_sheet', icon: '🧼', name: 'Clean Sheet', desc: 'Počet Birdies je vyšší ako počet Bogeys.', cat: 'special' },
        
        // Points & Career
        { id: 'pts_millionaire', icon: '💎', name: 'Points Millionaire', desc: 'Celkový zisk viac ako 50 000 bodov.', cat: 'points' },
        { id: 'efficiency', icon: '📈', name: 'Efficiency', desc: 'Priemer bodov na turnaj vyšší ako 100 (min. 10 turnajov).', cat: 'points' },
        { id: 'journeyman', icon: '🧳', name: 'Journeyman', desc: 'Odohraných 50 turnajov bez jedinej výhry.', cat: 'stamina' },
        { id: 'one_hit', icon: '🎵', name: 'One Hit Wonder', desc: 'Presne 1 výhra pri 50+ odohraných turnajoch.', cat: 'wins' },
        { id: 'grinder', icon: '⚙️', name: 'The Grinder', desc: 'Viac ako 3000 Parov.', cat: 'aim' },
        
        // Specific Situations
        { id: 'risk_taker', icon: '🎲', name: 'Risk Taker', desc: 'Počet Eagles je vyšší ako počet Double Bogeys.', cat: 'special' },
        { id: 'glass_chin', icon: '📉', name: 'Glass Chin', desc: 'Priemer 1. kola je o 2 rany lepší ako priemer 4. kola.', cat: 'special' },
        { id: 'weekend_warrior', icon: '🍺', name: 'Weekend Warrior', desc: 'Prešiel cez CUT, ale skončil horšie ako 60. miesto (min. 5x).', cat: 'special' },
        { id: 'bridesmaid', icon: '💍', name: 'Always Bridesmaid', desc: '10x Top 3 bez výhry.', cat: 'wins' },
        { id: 'major_top10', icon: '🌟', name: 'Big Stage Player', desc: '5x Top 10 na Major/Important turnajoch.', cat: 'consist' },
        
        // Hardcore / Elite
        { id: 'club_63', icon: '🧨', name: 'Club 63', desc: 'Zahral 5 kôl pod 63 rán.', cat: 'special' },
        { id: 'mr_consistent', icon: '📏', name: 'Mr. Consistent', desc: 'Priemerné umiestnenie lepšie ako 15.0 (min. 20 turnajov).', cat: 'consist' },
        { id: 'the_1_percent', icon: '👑', name: 'The 1%', desc: 'Súčasne drží: Official #1, Win na Players a Win na FedEx.', cat: 'wins' },
        { id: 'grand_finish', icon: '🏁', name: 'Grand Finish', desc: 'Zahral 4. kolo pod 62 rán.', cat: 'special' },
        { id: 'no_bogeys', icon: '🛡️', name: 'No Mistakes', desc: 'Pomer Par/Bogey je väčší ako 30.', cat: 'special' },
        { id: 'perfect_weekend', icon: '📅', name: 'Perfect Weekend', desc: 'Súčet R3 + R4 je menej ako 128 (priemer 64).', cat: 'special' },
        { id: 'fedex_regular', icon: '📦', name: 'FedEx Regular', desc: 'Zúčastnil sa aspoň 3 FedEx Playoff turnajov.', cat: 'stamina' },
        { id: 'scrambler', icon: '🍳', name: 'Scrambler', desc: 'Málo Parov (<500), ale veľa Birdies (>200).', cat: 'special' },
        { id: 'top50_machine', icon: '🤖', name: 'Top 50 Machine', desc: 'Skončil v Top 50 aspoň 80-krát.', cat: 'consist' },
        { id: 'lucky_number', icon: '🎰', name: 'Jackpot', desc: 'Získal presne 777 bodov (alebo viac) v jednom turnaji.', cat: 'points' }
    ];


    const recordsDef = [
        { id: 'most_wins', name: 'Najviac Výhier', desc: 'Celkový počet víťazstiev vo všetkých turnajoch.', icon: '🥇', format: (v) => `${v}x` },
        { id: 'most_points', name: 'Najviac Bodov', desc: 'Celkový počet získaných bodov v kariére.', icon: '💰', format: (v) => v.toFixed(0) },
        { id: 'iron_man', name: 'Iron Man (Turnaje)', desc: 'Najväčší počet odohraných turnajov.', icon: '🤖', format: (v) => `${v}` },
        { id: 'lowest_rnd', name: 'Najnižšie Kolo', desc: 'Najnižšie zahrané skóre v jednom kole (18 jamiek).', icon: '🔥', format: (v) => v },
        { id: 'avg_strokes', name: 'Priemer Úderov', desc: 'Celkový priemer úderov na jedno kolo (min. 5 turnajov).', icon: '🎯', format: (v) => v.toFixed(2) },
        { id: 'most_cuts', name: 'Cut Master', desc: 'Počet turnajov, v ktorých hráč prešiel cutom (získal body).', icon: '🛡️', format: (v) => `${v}x` },
        { id: 'most_top20', name: 'Top 20 Machine', desc: 'Počet umiestnení v najlepšej dvadsiatke.', icon: '💎', format: (v) => `${v}x` },
        { id: 'top10_machine', name: 'Top 10 Elite', desc: 'Počet umiestnení v najlepšej desiatke.', icon: '🌟', format: (v) => `${v}x` },
        { id: 'podium', name: 'Podium Finisher', desc: 'Počet umiestnení na stupni víťazov (Top 3).', icon: '🥉', format: (v) => `${v}x` },
        { id: 'birdie_king', name: 'Birdie King (Sezóna)', desc: 'Najviac Birdies v jednej sezóne (vyžaduje sezónne štatistiky).', icon: '🐦', format: (v) => `${v}` },
        { id: 'sniper', name: 'Sniper (Aces)', desc: 'Celkový počet Hole-in-One (vyžaduje sezónne štatistiky).', icon: '⛳', format: (v) => `${v}` },
        { id: 'eagle_master', name: 'Eagle Master', desc: 'Celkový počet Eagles v sezóne.', icon: '🦅', format: (v) => v },
        { id: 'par_machine', name: 'Par Machine', desc: 'Najviac Parov v jednej sezóne.', icon: '⚖️', format: (v) => v },
        { id: 'mr_saturday', name: 'Mr. Saturday', desc: 'Najlepší priemer skóre v 3. kole (Moving Day).', icon: '📅', format: (v) => v.toFixed(2) },
        { id: 'mr_sunday', name: 'Mr. Sunday', desc: 'Najlepší priemer skóre vo finálovom 4. kole.', icon: '🏆', format: (v) => v.toFixed(2) },
        { id: 'slow_starter', name: 'Slow Starter', desc: 'Najhorší priemer skóre v 1. kole.', icon: '🐢', format: (v) => v.toFixed(2) },
        { id: 'fast_starter', name: 'Rocket Start', desc: 'Najlepší priemer skóre v 1. kole.', icon: '🚀', format: (v) => v.toFixed(2) },
        { id: 'glass_chin', name: 'Glass Chin', desc: 'Najhoršie zahrané 4. kolo v kariére.', icon: '📉', format: (v) => v },
        { id: 'finisher', name: 'The Finisher', desc: 'Najlepšie zahrané 4. kolo v kariére.', icon: '🏁', format: (v) => v },
        { id: 'major_hunter', name: 'Major Hunter', desc: 'Najviac výhier v Dôležitých (!) a Významných (=) turnajoch.', icon: '⭐', format: (v) => `${v}x` },
        { id: 'major_avg', name: 'Big Game Player', desc: 'Najlepšie priemerné umiestnenie v Major turnajoch (min. 3 turnaje).', icon: '🦁', format: (v) => v.toFixed(1) },
        { id: 'runner_up', name: 'Silver Collector', desc: 'Najviac druhých miest.', icon: '🥈', format: (v) => `${v}x` },
        { id: 'consistency_king', name: 'Mr. Consistent', desc: 'Najlepšie priemerné umiestnenie v kariére (min. 10 turnajov).', icon: '📊', format: (v) => v.toFixed(1) },
        { id: 'marathon_man', name: 'Marathon Man', desc: 'Celkový počet odohraných jamiek.', icon: '🏃', format: (v) => v },
        { id: 'win_streak', name: 'Win Streak', desc: 'Najviac výhier v rade za sebou.', icon: '🔥', format: (v) => `${v}x` },
        { id: 'best_weekend', name: 'Best Weekend', desc: 'Najnižší súčet skóre za víkend (R3 + R4).', icon: '🎉', format: (v) => v },
        { id: 'worst_collapse', name: 'Worst Collapse', desc: 'Najväčšie zhoršenie skóre medzi R3 a R4 (R4 >> R3).', icon: '🥀', format: (v) => `+${v}` },
        { id: 'comeback_kid', name: 'Comeback Kid', desc: 'Najväčšie zlepšenie skóre medzi R3 a R4 (R4 << R3).', icon: '🆙', format: (v) => v.toFixed(2) },
        { id: 'scoring_machine', name: 'Sub-70 Machine', desc: 'Počet kôl zahraných pod 70 úderov.', icon: '🔫', format: (v) => `${v}x` },
        { id: 'kft_king', name: 'KFT King', desc: 'Najviac bodov získaných na KFT Tour.', icon: '🚜', format: (v) => v.toFixed(0) },
        { id: 'pga_dominator', name: 'PGA Dominator', desc: 'Najviac bodov získaných na PGA Tour.', icon: '🏙️', format: (v) => v.toFixed(0) },
        { id: 'under_par_total', name: 'Red Numbers', desc: 'Celkové skóre voči Paru v kariére.', icon: '🔻', format: (v) => v > 0 ? `+${v}` : v },
        { id: 'sub60_count', name: '61 Watch', desc: 'Počet kôl pod 62 úderov.', icon: '👽', format: (v) => `${v}x` },
        { id: 'unique_winner', name: 'Global Winner', desc: 'Počet rôznych typov Tour, na ktorých hráč vyhral.', icon: '🌍', format: (v) => `${v}` },
        { id: 'efficiency', name: 'Efektivita', desc: 'Priemerný počet bodov na jeden odohraný turnaj (min. 5 turnajov).', icon: '📊', format: (v) => v.toFixed(1) },
        { id: 'mr_friday', name: 'Mr. Friday', desc: 'Najlepší priemer skóre v 2. kole (Cut Day).', icon: '📅', format: (v) => v.toFixed(2) },
        { id: 'ea_king', name: 'EA Sports Pro', desc: 'Najviac bodov získaných v EA Sports turnajoch.', icon: '🎮', format: (v) => v.toFixed(0) },
        { id: 'players_king', name: 'Players King', desc: 'Najviac bodov získaných v turnajoch The Players.', icon: '🧢', format: (v) => v.toFixed(0) },
        { id: 'fedex_king', name: 'FedEx King', desc: 'Najviac bodov získaných vo FedEx Cup turnajoch.', icon: '🏆', format: (v) => v.toFixed(0) },
        { id: 'weekend_golfer', name: 'Víkendový Hráč', desc: 'Najviac kôl zahraných so skóre 80 a viac.', icon: '🍺', format: (v) => `${v}x` },
        { id: 'sub65_machine', name: 'Super Skórovanie', desc: 'Počet kôl zahraných pod 65 úderov.', icon: '🔥', format: (v) => `${v}x` },
        { id: 'bridesmaid', name: 'Večne Druhý', desc: 'Najviac umiestnení v Top 5 bez jedinej výhry.', icon: '💍', format: (v) => `${v}x` },
        { id: 'fireworks', name: 'Ohňostroj', desc: 'Súčet všetkých Aces, Eagles a Birdies (vyžaduje sezónne štatistiky).', icon: '🎆', format: (v) => v },
        { id: 'bogey_man', name: 'Bogey Man', desc: 'Najviac Bogeys v sezóne (vyžaduje sezónne štatistiky).', icon: '👻', format: (v) => v },
        { id: 'disaster_artist', name: 'Disaster Artist', desc: 'Najviac Double Bogeys v sezóne (vyžaduje sezónne štatistiky).', icon: '💣', format: (v) => v },
        { id: 'adapter', name: 'Adaptér', desc: 'Najväčšie priemerné zlepšenie skóre medzi 1. a 4. kolom (R4 lepšie ako R1).', icon: '📈', format: (v) => `-${v.toFixed(2)}` },
        { id: 'gas_out', name: 'Vyhorený', desc: 'Najväčšie priemerné zhoršenie skóre medzi 1. a 4. kolom (R1 lepšie ako R4).', icon: '📉', format: (v) => `+${v.toFixed(2)}` },
        { id: 'risk_taker', name: 'Hazardér', desc: 'Pomer Birdies ku Parom. Čím vyššie, tým agresívnejší štýl.', icon: '🎲', format: (v) => `${(v*100).toFixed(1)}%` },
        { id: 'safe_hands', name: 'Istota', desc: 'Pomer Parov ku Bogeys. Koľko Parov zahrá na jedno Bogey.', icon: '🛡️', format: (v) => v.toFixed(2) },
        { id: 'jekyll_hyde', name: 'Jekyll & Hyde', desc: 'Rozdiel medzi najlepším a najhorším kolom v kariére.', icon: '🎭', format: (v) => v },
        { id: 'major_contender', name: 'Major Contender', desc: 'Najviac umiestnení v Top 10 na Major/Important turnajoch.', icon: '⭐', format: (v) => `${v}x` },
        { id: 'survivalist', name: 'Survivalist', desc: 'Najviac prejdených Cutov bez jedinej výhry.', icon: '🏝️', format: (v) => `${v}x` },
        { id: 'points_per_round', name: 'Body na Kolo', desc: 'Priemerný zisk bodov na jedno odohrané kolo.', icon: '➗', format: (v) => v.toFixed(2) },
        { id: 'classic_king', name: 'Classic King', desc: 'Najviac bodov v bežných (nie Major/Important) turnajoch.', icon: '📜', format: (v) => v.toFixed(0)},
        { id: 'career_aces', name: 'Kariérne Esá', desc: 'Celkový počet Hole-in-One za celú kariéru (Súčet).', icon: '🎯', format: (v) => v },
        { id: 'career_eagles', name: 'Kariérne Eagly', desc: 'Celkový počet Eagles za celú kariéru (Súčet).', icon: '🦅', format: (v) => v },
        { id: 'career_birdies', name: 'Kariérne Birdies', desc: 'Celkový počet Birdies za celú kariéru (Súčet).', icon: '🐦', format: (v) => v },
        { id: 'career_pars', name: 'Kariérne Pary', desc: 'Celkový počet Parov za celú kariéru (Súčet).', icon: '⚖️', format: (v) => v },
        { id: 'career_bogeys', name: 'Kariérne Bogeys', desc: 'Celkový počet Bogeys za celú kariéru (Súčet).', icon: '👻', format: (v) => v },
        { id: 'career_doubles', name: 'Kariérne Doubles', desc: 'Celkový počet Double Bogeys za celú kariéru (Súčet).', icon: '💣', format: (v) => v },
        { id: 'win_pct', name: 'Úspešnosť Výhier', desc: 'Percentuálny podiel výhier k počtu turnajov (min. 20 turnajov).', icon: '📈', format: (v) => `${v.toFixed(1)}%` },
        { id: 'top10_pct', name: 'Top 10 Úspešnosť', desc: 'Percentuálny podiel umiestnení v Top 10 (min. 20 turnajov).', icon: '📊', format: (v) => `${v.toFixed(1)}%` },
        { id: 'cut_pct', name: 'Cut Úspešnosť', desc: 'Percentuálna úspešnosť prejdenia Cutom (min. 20 turnajov).', icon: '🛡️', format: (v) => `${v.toFixed(1)}%` },
        { id: 'top5_pct', name: 'Top 5 Úspešnosť', desc: 'Percentuálny podiel umiestnení v Top 5 (min. 20 turnajov).', icon: '🖐️', format: (v) => `${v.toFixed(1)}%` },
        { id: 'streak_top10', name: 'Top 10 Séria', desc: 'Najviac umiestnení v Top 10 za sebou (Streak).', icon: '🔥', format: (v) => `${v}x` },
        { id: 'streak_cuts', name: 'Cut Séria', desc: 'Najviac prejdených Cutov za sebou bez vypadnutia.', icon: '🧱', format: (v) => `${v}x` },
        { id: 'lowest_r1', name: 'Najnižšie R1', desc: 'Najlepšie zahrané 1. kolo v kariére.', icon: '1️⃣', format: (v) => v },
        { id: 'lowest_r2', name: 'Najnižšie R2', desc: 'Najlepšie zahrané 2. kolo v kariére.', icon: '2️⃣', format: (v) => v },
        { id: 'lowest_r3', name: 'Najnižšie R3', desc: 'Najlepšie zahrané 3. kolo v kariére.', icon: '3️⃣', format: (v) => v },
        { id: 'highest_rnd', name: 'Najhoršie Kolo', desc: 'Najvyššie zahrané skóre v jednom kole (Disaster Round).', icon: '🤮', format: (v) => v },
        { id: 'season_best_wins', name: 'Dominancia Sezóny', desc: 'Najviac výhier v jednej sezóne.', icon: '👑', format: (v) => `${v}x` },
        { id: 'season_best_pts', name: 'Bodový Rekord Sezóny', desc: 'Najviac získaných bodov v jednej sezóne.', icon: '📅', format: (v) => v.toFixed(0) },
        { id: 'longevity', name: 'Dlhovekosť', desc: 'Počet sezón, v ktorých hráč odohral aspoň 1 turnaj.', icon: '⏳', format: (v) => `${v}` },
        { id: 'missed_cuts', name: 'Neprejdené Cuty', desc: 'Celkový počet turnajov, kde hráč neprešiel Cutom.', icon: '❌', format: (v) => `${v}x` }
    ];

    let db = { files: [], seasonStats: [] }; 
    window.globalBadgeHolders = {}; 
    window.eloRatings = {}; 
    
    let lastVitrineTheme = 'Clean White';

// --- KONFIGURÁCIA KALENDÁRA A NOVÍN ---

const SCHEDULE_START_YEAR = 2026;
// Poradie turnajov podľa tvojho zoznamu (Názov súboru -> Číslo týždňa)
// Nechávame medzery pre "realistickejší" kalendár (napr. pauza po Majors), ale mapujeme 45 turnajov na 52 týždňov.
const TOURNAMENT_SCHEDULE = {
    'Wisconsin Open': 2, 'Desert Championship': 3, 'California Classic': 4, 'Florida Open': 5,
    'Hilton Head Invitational': 6, 'Canadian Championship': 7, 'Oregon Championship': 8, 'Boston Open': 9,
    'Charlotte Championship': 10, 'The American Express': 12, 'Farmers Insurance Open': 13, 'AT&T Pebble Beach': 14,
    'WM Phoenix Open': 15, 'The Genesis Invitation': 16, 'The Florida Classic': 17, 'Arnold Palmer Invitational by Mastercard': 18,
    'Lighthouse Open': 19, 'THE PLAYERS Championship': 20, 'Pacific Championship': 21, 'EA SPORTS Championship': 22,
    'Wetlands Championship': 23, 'Carolina Open': 24, 'MASTERS Tournament': 26, // Major pauza pred
    'RBC Heritage': 27, 'Mesquite Classic': 28, 'French Open': 29, 'Wells Fargo Championship': 30,
    'Tiburon Championship': 31, 'PGA Championship': 33, // Major
    'New Jersey Challenge': 34, 'The Sawgrass Invitational': 35, 'Alberta Open': 36, 'U.S. OPEN': 38, // Major
    'Kiwi Championship': 39, 'The Maine Classic': 40, 'Dominican Open': 41, 'Nevada Championship': 42,
    'THE OPEN Championship': 44, // Major
    'Banff Championship': 45, 'Kohler Open': 46, 'Arizona Classic': 47, 'New England Championship': 48,
    'FedEx  St. Jude Championship': 49, 'FedEx  BMW Championship': 50, 'FedEx  Tour Championship': 51
};

const NEWSPAPER_BRANDS = [
    { id: 'arci', name: 'ArciNews', theme: 'theme-arci' },
    { id: 'gazette', name: 'The Golf Gazette', theme: 'theme-gazette' },
    { id: 'divot', name: 'Daily Divot', theme: 'theme-divot' },
    { id: 'green', name: 'Green Jacket J.', theme: 'theme-green' },
    { id: 'bunker', name: 'The Bunker', theme: 'theme-bunker' },
    { id: 'social', name: 'ClubHouse Social', theme: 'theme-social' },
    { id: 'insider', name: 'Fairway Insider', theme: 'theme-insider' },
    { id: 'tech', name: 'Eagle Eye', theme: 'theme-tech' },
    { id: 'diary', name: 'Caddie\'s Diary', theme: 'theme-diary' },
    { id: 'pub', name: 'The 19th Hole', theme: 'theme-pub' }
];

// --- ŠABLÓNY ČLÁNKOV (3 Príklady pre každú kategóriu) ---
const newsTemplates = {
    winner: [
        { h: "{name} ovládol turnaj!", b: "Fantastický výkon! {name} nenechal nikoho na pochybách a s celkovým skóre {score} bodov si odnáša trofej z {tour}. Diváci šaleli pri každom jeho odpale." },
        { h: "Kráľom víkendu je {name}", b: "Neuveriteľná dominancia. {name} predviedol golf z inej planéty. Zisk {score} bodov hovorí za všetko. Súperi sa len bezmocne prizerali." },
        { h: "Zlato pre {name}", b: "Po napínavom finále sa z víťazstva teší {name}. Rozhodla pevná ruka na gríne a chladná hlava. Konečných {score} bodov mu zabezpečilo prvenstvo." }
    ],
    loser: [ // Mal ostať doma
        { h: "Katastrofa menom {name}", b: "Tak toto nevyšlo. {name} sa trápil od prvej jamky. Skončil na {rank}. mieste a najradšej by na tento turnaj zabudol. Možno by mal zmeniť palice." },
        { h: "{name}: Výkon na zaplakanie", b: "Diváci si zakrývali oči. {name} predviedol sériu chýb, ktorá ho stála lepší výsledok. {rank}. miesto je sklamaním pre fanúšikov." },
        { h: "Mal ostať doma: {name}", b: "Dnes to jednoducho nešlo. {name} hľadal loptičky viac v lese ako na ferveji. Výsledné {rank}. miesto zodpovedá predvedenej hre." }
    ],
    choke: [ // Chlastal (zhoršenie)
        { h: "{name} nezvládol tlak", b: "Po skvelom úvode prišiel pád. {name} v nedeľu vyhorel ako fakľa. Rozdiel medzi kolami bol priepastný. Asi ťažká noc v bare." },
        { h: "Kolaps víkendu: {name}", b: "Čo sa stalo? {name} mal našliapnuté na titul, ale záverečné kolo bolo nočnou morou. Skóre sa prepadlo a nádeje zhasli." },
        { h: "{name} a jeho nedeľné fiasko", b: "Namiesto útoku na čelo prišiel pád. {name} stratil koncentráciu a zahral jedno z najhorších kôl sezóny práve vtedy, keď o niečo išlo." }
    ],
    clutch: [ // Trénoval (zlepšenie)
        { h: "{name} zapol turbo!", b: "Neuveriteľný comeback! {name} sa po slabšom štarte vzchopil a v nedeľu predviedol jazdu života. Skvelé zlepšenie ho vystrelilo v poradí nahor." },
        { h: "Nedeľný kráľ: {name}", b: "Kým ostatní odpadávali, {name} pridal plyn. Jeho finálové kolo bolo ukážkou mentálnej sily. Tréning sa evidentne vyplatil." },
        { h: "{name} a jeho stíhacia jazda", b: "Znižoval náskok súperov jamku po jamke. {name} ukázal, že sa nikdy nevzdáva. Jeho záver turnaja bol ozdobou podujatia." }
    ],
    random: [ // Stalo sa
        { h: "Aligátor na 13. jamke", b: "Hru na chvíľu prerušil nečakaný návštevník. Obrovský aligátor sa prešiel po gríne, akoby mu to tam patrilo. Hráči radšej ustúpili." },
        { h: "Vietor úradoval", b: "Silný nárazový vietor robil hráčom problémy celý víkend. Loptičky lietali nepredvídateľne a skóre utrpelo. Organizátori mali plné ruky práce." },
        { h: "Fanúšik trafený loptičkou", b: "Nepríjemný incident na 5. jamke. Nepresný odpal skončil v dave. Našťastie to odniesla len rozliata kola a mierna modrina." }
    ],
    stats: [ // Štatistiky
        { h: "Analýza: {name} a jeho patovanie", b: "Hlbší pohľad do štatistík ukazuje, že {name} exceloval na grínoch. Jeho priemer patov na kolo bol hlboko pod priemerom poľa." },
        { h: "Čísla neklamú: {name} je stroj", b: "{name} trafil neuveriteľné percento fervejí. Presnosť je jeho silnou stránkou a tento turnaj to len potvrdil." },
        { h: "Štatistický kútik: {name}", b: "Zaujímavosťou turnaja je výkon hráča {name} na par 5 jamkách. Tam získal rozhodujúci náskok vďaka agresívnej hre." }
    ],
    rank: [ // Rebríčky
        { h: "Skok v rebríčku pre {name}", b: "Vďaka skvelému výsledku sa {name} posúva v oficiálnom hodnotení výrazne nahor. Jeho forma graduje v pravý čas." },
        { h: "{name} klesá nadol", b: "Séria zlých výsledkov sa prejavila. {name} stráca pozície a bude musieť zabrať, ak sa chce udržať v elitnej spoločnosti." },
        { h: "Rebríčkové zemetrasenie", b: "Tento turnaj zamiešal kartami. {name} si polepšil, zatiaľ čo favoriti strácali. Boj o post svetovej jednotky sa vyostruje." }
    ],
    interview: [ // Interview
        { h: "Rozhovor: {name} o svojej hre", b: "'Cítil som sa skvele,' povedal {name} po kole. 'Kľúčom bolo zostať trpezlivý a čakať na svoje šance. Tento turnaj mi sedí.'" },
        { h: "{name}: 'Musím trénovať viac'", b: "V exkluzívnom rozhovore {name} priznal, že nie je spokojný. 'Moje železá nefungovali tak, ako by som chcel. Mám na čom pracovať.'" },
        { h: "Spoveď hráča: {name}", b: "{name} nám prezradil tajomstvo svojho úspechu: 'Dobrá strava a čistá hlava. A samozrejme, trochu šťastia na 18. jamke.'" }
    ],
    records: [ // Rekordy
        { h: "Historický moment!", b: "Prepisovali sa tabuľky! Výkon, ktorý sme videli, sa zapíše do dejín. Diváci boli svedkami niečoho výnimočného." },
        { h: "Nový rekord ihriska", b: "Neuveriteľné skóre v podaní jedného z hráčov. Ihrisko {tour} ešte nikdy nezažilo takúto smršť birdie a eaglov." },
        { h: "Osobný rekord pre {name}", b: "{name} prekonal sám seba. Zahral svoje životné kolo a dokázal, že jeho potenciál ešte zďaleka nie je vyčerpaný." }
    ],
    others: [ // Ostatné
        { h: "Nový trend v golfovej móde?", b: "Hráči prekvapili pestrými farbami. Zdá sa, že konzervatívna móda ustupuje. Ružové nohavice boli hitom víkendu." },
        { h: "Ceny piva na turnaji šokujú", b: "Fanúšikovia sa sťažujú na ceny občerstvenia. Pivo za 15 dolárov? To je aj na golf priveľa, znie z tribún." },
        { h: "Veverička ukradla sendvič", b: "Úsmevný moment v zázemí. Drzá veverička ukradla caddiemu obed priamo z bagu. Video sa stalo virálnym hitom." }
    ]
};

    // --- LOGIKA NOVÍN A DÁTUMOV ---

    // Inicializácia archívu a obľúbených (ak neexistuje)
    // Táto kontrola sa vykonáva pri štarte alebo pri načítaní
    
    function initNewsState() {
        if (!appState.news) appState.news = { archive: {}, favorites: [], activePaperId: 'arci' };
    }

    function getTournamentDate(season, eventName) {
        // 1. Zistiť číslo turnaja v sezóne podľa názvu
        let cleanName = eventName;
        const prefixMatch = eventName.match(/^\d+\s+[^-]+-\s+(.+)$/);
        if (prefixMatch) cleanName = prefixMatch[1];
        
        let weekNum = 1;
        // Hľadáme v mape turnajov
        for (const [key, val] of Object.entries(TOURNAMENT_SCHEDULE)) {
            if (cleanName.includes(key)) {
                weekNum = val;
                break;
            }
        }
        
        // Ak sme nenašli v mape, skúsime vyparsovať číslo zo súboru ak existuje
        if (weekNum === 1 && eventName.match(/^\d+/)) {
            weekNum = parseInt(eventName.match(/^(\d+)/)[1]);
        }

        // 2. Výpočet dátumu
        // Base: 5.1.2026 (Pondelok)
        let seasonInt = parseInt(season);
        if (isNaN(seasonInt)) seasonInt = 10; 
        
        const yearOffset = Math.max(0, seasonInt - 10); 
        const year = SCHEDULE_START_YEAR + yearOffset;
        
        const baseDate = new Date(`${year}-01-05`); 
        const daysToAdd = (weekNum - 1) * 7;
        
        const finalDate = new Date(baseDate);
        finalDate.setDate(baseDate.getDate() + daysToAdd);
        
        return finalDate.toLocaleDateString('sk-SK', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Hlavná funkcia na otvorenie novín
    window.openArciNews = function(fileId = null) {
        initNewsState();

        // 1. Určenie aktívneho súboru (najnovší alebo vybraný z histórie)
        const sortedFiles = [...db.files].sort((a,b) => compareFiles(b, a));
        if (sortedFiles.length === 0) { alert("Žiadne turnaje v databáze."); return; }
        
        let targetFile = sortedFiles[0];
        if (fileId) targetFile = db.files.find(f => f.id == fileId);
        
        if (!targetFile) return;

        const fileKey = `${targetFile.season}_${targetFile.eventNum}_${targetFile.eventName}`;

        // 2. Generovanie obsahu ak neexistuje
        if (!appState.news.archive[fileKey]) {
            generateNewsIssue(targetFile, fileKey);
            saveAuto();
        }

        // 3. Renderovanie UI
        renderNewsUI(targetFile, fileKey);
    }

    function generateNewsIssue(file, key) {
        // Zoradíme hráčov podľa ranku
        const players = [...file.content].sort((a,b) => a.rank - b.rank);
        if (players.length === 0) return;

        const winner = players[0];
        const loser = players[players.length - 1];
        
        // Nájdenie špecifických hráčov
        // Choker: Niekto kto zahral R4 oveľa horšie ako R1
        const choker = players.find(p => {
            const r1 = parseInt(p.r1); const r4 = parseInt(p.r4);
            return !isNaN(r1) && !isNaN(r4) && r4 >= r1 + 5 && p.rank > 5;
        }) || players[Math.min(players.length-2, 5)];

        // Clutch: Niekto kto zahral R4 oveľa lepšie ako R1
        const clutch = players.find(p => {
            const r1 = parseInt(p.r1); const r4 = parseInt(p.r4);
            return !isNaN(r1) && !isNaN(r4) && r4 <= r1 - 5;
        }) || players[1];

        // Generovanie pre KAŽDÚ značku novín (10x)
        const issueData = {};
        
        NEWSPAPER_BRANDS.forEach(brand => {
            const articles = [];
            
            // Pomocná funkcia na pridanie článku
            const add = (cat, pObj) => {
                // Ak nemáme hráča (napr. pre random články), vyberieme náhodného
                if (!pObj) pObj = players[Math.floor(Math.random() * players.length)];
                
                const tmpls = newsTemplates[cat];
                if (!tmpls) return; // Poistka ak chýba kategória

                const t = tmpls[Math.floor(Math.random() * tmpls.length)];
                
                let title = t.h.replace(/{name}/g, pObj.name).replace(/{score}/g, pObj.points).replace(/{rank}/g, pObj.rank).replace(/{tour}/g, file.eventName);
                let text = t.b.replace(/{name}/g, pObj.name).replace(/{score}/g, pObj.points).replace(/{rank}/g, pObj.rank).replace(/{tour}/g, file.eventName);
                
                // SK Lokálizácia kategórie pre zobrazenie
                let skCat = cat;
                if(cat==='winner') skCat='Víťaz'; if(cat==='records') skCat='Rekordy'; if(cat==='clutch') skCat='Trénoval';
                if(cat==='random') skCat='Stalo sa'; if(cat==='choke') skCat='Chlastal'; if(cat==='loser') skCat='Mal ostať doma';
                if(cat==='stats') skCat='Štatistiky'; if(cat==='rank') skCat='Rebríčky'; if(cat==='others') skCat='Ostatné';
                if(cat==='interview') skCat='Rozhovor';

                articles.push({
                    id: Date.now() + Math.random(),
                    headline: title,
                    body: text,
                    category: skCat,
                    player: pObj.name,
                    isFav: false
                });
            };

            // Pevné poradie kategórií podľa zadania
            add('winner', winner);
            if (Math.random() > 0.7) add('records', winner);
            add('clutch', clutch);
            add('random', null); add('random', null);
            add('choke', choker);
            add('random', null);
            add('loser', loser);
            
            // Viac štatistík
            const statsCount = 5 + Math.floor(Math.random() * 3);
            for(let i=0; i<statsCount; i++) add('stats', players[Math.floor(Math.random() * Math.min(20, players.length))]);
            
            add('random', null); add('random', null); add('random', null);
            add('rank', winner);
            add('interview', players[Math.floor(Math.random() * 5)]);
            add('random', null);
            add('others', null); add('others', null);

            issueData[brand.id] = articles;
        });

        appState.news.archive[key] = issueData;
    }

    function renderNewsUI(file, fileKey) {
        const dateStr = getTournamentDate(file.season, file.eventName);
        
        // Zostavenie záložiek pre noviny
        const tabsHtml = NEWSPAPER_BRANDS.map(b => 
            `<div class="paper-tab ${appState.news.activePaperId === b.id ? 'active' : ''}" 
                  onclick="switchPaper('${b.id}', '${fileKey}', '${file.id}')">
                ${b.name}
            </div>`
        ).join('');

        const html = `
            <div class="news-modal-body">
                <div class="news-nav-bar">
                    <div class="news-date-display">${dateStr}</div>
                    <div class="news-controls">
                        <button class="btn btn-sm btn-grey" onclick="openNewsCalendar()">📅 Archív</button>
                        <button class="btn btn-sm btn-grey" onclick="showFavorites()">★ Obľúbené</button>
                        <button class="close-btn" onclick="closeTopModal()" style="font-size:1.2rem; margin-left:10px;">&times;</button>
                    </div>
                </div>
                
                <div class="paper-switcher">
                    ${tabsHtml}
                </div>

                <div id="newsContentArea" class="news-content-area ${getThemeClass(appState.news.activePaperId)}">
                    </div>
            </div>
        `;

        createModal(html, 'news-modal');
        // Renderovanie obsahu
        renderNewsList(fileKey);
    }

    function getThemeClass(paperId) {
        const brand = NEWSPAPER_BRANDS.find(b => b.id === paperId);
        return brand ? brand.theme : 'theme-arci';
    }

    window.switchPaper = function(paperId, fileKey, fileId) {
        appState.news.activePaperId = paperId;
        
        // Update container class
        const container = document.getElementById('newsContentArea');
        if(container) container.className = `news-content-area ${getThemeClass(paperId)}`;
        
        // Update tabs visual manually
        const switcher = document.querySelector('.paper-switcher');
        if(switcher) {
            switcher.innerHTML = NEWSPAPER_BRANDS.map(b => 
                `<div class="paper-tab ${appState.news.activePaperId === b.id ? 'active' : ''}" 
                      onclick="switchPaper('${b.id}', '${fileKey}', '${fileId}')">
                    ${b.name}
                </div>`
            ).join('');
        }
        
        // Uložiť preferenciu a prekresliť
        saveAuto();
        renderNewsList(fileKey);
    }

    function renderNewsList(fileKey) {
        const paperId = appState.news.activePaperId;
        if (!appState.news.archive[fileKey] || !appState.news.archive[fileKey][paperId]) return;

        const articles = appState.news.archive[fileKey][paperId];
        const container = document.getElementById('newsContentArea');
        
        const listHtml = articles.map((art, idx) => `
            <div class="news-list-item" onclick="readFullArticle('${fileKey}', ${idx})">
                <div class="fav-star ${art.isFav ? 'active' : ''}" onclick="toggleFavorite(event, '${fileKey}', ${idx})">★</div>
                <span class="news-tag" style="background:#444">${art.category}</span>
                <div class="news-list-headline article-headline">${art.headline}</div>
                <div class="news-list-perex">${art.body.substring(0, 100)}...</div>
            </div>
        `).join('');
        
        container.innerHTML = `<div class="news-list-container">${listHtml}</div>`;
    }

    window.readFullArticle = function(fileKey, articleIndex) {
        const paperId = appState.news.activePaperId;
        const art = appState.news.archive[fileKey][paperId][articleIndex];
        
        const themeClass = getThemeClass(paperId);
        
        const html = `
            <div class="news-modal-body ${themeClass}">
                <div class="news-nav-bar">
                    <button class="btn btn-sm btn-grey" onclick="closeTopModal()">← Späť</button>
                    <div style="font-weight:bold;">${art.category}</div>
                    <div class="fav-star ${art.isFav ? 'active' : ''}" style="position:static" onclick="toggleFavorite(event, '${fileKey}', ${articleIndex}, true)">★</div>
                </div>
                <div class="news-content-area">
                    <div class="article-full-content">
                        <div class="news-header-title">${NEWSPAPER_BRANDS.find(b=>b.id===paperId).name}</div>
                        <h1 class="article-headline" style="font-size:2.5rem; margin-bottom:20px;">${art.headline}</h1>
                        <hr style="border-color:#ccc; margin-bottom:20px;">
                        <div class="article-body" style="font-size:1.2rem; line-height:1.6; text-align:justify;">
                            <p>${art.body}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        createModal(html);
    }

    window.toggleFavorite = function(e, fileKey, idx, refreshFull = false) {
        e.stopPropagation();
        const paperId = appState.news.activePaperId;
        const art = appState.news.archive[fileKey][paperId][idx];
        art.isFav = !art.isFav;
        
        // Pridanie/Odobranie z globálneho zoznamu obľúbených
        if (art.isFav) {
            appState.news.favorites.push({ ...art, key: fileKey, pId: paperId, oIdx: idx });
        } else {
            appState.news.favorites = appState.news.favorites.filter(f => f.headline !== art.headline);
        }
        saveAuto();
        
        if (refreshFull) {
            const star = document.querySelector('.news-nav-bar .fav-star');
            if (star) star.classList.toggle('active');
        } else {
            renderNewsList(fileKey);
        }
    }

    window.showFavorites = function() {
        const favs = appState.news.favorites;
        const html = `
            <div class="modal-header"><h2>Obľúbené Články</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div>
            <div class="modal-body" style="background:#222; min-height:100%;">
                ${favs.length === 0 ? '<div style="padding:20px; text-align:center;">Zatiaľ žiadne obľúbené články.</div>' : ''}
                <div class="news-list-container">
                    ${favs.map(f => `
                        <div class="news-list-item" style="background:#fff; color:#000; border-radius:4px;" onclick="alert('Pre čítanie otvor pôvodné noviny cez archív (cez Kalendár).')">
                            <div class="news-tag" style="background:#444">${f.category}</div>
                            <div class="news-list-headline" style="font-weight:bold;">${f.headline}</div>
                            <div style="font-size:0.8rem; color:#666; margin-top:5px;">${f.player} | ${NEWSPAPER_BRANDS.find(b=>b.id===f.pId)?.name || 'Neznáme noviny'}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        createModal(html);
    }

    window.openNewsCalendar = function() {
        const files = [...db.files].sort((a,b) => compareFiles(b, a));
        const html = `
            <div class="modal-header"><h2>Archív Vydaní</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:10px;">
                    ${files.map(f => `
                        <button class="btn btn-grey" style="text-align:left; padding:10px;" onclick="closeTopModal(); openArciNews('${f.id}')">
                            <div style="font-weight:bold; color:var(--highlight-gold)">Sezóna ${f.season} - Týždeň ${f.week || TOURNAMENT_SCHEDULE[f.eventName] || '?'}</div>
                            <div style="font-size:0.9rem;">${f.eventName}</div>
                            <div style="font-size:0.7rem; color:#aaa;">${getTournamentDate(f.season, f.eventName)}</div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
        createModal(html);
    }





      let appState = {
        filters: { tours: ['ALL'], events: [], seasons: [], importance: 'ALL', activeWeek: null },
        ui: { showWeeks: false, eventDropdownOpen: false, seasonDropdownOpen: false, importanceDropdownOpen: false },
        sort: { column: 'points', dir: 'desc' },
        settings: { zoom: 0, theme: 'Default', themesOpen: false }, 
        history: [],
        unlockedBadges: {} // <--- TOTO PRIDAJ (Pamäť pre odznaky)
    };

    
    let modalStack = [];
    let isProgrammaticBack = false; // Oprava dvojitého zatvárania
    let slotToUpload = null;
    const VALID_TOURS = ['KFT', 'PGA', 'EA SPORTS', 'THE PLAYERS', 'FED EX', 'MAIN'];

// --- ELO CALCULATION SYSTEM ---
    function calculateELO() {
        const sortedFiles = [...db.files].sort(compareFiles); 
        const ratings = {}; 
        const K_BASE = 32;  
        const START_ELO = 1200;

        sortedFiles.forEach(file => {
            // --- KFT IZOLÁCIA: KFT turnaje neovplyvňujú ELO ---
            if (file.type === 'KFT') return;

            const playersInTournament = file.content;
            const activePlayers = playersInTournament.filter(p => p.rank > 0);
            
            activePlayers.forEach(p => {
                const name = normalizeName(p.name);
                if (!ratings[name]) ratings[name] = START_ELO;
            });

            const eloChanges = {}; 

            activePlayers.forEach(pA => {
                const nameA = normalizeName(pA.name);
                let actualScoreSum = 0;
                let expectedScoreSum = 0;
                const ratingA = ratings[nameA];
                
                let K = K_BASE;
                if (file.isImportant) K = K_BASE * 1.5;
                if (file.isSignificant) K = K_BASE * 1.25;
                if (file.type === 'FED EX' || file.type === 'THE PLAYERS') K = K_BASE * 2.0;

                activePlayers.forEach(pB => {
                    if (pA === pB) return;
                    const nameB = normalizeName(pB.name);
                    const ratingB = ratings[nameB];

                    const expected = 1 / (1 + Math.pow(10, (ratingB - ratingA) / 400));
                    expectedScoreSum += expected;

                    let actual = 0.5;
                    if (pA.rank < pB.rank) actual = 1; 
                    else if (pA.rank > pB.rank) actual = 0; 

                    actualScoreSum += actual;
                });

                const count = activePlayers.length - 1;
                if (count > 0) {
                     const change = K * (actualScoreSum - expectedScoreSum) / Math.max(1, (count / 20));
                     eloChanges[nameA] = change;
                }
            });

            Object.keys(eloChanges).forEach(key => {
                ratings[key] += eloChanges[key];
            });
        });

        window.eloRatings = ratings;
    }

    function getELORankList() {
        if (Object.keys(window.eloRatings).length === 0) calculateELO();
        const arr = Object.entries(window.eloRatings).map(([name, elo]) => {
            let realName = name;
            for(const f of db.files) {
                const found = f.content.find(p => normalizeName(p.name) === name);
                if(found) { realName = found.name; break; }
            }
            return { name: realName, points: elo, rank: 0 };
        });
        arr.sort((a, b) => b.points - a.points);
        arr.forEach((p, i) => p.rank = i + 1);
        return arr;
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAutoSave();
        if (typeof appState.settings.zoom === 'boolean') {
            appState.settings.zoom = appState.settings.zoom ? 1 : 0;
        }
        if (!appState.filters.importance) appState.filters.importance = 'ALL';
        if (!db.seasonStats) db.seasonStats = [];

        calculateELO();
        calculateGlobalAchievements();

        applyTheme(appState.settings.theme);
        updateViewport();
        renderApp();

        window.onpopstate = function(event) {
            // Ak sme stlačili krížik, ignorujeme túto udalosť, aby sa nezavrelo aj okno pod tým
            if (isProgrammaticBack) {
                isProgrammaticBack = false;
                return;
            }
            if (modalStack.length > 0) closeTopModal(false);
        };

        const body = document.body;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            body.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => {
            body.addEventListener(eventName, () => body.style.borderColor = 'var(--accent-green)', false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            body.addEventListener(eventName, () => body.style.borderColor = 'transparent', false);
        });
        body.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            const seasonFiles = [];
            const tourFiles = [];
            Array.from(files).forEach(f => {
                if (f.name.includes('stats') || /^\d+\.txt$/.test(f.name)) seasonFiles.push(f);
                else if (f.name.endsWith('.txt')) tourFiles.push(f);
            });
            if (tourFiles.length > 0) handleFiles(tourFiles);
            if (seasonFiles.length > 0) handleSeasonFiles(seasonFiles);
        }
    });
    // --- File Handling ---
    function handleFiles(files) {
        let count = 0;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                parseTxt(file.name, e.target.result);
                count++;
                if(count === files.length) {
                    calculateELO(); 
                    calculateGlobalAchievements(); 
                    renderApp();
                    saveAuto();
                }
            };
            reader.readAsText(file);
        });
        document.getElementById('fileInput').value = ''; 
    }

    function parseTxt(filename, text) {
        if (filename.toUpperCase().includes('PRIPRAVA') || filename.toUpperCase().includes('PRÍPRAVA')) return;
        let cleanName = filename.replace('.txt', '').trim();
        let isImportant = false; 
        let isSignificant = false; 
        
        // Detekcia dôležitosti z názvu súboru
        if (cleanName.includes('!')) { isImportant = true; cleanName = cleanName.replace('!', '').trim(); }
        if (cleanName.includes('=')) { isSignificant = true; cleanName = cleanName.replace('=', '').trim(); }
        
        const parts = cleanName.split(' ');
        
        // Pokus o parsovanie typu turnaja a čísla
        // Predpokladaný formát: "Typ Sezóna-Číslo-Týždeň Názov" alebo "01 Názov"
        
        let type = 'UNKNOWN';
        let season = '00';
        let eventNum = 0;
        let week = 0;
        let eventName = cleanName;

        // Detekcia typu na zaciatku
        let firstPart = parts[0].toUpperCase();
        if (VALID_TOURS.includes(firstPart) || firstPart === 'EA' || firstPart === 'PLAYERS' || firstPart === 'MAIN') {
             if (firstPart === 'EA') type = 'EA SPORTS';
             else if (firstPart === 'PLAYERS') type = 'THE PLAYERS';
             else if (firstPart === 'MAIN') type = 'FED EX';
             else type = firstPart;
        }

        // Hľadanie dátumovej časti (obsahuje pomlčku a čísla, napr. 2024-01-05)
        let datePartIndex = parts.findIndex(p => p.includes('-') && /\d/.test(p));
        
        if (datePartIndex !== -1) {
            // Formát s pomlčkami nájdený
            const datePart = parts[datePartIndex];
            const d = datePart.split('-');
            season = d[0];
            if (d.length >= 3) { 
                eventNum = parseInt(d[1]); // Toto je číslo pre obrázok (napr. 01)
                week = parseInt(d[2]); 
            } else if (d.length === 2) { 
                week = parseInt(d[1]); 
            }
            
            // Názov turnaja je všetko za dátumom
            if (parts.length > datePartIndex + 1) {
                eventName = parts.slice(datePartIndex + 1).join(' ');
            } else {
                eventName = `${type} ${season}-${eventNum}`;
            }
        } else {
            // Alternatívny formát: "01 Wisconsin Open.txt"
            // Ak prvá časť je číslo
            if (/^\d+$/.test(parts[0])) {
                eventNum = parseInt(parts[0]);
                eventName = parts.slice(1).join(' ');
                // Ak neurčený typ, defaultne PGA ak nie je inak
                if (type === 'UNKNOWN') type = 'PGA'; 
            }
        }
        
        // Final fallback ak typ nebol najdeny
        if (type === 'UNKNOWN') type = 'PGA';

        // Pridanie značiek do názvu eventu pre interné zobrazenie
        if (isImportant) eventName += '!';
        else if (isSignificant) eventName += '=';

        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const players = [];
        
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].startsWith('[source')) continue;
            if (lines[i].startsWith('}')) continue;
            
            let name = lines[i];
            if (!lines[i+1] || isNaN(parseInt(lines[i+1]))) { if(i + 6 >= lines.length) break; }
            
            let par = parseInt(lines[i+1]) || 0;
            let r1 = lines[i+2]; let r2 = lines[i+3]; let r3 = lines[i+4]; let r4 = lines[i+5];
            let pts = parseFloat(lines[i+6]) || 0;
            
            if (pts === undefined) break;
            
            players.push({ name: name, par: par, r1: r1, r2: r2, r3: r3, r4: r4, points: pts, rank: 0 });
            i += 6;
        }
        
        players.sort((a, b) => { if (a.points !== b.points) return b.points - a.points; return a.par - b.par; });
        for (let i = 0; i < players.length; i++) {
            if (i > 0 && players[i].points === players[i-1].points) players[i].rank = players[i-1].rank;
            else players[i].rank = i + 1;
        }
        
        db.files = db.files.filter(f => f.name !== filename); 
        db.files.push({ 
            id: Date.now() + Math.random(), 
            name: filename, 
            type: type, 
            season: season, 
            week: week, 
            eventNum: eventNum, // Kľúčové pre obrázok trofeje
            eventName: eventName, 
            isImportant: isImportant, 
            isSignificant: isSignificant, 
            timestamp: Date.now(), 
            content: players 
        });
    }

    function handleSeasonFiles(files) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                parseSeasonTxt(file.name, e.target.result);
                calculateGlobalAchievements();
                saveAuto();
                alert(`Sezónne štatistiky z "${file.name}" boli úspešne nahrané.`);
            };
            reader.readAsText(file);
        });
        document.getElementById('seasonFileInput').value = '';
    }

    function parseSeasonTxt(filename, text) {
        let season = '0';
        const match = filename.match(/(\d+)/);
        if (match) season = match[1];
        
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const seasonPlayers = [];
        let i = 0;
        
        while (i < lines.length) {
            if (lines[i].startsWith('[source') || lines[i].startsWith('}')) { i++; continue; }
            if (i + 7 >= lines.length) break;
            
            const name = lines[i];
            const aces = parseInt(lines[i+1]) || 0;
            const doubleEagles = parseInt(lines[i+2]) || 0;
            const eagles = parseInt(lines[i+3]) || 0;
            const birdies = parseInt(lines[i+4]) || 0;
            const pars = parseInt(lines[i+5]) || 0;
            const bogeys = parseInt(lines[i+6]) || 0;
            const doubleBogeys = parseInt(lines[i+7]) || 0;
            
            seasonPlayers.push({ name: name, stats: { aces, doubleEagles, eagles, birdies, pars, bogeys, doubleBogeys } });
            i += 8;
        }
        
        db.seasonStats = db.seasonStats.filter(s => s.season !== season);
        db.seasonStats.push({ season: season, filename: filename, content: seasonPlayers });
    }

    function normalizeName(name) { return name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
    
    function getDistance(a, b) {
        if(a.length === 0) return b.length; 
        if(b.length === 0) return a.length; 
        const matrix = [];
        for(let i = 0; i <= b.length; i++) matrix[i] = [i];
        for(let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for(let i = 1; i <= b.length; i++){
            for(let j = 1; j <= a.length; j++){
                if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
                else matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, matrix[i][j-1] + 1, matrix[i-1][j] + 1);
            }
        }
        return matrix[b.length][a.length];
    }
    
    function calculateGlobalAchievements() {
        // Inicializácia pamäte ak neexistuje (pre spätnú kompatibilitu)
        if (!appState.unlockedBadges) appState.unlockedBadges = {};

        window.globalBadgeHolders = {};
        achievementsDef.forEach(def => window.globalBadgeHolders[def.id] = []);
        const playerStats = {};
        const relevantFiles = [...db.files].sort(compareFiles);
        
        relevantFiles.forEach(f => {
            f.content.forEach(p => {
                let targetName = normalizeName(p.name);
                let foundKey = Object.keys(playerStats).find(k => k === targetName || getDistance(k, targetName) <= 1);
                
                if (!foundKey) {
                    foundKey = targetName;
                    playerStats[foundKey] = {
                        realName: p.name,
                        wins: 0, points: 0, top5: 0, top10: 0, top20: 0, cut: 0, tourneys: 0,
                        strokes: 0, holes: 0, sub60: false, sub65Count: 0, sub63Count: 0, pars: 0,
                        impWin: false, majWin: false, fedexWin: false, 
                        pgaWins: 0, eaWins: 0, kftWins: 0, playersWin: false, 
                        usOpen: false, theOpen: false,
                        maxCons: 0, currentStreak: 0,
                        maxTop10Streak: 0, currentTop10Streak: 0,
                        maxCutStreak: 0, currentCutStreak: 0,
                        secondPlaces: 0, thirdPlaces: 0,
                        ranksSum: 0,
                        r1Sum: 0, r1Count: 0, r4Sum: 0, r4Count: 0,
                        r1_80_cut: false, sub62R4: false,
                        majorTop10: 0,
                        fedexParticipations: 0,
                        maxPointsInEvent: 0,
                        worstCutRank: 0
                    };
                }
                
                const s = playerStats[foundKey];
                
                // Poznámka: Tu zatiaľ rátame VŠETKO, pretože achievementy ako "KFT Graduate"
                // potrebujú vedieť o KFT. Filtrácia pre RANKY sa deje v getOfficialRankList.
                
                s.tourneys++;
                s.points += p.points;
                s.pars += p.par;
                s.ranksSum += p.rank;
                if(p.points > s.maxPointsInEvent) s.maxPointsInEvent = p.points;
                
                if(p.points > 0) { 
                    s.cut++; 
                    s.currentCutStreak++;
                    if(s.currentCutStreak > s.maxCutStreak) s.maxCutStreak = s.currentCutStreak;
                    if(p.rank > s.worstCutRank) s.worstCutRank = p.rank;
                } else {
                    s.currentCutStreak = 0;
                }

                if(p.rank <= 20) s.top20++;
                
                if(p.rank <= 10) {
                    s.top10++;
                    s.currentTop10Streak++;
                    if(s.currentTop10Streak > s.maxTop10Streak) s.maxTop10Streak = s.currentTop10Streak;
                    if(f.isImportant || f.isSignificant) s.majorTop10++;
                } else {
                    s.currentTop10Streak = 0;
                }

                if(p.rank <= 5) s.top5++;
                if(p.rank === 2) s.secondPlaces++;
                if(p.rank === 3) s.thirdPlaces++;
                
                if(f.type === 'FED EX') s.fedexParticipations++;

                if(p.rank === 1) {
                    s.wins++;
                    s.currentStreak++;
                    if(s.currentStreak > s.maxCons) s.maxCons = s.currentStreak;
                    if(f.isImportant) s.impWin = true;
                    if(f.isSignificant) s.majWin = true;
                    
                    const en = f.eventNum;
                    if ([43, 44, 45].includes(en)) s.fedexWin = true;
                    if ([17, 20, 21, 28, 37, 39].includes(en)) s.eaWins++;
                    if (en === 18) s.playersWin = true;
                    if (en === 33) s.usOpen = true;
                    if (en === 38) s.theOpen = true;
                    
                    // KFT Win detekcia
                    if (f.type === 'KFT') s.kftWins++;
                    
                    if (
                        (en >= 10 && en <= 16) || en === 19 || (en >= 22 && en <= 27) ||
                        (en >= 29 && en <= 36) || en === 38 || (en >= 40 && en <= 42)
                    ) {
                        s.pgaWins++;
                    }
                } else {
                    s.currentStreak = 0;
                }

                let r1Val = 0, r3Val = 0, r4Val = 0;
                [p.r1, p.r2, p.r3, p.r4].forEach((r, idx) => {
                    if(r!=='NA') {
                        let v = parseInt(r);
                        s.strokes += v;
                        s.holes += 18;
                        if(v < 60) s.sub60 = true;
                        if(v < 65) s.sub65Count++;
                        if(v < 63) s.sub63Count++;
                        
                        if(idx === 0) { 
                            s.r1Sum += v; s.r1Count++; r1Val = v;
                            if(v >= 80 && p.points > 0) s.r1_80_cut = true;
                        }
                        if(idx === 2) r3Val = v;
                        if(idx === 3) { 
                            s.r4Sum += v; s.r4Count++; r4Val = v;
                            if(v < 62) s.sub62R4 = true;
                        }
                    }
                });
                
                if(r3Val > 0 && r4Val > 0 && (r3Val + r4Val) < 128) s.perfectWeekend = true;
            });
        });

        const seasonAgg = {};
        db.seasonStats.forEach(sFile => {
            sFile.content.forEach(p => {
                let targetName = normalizeName(p.name);
                let foundKey = Object.keys(playerStats).find(k => k === targetName || getDistance(k, targetName) <= 1);
                if(!foundKey) { foundKey = targetName; seasonAgg[foundKey] = { aces:0, eagles:0, birdies:0, pars:0, bogeys:0, doubleBogeys:0 }; }
                else if(!seasonAgg[foundKey]) { seasonAgg[foundKey] = { aces:0, eagles:0, birdies:0, pars:0, bogeys:0, doubleBogeys:0 }; }
                
                seasonAgg[foundKey].aces += (p.stats.aces || 0);
                seasonAgg[foundKey].eagles += (p.stats.eagles || 0);
                seasonAgg[foundKey].birdies += (p.stats.birdies || 0);
                seasonAgg[foundKey].pars += (p.stats.pars || 0);
                seasonAgg[foundKey].bogeys += (p.stats.bogeys || 0);
                seasonAgg[foundKey].doubleBogeys += (p.stats.doubleBogeys || 0);
            });
        });

        const offList = getOfficialRankList();
        const world1Name = offList && offList.length > 0 ? normalizeName(offList[0].name) : null;

        Object.keys(playerStats).forEach(key => {
            const stats = playerStats[key];
            const sStats = seasonAgg[key] || { aces:0, eagles:0, birdies:0, pars:0, bogeys:0, doubleBogeys:0 };
            const avgStrokes = stats.holes > 0 ? (stats.strokes / (stats.holes/18)) : 99;
            const avgPerHole = stats.holes > 0 ? (stats.strokes / stats.holes) : 99;
            const avgRank = stats.tourneys > 0 ? (stats.ranksSum / stats.tourneys) : 99;
            const avgPts = stats.tourneys > 0 ? (stats.points / stats.tourneys) : 0;
            
            const r1Avg = stats.r1Count > 0 ? (stats.r1Sum / stats.r1Count) : 99;
            const r4Avg = stats.r4Count > 0 ? (stats.r4Sum / stats.r4Count) : 99;
            
            const name = stats.realName;
            
            // --- UPRAVENÁ FUNKCIA CHECK (S PAMÄŤOU) ---
            const check = (id, condition) => { 
                const alreadyUnlocked = appState.unlockedBadges[name] && appState.unlockedBadges[name].includes(id);
                
                // Ak splnil podmienku TERAZ, alebo ju splnil KEDYKOĽVEK V MINULOSTI
                if(condition || alreadyUnlocked) { 
                    window.globalBadgeHolders[id].push(name); 
                    
                    // Ak to ešte nemáme zapísané v pamäti, zapíšeme to
                    if(condition && !alreadyUnlocked) {
                        if (!appState.unlockedBadges[name]) appState.unlockedBadges[name] = [];
                        appState.unlockedBadges[name].push(id);
                    }
                } 
            };
            
            check('shark', stats.wins >= 3);
            check('dominator', stats.wins >= 10);
            check('goat', stats.wins >= 20);
            check('imp_man', stats.impWin);
            check('maj_man', stats.majWin);
            check('maj_champ', stats.impWin && stats.majWin);
            check('trophy_hunt', stats.fedexWin);
            check('pga_king', stats.pgaWins >= 5);
            check('ea_game', stats.eaWins > 0);
            check('poty', stats.playersWin);
            check('world_1', world1Name && (key === world1Name || getDistance(key, world1Name) <= 1));
            check('master_all', stats.pgaWins>0 && stats.eaWins>0 && stats.playersWin && stats.fedexWin);
            check('us_champ', stats.usOpen);
            check('opener', stats.theOpen);
            check('defender', stats.maxCons >= 2);
            check('champion', stats.wins >= 15 && stats.fedexWin);
            check('high_roller', stats.points > 5000);
            check('tycoon', stats.points > 10000);
            check('legend', stats.points > 20000 && stats.wins >= 10);
            check('veteran', stats.tourneys >= 50);
            check('iron_man', stats.tourneys >= 100);
            check('immortal', stats.tourneys >= 200);
            check('marathon', stats.holes >= 5000);
            check('iron_hand', stats.holes >= 20000);
            check('sniper', sStats.aces >= 1);
            check('eagle_eye', sStats.eagles >= 20);
            check('albatross', sStats.eagles >= 50);
            check('birdie_mach', sStats.birdies >= 100);
            check('birdie_king', sStats.birdies >= 200);
            check('par_master', sStats.pars >= 1000);
            check('elite', stats.top5 >= 10);
            check('podium', stats.top5 >= 20);
            check('consistency', stats.top20 >= 30);
            check('top10_reg', stats.top20 >= 50);
            check('cut_master', stats.cut >= 50);
            check('survivor', stats.cut >= 100);
            check('sub62', stats.sub62); 
            check('scratch', avgStrokes < 69.9);
            check('safe_play', sStats.bogeys > 0 && sStats.pars >= (sStats.bogeys * 20));
            check('aggressive', sStats.birdies > sStats.pars);
            check('player_badge', stats.playersWin || (stats.tourneys >= 1 && db.files.some(f => f.type==='THE PLAYERS' && f.content.some(px=>normalizeName(px.name)===key))));
            check('under_par', stats.pars < -50);
            check('solid', avgPerHole < 3.90);
            check('never_back', stats.r1_80_cut);
            check('lucky7', stats.top5 >= 7 && stats.wins >= 1);
            check('ea_grad', stats.eaWins >= 2);
            check('ea_legend', stats.eaWins >= 3);
            check('grand_slam', stats.pgaWins > 0 && stats.fedexWins > 0 && stats.eaWins > 0);
            check('silver_col', stats.secondPlaces >= 5);
            check('bronze_col', stats.thirdPlaces >= 5);
            check('mr_59', stats.sub60); 
            check('club_65', stats.sub65Count >= 10);
            check('sunday_roaring', stats.r4Count >= 5 && r4Avg < 68.0);
            check('fast_starter', stats.r1Count >= 5 && r1Avg < 68.0);
            check('comeback_king', stats.r1Count >= 5 && stats.r4Count >= 5 && (r1Avg - r4Avg) >= 2);
            check('heating_up', stats.maxTop10Streak >= 3);
            check('on_fire', stats.maxTop10Streak >= 5);
            check('cut_streak', stats.maxCutStreak >= 10);
            check('invincible', stats.maxCutStreak >= 20);
            check('top_percent', stats.tourneys >= 10 && (stats.top5 / stats.tourneys) >= 0.40);
            check('birdie_god', sStats.birdies >= 500);
            check('eagle_nest', sStats.eagles >= 10);
            check('par_hoarder', sStats.pars >= 2000);
            check('sniper_elite', sStats.aces >= 3);
            check('clean_sheet', sStats.birdies > sStats.bogeys);
            check('pts_millionaire', stats.points > 50000);
            check('efficiency', stats.tourneys >= 10 && avgPts > 100);
            check('journeyman', stats.tourneys >= 50 && stats.wins === 0);
            check('one_hit', stats.tourneys >= 50 && stats.wins === 1);
            check('grinder', sStats.pars > 3000);
            check('risk_taker', sStats.eagles > sStats.doubleBogeys && sStats.eagles > 0);
            check('glass_chin', stats.r1Count >= 5 && stats.r4Count >= 5 && (r4Avg - r1Avg) >= 2);
            check('weekend_warrior', stats.cut >= 5 && stats.worstCutRank >= 60);
            check('bridesmaid', stats.wins === 0 && (stats.secondPlaces + stats.thirdPlaces) >= 10);
            check('major_top10', stats.majorTop10 >= 5);
            check('club_63', stats.sub63Count >= 5);
            check('mr_consistent', stats.tourneys >= 20 && avgRank <= 15.0);
            check('the_1_percent', world1Name && (key === world1Name || getDistance(key, world1Name) <= 1) && stats.fedexWin && stats.playersWin);
            check('grand_finish', stats.sub62R4);
            check('no_bogeys', sStats.bogeys > 0 && (sStats.pars / sStats.bogeys) > 30);
            check('perfect_weekend', stats.perfectWeekend); 
            check('fedex_regular', stats.fedexParticipations >= 3);
            check('scrambler', sStats.pars < 500 && sStats.birdies > 200);
            check('top50_machine', (stats.cut + stats.top20) >= 80); 
            check('lucky_number', stats.maxPointsInEvent >= 777);
        });
        
        Object.keys(window.globalBadgeHolders).forEach(k => window.globalBadgeHolders[k].sort());
        // Uložíme zmeny do localStorage, aby sa nestratili pri refreshi
        saveAuto();
    }


    // --- Helper Functions ---
    function getActiveFiles() {
        let files = db.files;
        if (!appState.filters.tours.includes('ALL')) files = files.filter(f => appState.filters.tours.includes(f.type));
        if (appState.filters.events.length > 0) files = files.filter(f => appState.filters.events.includes(f.eventName));
        if (appState.filters.seasons.length > 0) files = files.filter(f => appState.filters.seasons.includes(f.season));
        if (appState.filters.importance && appState.filters.importance !== 'ALL') {
            if (appState.filters.importance === 'CLASSIC') files = files.filter(f => !f.isImportant && !f.isSignificant);
            else if (appState.filters.importance === 'IMPORTANT') files = files.filter(f => f.isImportant);
            else if (appState.filters.importance === 'SIGNIFICANT') files = files.filter(f => f.isSignificant);
        }
        return files;
    }

    function compareFiles(a, b) {
        if (parseInt(a.season) !== parseInt(b.season)) return parseInt(a.season) - parseInt(b.season);
        if (a.eventNum !== b.eventNum) return a.eventNum - b.eventNum;
        if (a.week !== b.week) return a.week - b.week;
        return a.timestamp - b.timestamp;
    }
    
    function getAggregatedStats() {
        const files = getActiveFiles();
        const playerMap = {};
        const sortedFilesForForm = [...files].sort(compareFiles);
        const latestFile = sortedFilesForForm[sortedFilesForForm.length - 1];

        files.forEach(file => {
            file.content.forEach(p => {
                let targetName = p.name;
                const normNew = normalizeName(targetName);
                
                for (let existingName in playerMap) {
                    const normExisting = normalizeName(existingName);
                    if (normNew === normExisting || getDistance(normNew, normExisting) <= 1) {
                        targetName = existingName;
                        break;
                    }
                }
                
                if (!playerMap[targetName]) {
                    playerMap[targetName] = {
                        name: targetName,
                        totalPar: 0,
                        totalPoints: 0,
                        totalStrokes: 0,
                        totalHoles: 0,
                        rounds: [],
                        bestRound: 999,
                        worstRound: -999,
                        weeksPlayed: 0,
                        cut: 0,
                        top20: 0,
                        top5: 0,
                        wins: 0,
                        lastRank: null, 
                        ranks: [] 
                    };
                }
                
                const entry = playerMap[targetName];
                entry.totalPar += p.par;
                entry.totalPoints += p.points;
                entry.weeksPlayed++; 
                entry.ranks.push(p.rank);
                
                if (latestFile && file.id === latestFile.id) {
                    entry.lastRank = p.rank;
                }
                
                if (p.points > 0) entry.cut++;
                if (p.rank <= 20) entry.top20++;
                if (p.rank <= 5) entry.top5++;
                if (p.rank === 1) entry.wins++;
                
                [p.r1, p.r2, p.r3, p.r4].forEach(r => {
                    if (r !== 'NA') {
                        const val = parseInt(r);
                        entry.totalStrokes += val;
                        entry.totalHoles += 18;
                        entry.rounds.push(val);
                        if (val < entry.bestRound) entry.bestRound = val;
                        if (val > entry.worstRound) entry.worstRound = val;
                    }
                });
            });
        });

        let arr = Object.values(playerMap);
        arr.forEach(p => {
            p.strokeAvg = p.totalHoles > 0 ? (p.totalStrokes / (p.totalHoles/18)).toFixed(2) : '-';
            
            if (p.lastRank !== null && p.ranks.length > 1) {
                const sumRanks = p.ranks.reduce((a, b) => a + b, 0);
                const avgRank = sumRanks / p.ranks.length;
                if (p.lastRank < avgRank - 3) p.form = '⬆️'; 
                else if (p.lastRank > avgRank + 3) p.form = '⬇️'; 
                else p.form = '➡️';
            } else {
                p.form = '-';
            }
        });
        
        arr = sortData(arr);
        
        // Pridanie Table Rank
        const rankedArr = [...arr].sort((a, b) => b.totalPoints - a.totalPoints);
        const rankMap = {};
        rankedArr.forEach((p, i) => {
            if (i > 0 && p.totalPoints === rankedArr[i-1].totalPoints) {
                rankMap[p.name] = rankMap[rankedArr[i-1].name];
            } else {
                rankMap[p.name] = i + 1;
            }
        });
        arr.forEach(p => p.tableRank = rankMap[p.name]);
        
        return arr;
    }

    function sortData(data) {
        const col = appState.sort.column;
        const dir = appState.sort.dir === 'asc' ? 1 : -1;
        return data.sort((a, b) => {
            let valA = a[col];
            let valB = b[col];
            if (col === 'bestRound' && valA === 999) valA = Infinity;
            if (col === 'bestRound' && valB === 999) valB = Infinity;
            if (col === 'worstRound' && valA === -999) valA = -Infinity;
            if (col === 'worstRound' && valB === -999) valB = -Infinity;
            if (['strokeAvg'].includes(col)) {
                 valA = valA === '-' ? 999 : parseFloat(valA);
                 valB = valB === '-' ? 999 : parseFloat(valB);
            }
            if (col === 'form') return (valA || '').localeCompare(valB || '') * dir;
            if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
            return (valA - valB) * dir;
        });
    }
    // --- Ranking Algorithms ---
    function getPGARankList() {
        // FILTER: Ignorovať KFT
        let pgaFiles = db.files.filter(f => f.type === 'PGA');
        pgaFiles.sort((a, b) => compareFiles(b, a)); 
        const last40 = pgaFiles.slice(0, 40);
        const playerPoints = {};
        last40.forEach((file, index) => {
            let recencyCoeff = 1.25;
            if (index < 10) recencyCoeff = 2.0;
            else if (index < 20) recencyCoeff = 1.75;
            else if (index < 30) recencyCoeff = 1.5;
            let importanceCoeff = 1;
            if (file.isImportant) importanceCoeff = 5;
            else if (file.isSignificant) importanceCoeff = 2;
            const totalMultiplier = recencyCoeff * importanceCoeff;
            file.content.forEach(p => {
                let name = normalizePlayerName(p.name, playerPoints);
                if (!playerPoints[name]) playerPoints[name] = 0;
                playerPoints[name] += (p.points * totalMultiplier);
            });
        });
        return createRankedList(playerPoints);
    }

    function getOfficialRankList() {
        // FILTER: Ignorovať KFT
        const relevantFiles = db.files.filter(f => f.type !== 'KFT');
        if (relevantFiles.length <= 20) return null; 
        const playerPoints = {};
        relevantFiles.forEach(file => {
            file.content.forEach(p => {
                let name = normalizePlayerName(p.name, playerPoints);
                if (!playerPoints[name]) playerPoints[name] = 0;
                playerPoints[name] += p.points;
            });
        });
        return createRankedList(playerPoints);
    }

    function getTourRankList() {
        const playerPoints = {};
        // FILTER: KFT sa neráta do Tour Ranku
        db.files.filter(f => f.type !== 'KFT').forEach(file => {
            let coeff = 0;
            if (file.isImportant) coeff = 2;
            else if (file.isSignificant) coeff = 1;
            if (coeff > 0) {
                file.content.forEach(p => {
                    let name = normalizePlayerName(p.name, playerPoints);
                    if (!playerPoints[name]) playerPoints[name] = 0;
                    playerPoints[name] += (p.points * coeff);
                });
            }
        });
        return createRankedList(playerPoints);
    }

    function getEARankList() {
        const relevantFiles = db.files.filter(f => f.type === 'EA SPORTS' || f.type === 'FED EX');
        const playerPoints = {};
        relevantFiles.forEach(file => {
            file.content.forEach(p => {
                let name = normalizePlayerName(p.name, playerPoints);
                if (!playerPoints[name]) playerPoints[name] = 0;
                playerPoints[name] += p.points;
            });
        });
        return createRankedList(playerPoints);
    }

    function getAssociationRankList() {
        let relevantFiles = db.files.filter(f => f.type === 'THE PLAYERS');
        relevantFiles.sort((a, b) => compareFiles(b, a)); 
        relevantFiles = relevantFiles.slice(0, 10);
        const playerPoints = {};
        relevantFiles.forEach(file => {
            file.content.forEach(p => {
                let name = normalizePlayerName(p.name, playerPoints);
                if (!playerPoints[name]) playerPoints[name] = 0;
                playerPoints[name] += p.points;
            });
        });
        return createRankedList(playerPoints);
    }

    function getFedExRankList() {
        // KFT sa do FED EX neráta
        const validTypes = ['PGA', 'EA SPORTS', 'THE PLAYERS', 'FED EX'];
        const seasons = db.files.map(f => parseInt(f.season));
        if (seasons.length === 0) return null;
        const maxSeason = Math.max(...seasons);
        const relevantFiles = db.files.filter(f => validTypes.includes(f.type) && parseInt(f.season) === maxSeason);
        const playerPoints = {};
        relevantFiles.forEach(file => {
            file.content.forEach(p => {
                let name = normalizePlayerName(p.name, playerPoints);
                if (!playerPoints[name]) playerPoints[name] = 0;
                playerPoints[name] += p.points;
            });
        });
        return createRankedList(playerPoints);
    }
    
    // --- NOVÁ FUNKCIA PRE AMATEUR RANK (KFT) ---
    function getAmateurRankList() {
        const relevantFiles = db.files.filter(f => f.type === 'KFT');
        const playerPoints = {};
        relevantFiles.forEach(file => {
            file.content.forEach(p => {
                let name = normalizePlayerName(p.name, playerPoints);
                if (!playerPoints[name]) playerPoints[name] = 0;
                playerPoints[name] += p.points;
            });
        });
        return createRankedList(playerPoints);
    }

    function normalizePlayerName(name, existingMap) {
        const normNew = normalizeName(name);
        for (let key in existingMap) {
            if (normalizeName(key) === normNew || getDistance(normNew, normalizeName(key)) <= 1) {
                return key;
            }
        }
        return name;
    }

    function createRankedList(pointsMap) {
        const arr = Object.entries(pointsMap).map(([name, points]) => ({ name, points }));
        arr.sort((a, b) => b.points - a.points);
        let currentRank = 1;
        arr.forEach((p, i) => {
            if (i > 0 && p.points === arr[i-1].points) {
                p.rank = arr[i-1].rank;
            } else {
                p.rank = i + 1;
            }
        });
        return arr;
    }

    // --- Render Functions ---
    function renderApp() {
        renderFilters();
        renderTable();
    }

    function renderFilters() {
        ['ALL', 'KFT', 'PGA', 'EA SPORTS', 'THE PLAYERS', 'FED EX'].forEach(t => {
            const btn = document.getElementById(`btn-tour-${t}`);
            if(btn) {
                if (t === 'ALL') btn.className = `filter-btn ${appState.filters.tours.includes('ALL') ? 'active' : ''}`;
                else btn.className = `filter-btn ${appState.filters.tours.includes(t) ? 'active' : ''}`;
            }
        });

        const importanceDropdown = document.getElementById('importanceDropdown');
        importanceDropdown.innerHTML = '';
        
        const importanceOptions = [
            { key: 'ALL', label: 'Všetky' },
            { key: 'CLASSIC', label: 'Klasické' },
            { key: 'IMPORTANT', label: 'Dôležité (!)' },
            { key: 'SIGNIFICANT', label: 'Významné (=)' }
        ];

        importanceOptions.forEach(opt => {
            const btn = document.createElement('button');
            const isActive = appState.filters.importance === opt.key;
            btn.className = `filter-btn ${isActive ? 'active' : ''}`;
            if (opt.key === 'IMPORTANT') btn.classList.add('important-tour');
            if (opt.key === 'SIGNIFICANT') btn.classList.add('significant-tour');
            
            btn.style.width = '100%';
            btn.style.marginBottom = '5px';
            btn.innerText = opt.label;
            btn.onclick = (e) => { e.stopPropagation(); setImportanceFilter(opt.key); };
            importanceDropdown.appendChild(btn);
        });

        const impLabel = document.getElementById('importanceFilterLabel');
        const activeImp = importanceOptions.find(o => o.key === appState.filters.importance);
        impLabel.innerText = activeImp ? activeImp.label : 'Všetky';

        if (appState.ui.importanceDropdownOpen) importanceDropdown.classList.add('show');
        else importanceDropdown.classList.remove('show');

        const seasonDropdown = document.getElementById('seasonDropdown');
        seasonDropdown.innerHTML = '';
        
        const fileSeasons = db.files.map(f => f.season);
        const statsSeasons = db.seasonStats.map(s => s.season);
        const allSeasonsSet = new Set([...fileSeasons, ...statsSeasons]);
        
        const availableSeasons = [...allSeasonsSet].filter(s => s !== '00' && s !== '0').sort((a,b) => parseInt(a) - parseInt(b));
        
        const allSeasonsBtn = document.createElement('button');
        allSeasonsBtn.className = `filter-btn ${appState.filters.seasons.length === 0 ? 'active' : ''}`;
        allSeasonsBtn.innerText = 'Všetky';
        allSeasonsBtn.style.width = '100%';
        allSeasonsBtn.style.marginBottom = '5px';
        allSeasonsBtn.onclick = (e) => { e.stopPropagation(); appState.filters.seasons = []; renderApp(); saveAuto(); };
        seasonDropdown.appendChild(allSeasonsBtn);

        availableSeasons.forEach(s => {
            const btn = document.createElement('button');
            const isActive = appState.filters.seasons.includes(s);
            btn.className = `filter-btn ${isActive ? 'active' : ''}`;
            btn.innerText = `Sezóna ${s}`;
            btn.style.width = '100%';
            btn.style.marginBottom = '5px';
            btn.onclick = (e) => { e.stopPropagation(); toggleSeasonFilter(s); };
            seasonDropdown.appendChild(btn);
        });

        const seasonLabel = document.getElementById('seasonFilterLabel');
        if (appState.filters.seasons.length === 0) seasonLabel.innerText = "Všetky";
        else if (appState.filters.seasons.length === 1) seasonLabel.innerText = `Sezóna ${appState.filters.seasons[0]}`;
        else seasonLabel.innerText = `Vybrané (${appState.filters.seasons.length})`;

        if (appState.ui.seasonDropdownOpen) seasonDropdown.classList.add('show');
        else seasonDropdown.classList.remove('show');

        const eventDropdown = document.getElementById('eventDropdown');
        eventDropdown.innerHTML = '';
        
        let filesForDropdown = db.files;
        if (!appState.filters.tours.includes('ALL')) {
            filesForDropdown = filesForDropdown.filter(f => appState.filters.tours.includes(f.type));
        }
        
        if (appState.filters.seasons.length > 0) {
            filesForDropdown = filesForDropdown.filter(f => appState.filters.seasons.includes(f.season));
        }
        if (appState.filters.importance !== 'ALL') {
             if (appState.filters.importance === 'CLASSIC') filesForDropdown = filesForDropdown.filter(f => !f.isImportant && !f.isSignificant);
             else if (appState.filters.importance === 'IMPORTANT') filesForDropdown = filesForDropdown.filter(f => f.isImportant);
             else if (appState.filters.importance === 'SIGNIFICANT') filesForDropdown = filesForDropdown.filter(f => f.isSignificant);
        }

        const sortedFiles = [...filesForDropdown].sort(compareFiles);
        const uniqueEvents = [];
        const seenEvents = new Set();
        
        sortedFiles.forEach(f => {
            if (!seenEvents.has(f.eventName)) {
                seenEvents.add(f.eventName);
                uniqueEvents.push({ name: f.eventName, isImp: f.isImportant, isSig: f.isSignificant });
            }
        });

        uniqueEvents.forEach(evtObj => {
            const btn = document.createElement('button');
            const isActive = appState.filters.events.includes(evtObj.name);
            let classes = `filter-btn ${isActive ? 'active' : ''}`;
            if (evtObj.isImp) classes += ' important-tour';
            else if (evtObj.isSig) classes += ' significant-tour';
            
            btn.className = classes;
            btn.style.width = '100%';
            btn.style.marginBottom = '5px';
            btn.innerText = evtObj.name;
            btn.onclick = (e) => { e.stopPropagation(); toggleEventFilter(evtObj.name); };
            eventDropdown.appendChild(btn);
        });
        
        const eventLabel = document.getElementById('eventFilterLabel');
        if (appState.filters.events.length === 0) eventLabel.innerText = "Všetky turnaje";
        else if (appState.filters.events.length === 1) eventLabel.innerText = appState.filters.events[0];
        else eventLabel.innerText = `Vybrané (${appState.filters.events.length})`;

        if (appState.ui.eventDropdownOpen) eventDropdown.classList.add('show');
        else eventDropdown.classList.remove('show');

        const weeksContainer = document.getElementById('weeksContainer');
        const weekToggleBtn = document.getElementById('weekToggleBtn');
        
        if (appState.ui.showWeeks) {
            weeksContainer.style.display = 'flex';
            weeksContainer.innerHTML = '';
            weekToggleBtn.innerText = 'Skryť konkrétne týždne';
            weekToggleBtn.classList.add('active');

            const weekFiles = [...getActiveFiles()].sort((a, b) => compareFiles(b, a));
            
            weekFiles.forEach(f => {
                const btn = document.createElement('button');
                const isActive = appState.filters.activeWeek === f.id;
                let label = f.name.replace('.txt', '');
                
                if (f.isImportant) {
                    label = '★ ' + label;
                    btn.classList.add('important-tour');
                } else if (f.isSignificant) {
                    label = '= ' + label;
                    btn.classList.add('significant-tour');
                }

                btn.className = `filter-btn ${isActive ? 'active' : ''}`;
                if (f.isImportant) btn.classList.add('important-tour');
                else if (f.isSignificant) btn.classList.add('significant-tour');
                
                btn.style.fontSize = '0.8rem';
                btn.innerText = label;
                btn.onclick = () => toggleWeekSelection(f.id);
                weeksContainer.appendChild(btn);
            });
        } else {
            weeksContainer.style.display = 'none';
            weekToggleBtn.innerText = 'Zobraziť konkrétne týždne (Súbory)';
            weekToggleBtn.classList.remove('active');
        }
    }

    function renderTable() {
        const thead = document.querySelector('#mainTable thead');
        const tbody = document.querySelector('#mainTable tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        let columns = [];
        let data = [];

        if (appState.filters.activeWeek && appState.ui.showWeeks) {
            const file = db.files.find(f => f.id === appState.filters.activeWeek);
            if (!file) return;
            data = [...file.content]; 
            
            const col = appState.sort.column;
            const dir = appState.sort.dir === 'asc' ? 1 : -1;
            data.sort((a,b) => {
                 let valA = a[col] || 0; let valB = b[col] || 0;
                 if (['r1','r2','r3','r4'].includes(col)) {
                    valA = valA === 'NA' ? 999 : parseInt(valA);
                    valB = valB === 'NA' ? 999 : parseInt(valB);
                 }
                 if(col === 'name') return valA.localeCompare(valB) * dir;
                 return (valA - valB) * dir;
            });

            columns = [
                { key: 'rank', label: 'Poz.' },
                { key: 'name', label: 'Meno' },
                { key: 'par', label: 'Par' },
                { key: 'r1', label: 'R1' },
                { key: 'r2', label: 'R2' },
                { key: 'r3', label: 'R3' },
                { key: 'r4', label: 'R4' },
                { key: 'points', label: 'Body' }
            ];
        } else {
            data = getAggregatedStats();
            columns = [
                { key: 'tableRank', label: 'Poz.' },
                { key: 'name', label: 'Meno' },
                { key: 'form', label: 'Forma' },
                { key: 'totalPar', label: 'Par' },
                { key: 'weeksPlayed', label: 'Turnaje' },
                { key: 'totalPoints', label: 'Body' },
                { key: 'totalStrokes', label: 'Odpaly' },
                { key: 'totalHoles', label: 'Jamky' },
                { key: 'strokeAvg', label: 'Priem. Úd.' },
                { key: 'cut', label: 'Cut' },
                { key: 'top20', label: 'Top 20' },
                { key: 'top5', label: 'Top 5' },
                { key: 'wins', label: 'Výhry' }
            ];
        }

        const trH = document.createElement('tr');
        columns.forEach(col => {
            const th = document.createElement('th');
            th.innerText = col.label;
            if (appState.sort.column === col.key) {
                th.innerText += appState.sort.dir === 'asc' ? ' ▲' : ' ▼';
            }
            th.onclick = () => changeSort(col.key);
            trH.appendChild(th);
        });
        thead.appendChild(trH);

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'player-row';
            tr.onclick = () => openPlayerProfile(row.name);

            columns.forEach(col => {
                const td = document.createElement('td');
                let val = row[col.key];
                
                if (col.key === 'totalPoints') val = val.toFixed(3);
                if (col.key === 'bestRound' && val === 999) val = '-';
                if (col.key === 'worstRound' && val === -999) val = '-';
                
                if (col.key === 'wins' && val > 0) td.style.color = 'var(--highlight-gold)';
                if (col.key === 'top5' && val > 0) td.style.color = 'var(--accent-blue)';
                
                td.innerText = val !== undefined ? val : '-';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        // --- ZAČIATOK: ŠTATISTIKA POČTU HRÁČOV (Footer) ---
        if (data.length > 0) {
            // 1. Zistíme zoznam všetkých PRO hráčov z celej databázy
            const proToursList = ['PGA', 'EA SPORTS', 'THE PLAYERS', 'FED EX'];
            const globalProNames = new Set();
            
            db.files.forEach(f => {
                if (proToursList.includes(f.type)) {
                    f.content.forEach(p => globalProNames.add(normalizeName(p.name)));
                }
            });

            // 2. Spočítame počty len pre aktuálne zobrazených hráčov v tabuľke
            let countPro = 0;
            let countAm = 0;
            
            data.forEach(p => {
                const n = normalizeName(p.name);
                // Kontrola: Ak je v zozname PRO mien, alebo sa naň veľmi podobá (preklepy)
                let isPro = false;
                if (globalProNames.has(n)) {
                    isPro = true;
                } else {
                    // Fuzzy kontrola pre istotu (ak by bolo meno v DB mierne inak zapísané)
                    for (let proName of globalProNames) {
                        if (getDistance(n, proName) <= 1) { isPro = true; break; }
                    }
                }

                if (isPro) countPro++;
                else countAm++;
            });

            // 3. Vytvoríme spodný riadok tabuľky
            const footerTr = document.createElement('tr');
            footerTr.style.backgroundColor = '#252525';
            footerTr.style.borderTop = '2px solid #555';
            
            const footerTd = document.createElement('td');
            footerTd.colSpan = columns.length; // Roztiahnuť cez všetky stĺpce
            footerTd.style.textAlign = 'center';
            footerTd.style.padding = '15px';
            footerTd.style.fontSize = '0.9rem';
            
            footerTd.innerHTML = `
                <span style="display:inline-block; margin: 0 15px; padding: 5px 10px; background:rgba(255,255,255,0.05); border-radius:6px;">
                    Počet Hráčov: <strong style="color:var(--text-main); font-size:1.1em;">${data.length}</strong>
                </span>
                <span style="display:inline-block; margin: 0 15px; padding: 5px 10px; background:rgba(241, 196, 15, 0.1); border-radius:6px; border:1px solid rgba(241, 196, 15, 0.3);">
                    Počet Profesionálov: <strong style="color:var(--highlight-gold); font-size:1.1em;">${countPro}</strong>
                </span>
                <span style="display:inline-block; margin: 0 15px; padding: 5px 10px; background:rgba(255,255,255,0.05); border-radius:6px;">
                    Počet Amatérov: <strong style="color:#bdc3c7; font-size:1.1em;">${countAm}</strong>
                </span>
            `;
            
            footerTr.appendChild(footerTd);
            tbody.appendChild(footerTr);
        }
        // --- KONIEC: ŠTATISTIKA POČTU HRÁČOV ---

    }
    // --- UI Actions ---
    function changeSort(col) {
        if (appState.sort.column === col) {
            appState.sort.dir = appState.sort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            appState.sort.column = col;
            appState.sort.dir = 'desc'; 
            if (['rank', 'tableRank', 'par', 'totalPar', 'strokeAvg', 'bestRound'].includes(col)) {
                appState.sort.dir = 'asc'; 
            }
        }
        renderTable();
    }

    function setTourFilter(mode) {
        if (mode === 'ALL') appState.filters.tours = ['ALL'];
        else {
            if (appState.filters.tours.includes('ALL')) appState.filters.tours = [];
            const idx = appState.filters.tours.indexOf(mode);
            if (idx > -1) appState.filters.tours.splice(idx, 1);
            else appState.filters.tours.push(mode);
            if (appState.filters.tours.length === 0) appState.filters.tours = ['ALL'];
        }
        renderApp();
        saveAuto();
    }

    function toggleEventDropdown() { appState.ui.eventDropdownOpen = !appState.ui.eventDropdownOpen; renderFilters(); }
    function toggleSeasonDropdown() { appState.ui.seasonDropdownOpen = !appState.ui.seasonDropdownOpen; renderFilters(); }
    function toggleImportanceDropdown() { appState.ui.importanceDropdownOpen = !appState.ui.importanceDropdownOpen; renderFilters(); }

    function toggleEventFilter(evtName) {
        const idx = appState.filters.events.indexOf(evtName);
        if (idx > -1) appState.filters.events.splice(idx, 1);
        else appState.filters.events.push(evtName);
        renderApp();
        saveAuto();
    }

    function toggleSeasonFilter(s) {
        const idx = appState.filters.seasons.indexOf(s);
        if (idx > -1) appState.filters.seasons.splice(idx, 1);
        else appState.filters.seasons.push(s);
        renderApp();
        saveAuto();
    }

    function setImportanceFilter(mode) { appState.filters.importance = mode; renderApp(); saveAuto(); }
    function toggleWeekView() { appState.ui.showWeeks = !appState.ui.showWeeks; appState.filters.activeWeek = null; renderApp(); saveAuto(); }

    function toggleWeekSelection(id) {
        if (appState.filters.activeWeek === id) appState.filters.activeWeek = null;
        else appState.filters.activeWeek = id;
        appState.sort = { column: 'points', dir: 'desc' };
        renderTable();
        renderFilters();
    }

    function handleSearch(val) {
        const results = document.getElementById('searchResults');
        if (!val) { results.style.display = 'none'; return; }
        const normVal = normalizeName(val);
        const players = new Set();
        db.files.forEach(f => f.content.forEach(p => players.add(p.name)));
        const matches = [...players].filter(name => normalizeName(name).includes(normVal));
        results.innerHTML = '';
        if (matches.length > 0) {
            results.style.display = 'block';
            matches.slice(0, 10).forEach(m => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerText = m;
                div.onclick = () => {
                    openPlayerProfile(m);
                    results.style.display = 'none';
                    document.getElementById('playerSearch').value = '';
                };
                results.appendChild(div);
            });
        } else {
            results.style.display = 'none';
        }
    }
    // --- Player Profile (UPDATED FOR IMAGE TROPHIES) ---
    function openPlayerProfile(playerName) {
        const modalId = 'profile-' + Date.now();
        const html = generateProfileHtml(playerName, 'ALL', modalId, [], []);
        createModal(html, modalId);
    }

    window.updateProfileFilters = function(modalId, playerName, tab, eventsString, seasonsString) {
        const events = eventsString ? JSON.parse(decodeURIComponent(eventsString)) : [];
        const seasons = seasonsString ? JSON.parse(decodeURIComponent(seasonsString)) : [];
        const contentDiv = document.getElementById(modalId);
        if(contentDiv) {
            const modalBody = generateProfileHtml(playerName, tab, modalId, events, seasons, true);
            contentDiv.innerHTML = modalBody;
        }
    }

    function generateProfileHtml(playerName, tab, modalId, activeEvents = [], activeSeasons = [], innerOnly = false) {
        let relevantFiles = db.files;
        if (tab !== 'ALL') relevantFiles = relevantFiles.filter(f => f.type === tab);
        if (activeEvents.length > 0) relevantFiles = relevantFiles.filter(f => activeEvents.includes(f.eventName));
        if (activeSeasons.length > 0) relevantFiles = relevantFiles.filter(f => activeSeasons.includes(f.season));

        const normPlayer = normalizeName(playerName);
        let realPlayerName = playerName;
        for(let key in window.globalBadgeHolders) {
             const found = window.globalBadgeHolders[key].find(n => normalizeName(n) === normPlayer);
             if(found) { realPlayerName = found; break; }
        }

        let stats = {
            totalHoles: 0, totalStrokes: 0, totalPar: 0, totalPoints: 0,
            tournamentCount: 0, majorCount: 0, majorPoints: 0,
            bestRank: 999, rankSum: 0, rankCount: 0,
            bestRound: 999, worstRound: -999,
            cut: 0, top20: 0, top5: 0, wins: 0, trophies: 0,
            secondPlaces: 0, thirdPlaces: 0,
            r1Sum: 0, r1Count: 0, r2Sum: 0, r2Count: 0, r3Sum: 0, r3Count: 0, r4Sum: 0, r4Count: 0,
            history: [], rounds: [],
            h2h: {} 
        };
        
        let uniqueEvents = new Set();
        let uniqueMajors = new Set();
        let graphData = [];
        let trophyCollection = [];

        // Preload ranks...
        const pgaList = getPGARankList();
        const officialList = getOfficialRankList();
        const tourList = getTourRankList();
        const eaList = getEARankList();
        const assocList = getAssociationRankList();
        const fedexList = getFedExRankList();
        const amateurList = getAmateurRankList(); // Pridaný Amateur Rank
        
        const getRank = (list) => {
            if (!list) return 'NA';
            const found = list.find(p => normalizeName(p.name) === normPlayer || getDistance(normalizeName(p.name), normPlayer) <= 1);
            return found ? found.rank + '.' : '-';
        }

        const pgaRankVal = getRank(pgaList);
        const officialRankVal = getRank(officialList);
        const tourRankVal = getRank(tourList);
        const eaRankVal = getRank(eaList);
        const assocRankVal = getRank(assocList);
        const fedexRankVal = getRank(fedexList);
        const amateurRankVal = getRank(amateurList);
        
        const eloList = getELORankList();
        const eloEntry = eloList.find(p => normalizeName(p.name) === normPlayer);
        const eloVal = eloEntry ? Math.round(eloEntry.points) : 'NA';
        const eloRank = eloEntry ? eloEntry.rank + '.' : '-';

        let bestOfficialRank = 'NA';
        if (officialList) {
             const pEntry = officialList.find(p => normalizeName(p.name) === normPlayer);
             if (pEntry) bestOfficialRank = pEntry.rank + '.';
        }

        relevantFiles.sort((a,b) => compareFiles(b, a));

        relevantFiles.forEach(f => {
            const p = f.content.find(pl => {
                const n = normalizeName(pl.name);
                return n === normPlayer || getDistance(n, normPlayer) <= 1;
            });

            if (p) {
                const eventKey = `${f.season}_${f.eventName}`;
                if (!uniqueEvents.has(eventKey)) {
                    stats.tournamentCount++;
                    uniqueEvents.add(eventKey);
                }
                stats.totalPoints += p.points;
                stats.totalPar += p.par;
                
                if (f.isImportant || f.isSignificant) {
                    if (!uniqueMajors.has(eventKey)) { stats.majorCount++; uniqueMajors.add(eventKey); }
                    stats.majorPoints += p.points;
                }
                if (p.rank < stats.bestRank) stats.bestRank = p.rank;
                stats.rankSum += p.rank;
                stats.rankCount++;
                if (p.points > 0) stats.cut++;
                if (p.rank <= 20) stats.top20++;
                if (p.rank <= 5) stats.top5++;
                
                // --- NOVÁ LOGIKA TROFEJÍ (OBRÁZKY) ---
                if (p.rank === 1) {
                    stats.wins++;
                    if (f.type === 'FED EX') stats.trophies++;
                    
                    // Formátovanie čísla turnaja na 2 cifry (napr. 1 -> "01", 10 -> "10")
                    let eventNumFormatted = f.eventNum < 10 ? '0' + f.eventNum : '' + f.eventNum;
                    if(f.eventNum === 0 && f.eventName.match(/^\d+/)) {
                        let m = f.eventName.match(/^(\d+)/);
                        if(m) eventNumFormatted = parseInt(m[1]) < 10 ? '0' + parseInt(m[1]) : m[1];
                    }
                    
                    let imgSrc = eventNumFormatted + '.png'; 

                    trophyCollection.push({
                        name: f.eventName,
                        season: f.season,
                        type: 'image',
                        src: imgSrc,
                        fileId: f.id,
                        rank: 1
                    });
                }
                else if (p.rank === 2) {
                    stats.secondPlaces++;
                    trophyCollection.push({
                        name: f.eventName,
                        season: f.season,
                        type: 'icon',
                        icon: '🥈',
                        cssClass: 'm-silver',
                        fileId: f.id,
                        rank: 2
                    });
                }
                else if (p.rank === 3) {
                    stats.thirdPlaces++;
                    trophyCollection.push({
                        name: f.eventName,
                        season: f.season,
                        type: 'icon',
                        icon: '🥉',
                        cssClass: 'm-bronze',
                        fileId: f.id,
                        rank: 3
                    });
                }

                graphData.push({ name: f.eventName, rank: p.rank });

                [p.r1, p.r2, p.r3, p.r4].forEach((r, i) => {
                    if (r !== 'NA') {
                        const val = parseInt(r);
                        stats.totalStrokes += val;
                        stats.totalHoles += 18;
                        if (val < stats.bestRound) stats.bestRound = val;
                        if (val > stats.worstRound) stats.worstRound = val;
                        if(i===0) { stats.r1Sum += val; stats.r1Count++; }
                        if(i===1) { stats.r2Sum += val; stats.r2Count++; }
                        if(i===2) { stats.r3Sum += val; stats.r3Count++; }
                        if(i===3) { stats.r4Sum += val; stats.r4Count++; }
                    }
                });

                // NEMESIS CALCULATION
                f.content.forEach(opponent => {
                    if(opponent.name !== p.name) {
                        const oppNorm = normalizeName(opponent.name);
                        if(!stats.h2h[oppNorm]) stats.h2h[oppNorm] = { name: opponent.name, wins: 0, losses: 0, draws: 0 };
                        if(p.rank < opponent.rank) stats.h2h[oppNorm].wins++;
                        else if(p.rank > opponent.rank) stats.h2h[oppNorm].losses++;
                        else stats.h2h[oppNorm].draws++;
                    }
                });

                let displayName = f.name.replace('.txt', '');
                let rowClass = '';
                if (f.isImportant) { displayName = '★ ' + displayName; rowClass = 'important-row'; } 
                else if (f.isSignificant) { displayName = '= ' + displayName; rowClass = 'significant-row'; }

                stats.history.push(`
                    <tr class="${rowClass}" onclick="openTournamentDetails('${f.id}')" title="Klikni pre detail turnaja">
                        <td>${displayName}</td>
                        <td>${p.rank}.</td>
                        <td>${p.par}</td>
                        <td>${p.r1}</td><td>${p.r2}</td><td>${p.r3}</td><td>${p.r4}</td>
                        <td>${p.points}</td>
                    </tr>
                `);
            }
        });

        // --- NEMESIS & BUNNY Logic ---
        let nemesis = { name: 'N/A', val: 0, wins:0 };
        let bunny = { name: 'N/A', val: 0, losses:0 };
        
        Object.values(stats.h2h).forEach(opp => {
            if(opp.losses > nemesis.val && (opp.wins + opp.losses) >= 3) {
                nemesis = { name: opp.name, val: opp.losses, wins: opp.wins };
            }
            if(opp.wins > bunny.val && (opp.wins + opp.losses) >= 3) {
                bunny = { name: opp.name, val: opp.wins, losses: opp.losses };
            }
        });
        const rivalHtml = `
            <div class="rivalry-section">
                <div class="rival-box bunny">
                    <div class="rival-title">🐰 Obľúbený Súper</div>
                    <div class="rival-icon">🥗</div>
                    <div class="rival-name">${bunny.name}</div>
                    <div class="rival-stat">Skóre: <span class="rival-score" style="color:var(--accent-green)">${bunny.val}</span> - ${bunny.losses}</div>
                </div>
                <div class="rival-box nemesis">
                    <div class="rival-title">🐺 Nemesis</div>
                    <div class="rival-icon">💀</div>
                    <div class="rival-name">${nemesis.name}</div>
                    <div class="rival-stat">Skóre: ${nemesis.wins} - <span class="rival-score" style="color:var(--accent-red)">${nemesis.val}</span></div>
                </div>
            </div>`;

        // --- PLAYER CARD ATTRIBUTES (DEFINITÍVNA OPRAVA) ---
        // Musíme vypočítať ÚPLNE VŠETKO nanovo iba pre PGA/Pro turnaje (bez KFT)
        // Aby sme neodkazovali na "stats", ktorá KFT obsahuje.
        
        let cardStats = { 
            wins: 0, top5: 0, cut: 0, top20: 0, tourneys: 0, majorCount: 0,
            totalHoles: 0,
            historyRanks: [],
            // Pridávame sumy pre výpočet priemerov (MNT atribút)
            r1Sum: 0, r1Count: 0,
            r4Sum: 0, r4Count: 0
        };
        
        relevantFiles.forEach(f => {
            // 1. ZÁSADNÝ FILTER: Ignorujeme KFT
            if (f.type === 'KFT') return;

            const p = f.content.find(pl => {
                 const n = normalizeName(pl.name);
                 return n === normPlayer || getDistance(n, normPlayer) <= 1;
            });

            if (p) {
                cardStats.tourneys++;
                cardStats.historyRanks.push(p.rank);

                if (p.rank === 1) cardStats.wins++;
                if (p.rank <= 5) cardStats.top5++;
                if (p.rank <= 20) cardStats.top20++;
                if (p.points > 0) cardStats.cut++;
                if (f.isImportant || f.isSignificant) cardStats.majorCount++;

                // 2. ZÁSADNÝ VÝPOČET: Počítame údery len z PRO turnajov
                [p.r1, p.r2, p.r3, p.r4].forEach((r, idx) => {
                    if (r !== 'NA') {
                        const val = parseInt(r);
                        cardStats.totalHoles += 18;
                        // Pre MNT potrebujeme R1 a R4
                        if (idx === 0) { cardStats.r1Sum += val; cardStats.r1Count++; }
                        if (idx === 3) { cardStats.r4Sum += val; cardStats.r4Count++; }
                    }
                });
            }
        });

        // Sezónne štatistiky (Birdies/Eagles) - tu sa berie všetko (rovnako ako v globálnom rebríčku)
        let sStats = { games: 0, aces: 0, de: 0, eagles: 0, birdies: 0, pars: 0, bogeys: 0, db: 0 };
        const seasonFilesToUse = db.seasonStats.filter(sFile => activeSeasons.length === 0 || activeSeasons.includes(sFile.season));
        seasonFilesToUse.forEach(sFile => {
             const sPlayer = sFile.content.find(p => {
                 const n = normalizeName(p.name);
                 return n === normPlayer || getDistance(n, normPlayer) <= 1;
             });
             if (sPlayer) {
                 sStats.aces += sPlayer.stats.aces; sStats.de += sPlayer.stats.doubleEagles; sStats.eagles += sPlayer.stats.eagles;
                 sStats.birdies += sPlayer.stats.birdies; sStats.pars += sPlayer.stats.pars; sStats.bogeys += sPlayer.stats.bogeys; sStats.db += sPlayer.stats.doubleBogeys;
             }
        });
        sStats.games = sStats.aces + sStats.de + sStats.eagles + sStats.birdies + sStats.pars + sStats.bogeys + sStats.db;

        // --- VÝPOČET ATRIBÚTOV (Teraz používame výhradne cardStats) ---

        // PWR: Používame jamky bez KFT
        const holesPlayed = cardStats.totalHoles || 1; 
        const birdieRatio = (sStats.birdies + (sStats.eagles*3)) / holesPlayed; 
        let pwr = Math.round(50 + (birdieRatio * 120) + (cardStats.wins * 1.5));
        
        // ACC: Ostáva nezmenené (pomer Par/Bogey)
        const safeRatio = sStats.bogeys > 0 ? (sStats.pars / sStats.bogeys) : (sStats.pars > 0 ? 15 : 5);
        let acc = Math.round(55 + (safeRatio * 2.5));

        // MNT: TOTO BOL PROBLÉM. Teraz používame priemery z cardStats (bez KFT)
        const r1Avg = cardStats.r1Count ? cardStats.r1Sum/cardStats.r1Count : 72;
        const r4Avg = cardStats.r4Count ? cardStats.r4Sum/cardStats.r4Count : 72;
        const clutchFactor = (r1Avg - r4Avg);
        let mnt = Math.round(60 + (clutchFactor * 5) + (cardStats.top5 * 1.5) + (cardStats.majorCount * 1));

        // CON: Používame cardStats (bez KFT)
        const cutPct = cardStats.tourneys ? (cardStats.cut / cardStats.tourneys) : 0;
        const top20Pct = cardStats.tourneys ? (cardStats.top20 / cardStats.tourneys) : 0;
        let con = Math.round(40 + (cutPct * 30) + (top20Pct * 30));

        // FRM: Používame cardStats (bez KFT)
        let form = 70;
        if(cardStats.historyRanks.length > 0) {
            // Pozor: relevantFiles sú zoradené od najnovších, takže berieme prvých 3
            const last3 = cardStats.historyRanks.slice(0, 3);
            const avgPos = last3.reduce((a,b) => a + b, 0) / last3.length;
            form = Math.round(99 - (avgPos * 1.2));
        }

        const clamp = (v) => Math.max(40, Math.min(99, v));
        pwr = clamp(pwr); acc = clamp(acc); mnt = clamp(mnt); con = clamp(con); form = clamp(form);
        const ovr = Math.round((pwr + acc + mnt + con + form) / 5);


        // Card Color Logic
        let cardColorClass = 'red'; 
        const allCards = calculateAllPlayersAttributes().sort((a,b) => b.ovr - a.ovr);
        
        // OPRAVA TU:
        const foundIndex = allCards.findIndex(c => c.name === realPlayerName);
        let myCardRank = 0;

        if (foundIndex === -1) {
            // Hráč nie je v PRO rebríčku (je amatér / iba KFT)
            myCardRank = 9999; 
        } else {
            // Hráč je v rebríčku
            myCardRank = foundIndex + 1;
        }

        if (myCardRank === 9999) cardColorClass = 'grey'; // Alebo 'steel', ak máš takú triedu v CSS
        else if (myCardRank === 1) cardColorClass = 'gold';
        else if (myCardRank === 2) cardColorClass = 'silver';
        else if (myCardRank === 3) cardColorClass = 'bronze';
        else if (myCardRank <= 10) cardColorClass = 'green';
        else if (myCardRank <= 100) cardColorClass = 'blue';
        else cardColorClass = 'cherry'; // Sem spadnú všetci amatéri (rank 9999)


        // --- ÚPRAVA: Rozdelenie mena na dva riadky (Meno <br> Priezvisko) ---
        const nameParts = realPlayerName.split(' ');
        const fName = nameParts[0]; // Prvé meno
        const lName = nameParts.slice(1).join(' '); // Zvyšok (priezvisko)
        // Ak existuje priezvisko, vložíme <br>, inak necháme len meno
        const splitNameHtml = lName ? `${fName}<br>${lName}` : fName;

         const playerCardHtml = `
        <div class="player-card-container ${cardColorClass}" onclick="showGlobalPlayerCards()" style="cursor:pointer" title="Klikni pre zobrazenie rebríčka všetkých hráčov">
            <div class="card-name-box">
                <div class="card-name-text">${splitNameHtml}</div>
            </div>

            <div class="card-ovr-box">
                <div class="card-ovr-val">${ovr}</div>
                <div class="card-ovr-label">OVR</div>
            </div>
            
            <img src="${realPlayerName}.png" onerror="this.onerror=null;this.src='Nezname.png';" class="card-player-img" alt="${realPlayerName}">
            
            <div class="card-info">
                <div class="card-attrs">
                    <div class="attr-row"><span class="attr-name">PWR</span><span class="attr-val ${pwr>85?'high':''}">${pwr}</span></div>
                    <div class="attr-row"><span class="attr-name">ACC</span><span class="attr-val ${acc>85?'high':''}">${acc}</span></div>
                    <div class="attr-row"><span class="attr-name">MNT</span><span class="attr-val ${mnt>85?'high':''}">${mnt}</span></div>
                    <div class="attr-row"><span class="attr-name">CON</span><span class="attr-val ${con>85?'high':''}">${con}</span></div>
                    <div class="attr-row"><span class="attr-name">FRM</span><span class="attr-val ${form>85?'high':''}">${form}</span></div>
                    <div class="attr-row"><span class="attr-name">XP</span><span class="attr-val">${stats.tournamentCount}</span></div>
                </div>
            </div>
        </div>`;


        // --- GENEROWANIE HTML PRE TROFEJE (OBRÁZKY) ---
        let trophyHtml = '';
        if (trophyCollection.length > 0) {
            const items = trophyCollection.map(t => {
                let content = '';
                if (t.type === 'image') {
                    // Pre víťaza načítame obrázok (napr. 01.png)
                    content = `<img src="${t.src}" class="trophy-img" alt="${t.name}" onerror="this.style.display='none';this.parentElement.innerHTML='🏆'">`;
                } else {
                    // Pre 2. a 3. miesto klasické medaily
                    content = `<div class="${t.cssClass}">${t.icon}</div>`;
                }
                let label = t.name.replace(/^\d+\s+/, ''); 

                return `
                <div class="trophy-item" onclick="openTournamentDetails('${t.fileId}')" title="${t.name} (Sezóna ${t.season})">
                    <div class="trophy-inner">
                        ${content}
                    </div>
                    <div class="trophy-date">${label}</div>
                </div>
                `;
            }).join('');
            
            trophyHtml = `
                <div class="trophy-section">
                    <div class="trophy-title">Sieň Trofejí & Medailí (${trophyCollection.length})</div>
                    <div class="trophy-grid">${items}</div>
                </div>`;
        }

        // --- GRAPH ---
        const graphPoints = graphData.slice(0, 15).reverse();
        let graphHtml = '';
        if (graphPoints.length > 1) {
             const w = 100; const step = w / (graphPoints.length - 1);
             const coords = graphPoints.map((p, i) => {
                 let r = p.rank > 50 ? 50 : p.rank; if (r < 1) r = 1;
                 const y = 5 + ((r-1)/49) * 40;
                 return { x: i * step, y: y, data: p };
             });
             let d = `M ${coords[0].x},${coords[0].y}`;
             for (let i = 0; i < coords.length - 1; i++) {
                 const p0 = coords[i]; const p1 = coords[i + 1]; const midX = (p0.x + p1.x) / 2;
                 d += ` C ${midX},${p0.y} ${midX},${p1.y} ${p1.x},${p1.y}`;
             }
             const dots = coords.map((p) => `<circle cx="${p.x}" cy="${p.y}" class="graph-dot" onmouseover="showTooltip(evt, '${p.data.name} - ${p.data.rank}. miesto')" onmouseout="hideTooltip()" />`).join('');
             graphHtml = `<div class="graph-section"><h3 style="margin:0 0 10px 0; font-size:0.9rem; color:#aaa;">Graf vývoja (Posledných 15 turnajov)</h3><div class="graph-container"><svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none" style="overflow:visible;"><line x1="0" y1="5" x2="100" y2="5" stroke="#333" stroke-width="0.2" stroke-dasharray="2"/><line x1="0" y1="25" x2="100" y2="25" stroke="#333" stroke-width="0.2" stroke-dasharray="2"/><line x1="0" y1="45" x2="100" y2="45" stroke="#333" stroke-width="0.2" stroke-dasharray="2"/><path d="${d}" class="graph-path" />${dots}</svg><div id="graphTooltip" class="graph-tooltip"></div></div></div>`;
        } else { graphHtml = `<div style="text-align:center; color:#555; padding:10px;">Nedostatok dát pre graf.</div>`; }
        
        // --- ACHIEVEMENTS ---
        const achievementsHtml = achievementsDef.map(def => {
            const holders = window.globalBadgeHolders[def.id] || [];
            const isUnlocked = holders.includes(realPlayerName);
            const statusClass = isUnlocked ? 'unlocked' : 'locked';
            
            return `<div class="badge ${statusClass}" title="${def.name}" 
                    onclick="showAchievementDetails('${def.id}', '${def.name}', '${def.desc}', '${def.icon}')">
                    ${def.icon}
                    </div>`;
        }).join('');

        // --- RECORDS ---
        let recordsHtml = '';
        if(window.calculateRecordLeaders) {
            const leaders = window.calculateRecordLeaders(); 
            const myRecords = recordsDef.filter(def => {
                const leader = leaders[def.id];
                if (!leader) return false;
                return normalizeName(leader.holder) === normPlayer;
            });

            if (myRecords.length > 0) {
                const recs = myRecords.map(def => {
                    const l = leaders[def.id];
                    return `<div class="profile-record-item" title="${def.desc}" onclick="showRecordDetails('${def.id}')" style="cursor:pointer">
                        <span class="p-rec-icon">${def.icon}</span>
                        <div class="p-rec-name">${def.name}</div>
                        <div class="p-rec-val">${def.format(l.val)}</div>
                    </div>`;
                }).join('');
                recordsHtml = `<h3 style="margin:15px 0 5px 0; font-size:0.9rem; color:#aaa;">Držiteľ Rekordov (Sieň Slávy)</h3>
                               <div class="profile-records-container"><div class="profile-records-grid">${recs}</div></div>`;
            }
        }  

        const avg = (sum, count) => count ? (sum / count).toFixed(1) : '-';
        const strokesPerHole = stats.totalHoles ? (stats.totalStrokes / stats.totalHoles).toFixed(4) : '-';
        const avgStrokesRound = stats.totalHoles ? (stats.totalStrokes / (stats.totalHoles/18)).toFixed(2) : '-';
        const avgPoints = stats.tournamentCount ? (stats.totalPoints / stats.tournamentCount).toFixed(2) : '-';
        const avgRank = stats.rankCount ? (stats.rankSum / stats.rankCount).toFixed(1) : '-';
        const bestR = stats.bestRound === 999 ? '-' : stats.bestRound;
        const worstR = stats.worstRound === -999 ? '-' : stats.worstRound;
        const bestPos = stats.bestRank === 999 ? '-' : stats.bestRank + '.';

        // Dropdown options
        const playerFilesAll = db.files.filter(f => {
             const hasPlayer = f.content.some(pl => normalizeName(pl.name) === normPlayer || getDistance(normalizeName(pl.name), normPlayer)<=1);
             return hasPlayer && (tab === 'ALL' || f.type === tab);
        });
        const availEvents = [...new Set(playerFilesAll.map(f => f.eventName))];
        const availSeasons = [...new Set(playerFilesAll.map(f => f.season))].filter(s=>s!=='00').sort((a,b)=>parseInt(a)-parseInt(b));

        const update = (newEvents, newSeasons) => {
            const eStr = encodeURIComponent(JSON.stringify(newEvents));
            const sStr = encodeURIComponent(JSON.stringify(newSeasons));
            return `updateProfileFilters('${modalId}', '${playerName}', '${tab}', '${eStr}', '${sStr}')`;
        };

        const renderMultiSelect = (items, active, type) => {
             if (items.length === 0) return '<div class="filter-btn empty">Žiadne dáta</div>';
             let html = `<div style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; margin-bottom:5px;">`;
             items.forEach(item => {
                 let newActive = [...active];
                 if (newActive.includes(item)) newActive = newActive.filter(x => x !== item);
                 else newActive.push(item);
                 const isActive = active.includes(item);
                 const clickFn = type === 'event' ? update(newActive, activeSeasons) : update(activeEvents, newActive);
                 html += `<button class="btn btn-sm ${isActive ? 'btn-green' : 'btn-grey'}" onclick="${clickFn}">${item}</button>`;
             });
             html += `</div>`;
             return html;
        };

        const bodyContent = `
            ${playerCardHtml}
            ${trophyHtml}
            ${rivalHtml}

            <div class="profile-tabs">
                <div class="profile-tab ${tab==='ALL'?'active':''}" onclick="updateProfileFilters('${modalId}', '${playerName}', 'ALL', '[]', '[]')">Celkovo</div>
                <div class="profile-tab ${tab==='KFT'?'active':''}" onclick="updateProfileFilters('${modalId}', '${playerName}', 'KFT', '[]', '[]')">KFT</div>
                <div class="profile-tab ${tab==='PGA'?'active':''}" onclick="updateProfileFilters('${modalId}', '${playerName}', 'PGA', '[]', '[]')">PGA</div>
                <div class="profile-tab ${tab==='EA SPORTS'?'active':''}" onclick="updateProfileFilters('${modalId}', '${playerName}', 'EA SPORTS', '[]', '[]')">EA Sports</div>
                <div class="profile-tab ${tab==='THE PLAYERS'?'active':''}" onclick="updateProfileFilters('${modalId}', '${playerName}', 'THE PLAYERS', '[]', '[]')">The Players</div>
                <div class="profile-tab ${tab==='FED EX'?'active':''}" onclick="updateProfileFilters('${modalId}', '${playerName}', 'FED EX', '[]', '[]')">FED EX</div>
            </div>

            <div class="profile-filters-area">
                <small style="color:#888; display:block; margin-bottom:5px;">Filter Turnajov:</small>${renderMultiSelect(availEvents, activeEvents, 'event')}
                <small style="color:#888; display:block; margin-bottom:5px; margin-top:5px;">Filter Sezón:</small>${renderMultiSelect(availSeasons, activeSeasons, 'season')}
            </div>
            
            ${graphHtml}

            <h3 style="margin:10px 0 5px 0; font-size:0.9rem; color:#aaa;">Odznaky & Úspechy</h3>
            <div class="achievements-grid">${achievementsHtml}</div>

            ${recordsHtml}

            <div class="stats-grid">
                <div class="stat-box highlight" onclick="showRankTable('PGA')"><div class="stat-label">PGA Rank</div><div class="stat-value gold rank-clickable">${pgaRankVal}</div></div>
                <div class="stat-box highlight" onclick="showRankTable('Official')"><div class="stat-label">Official Rank</div><div class="stat-value blue rank-clickable">${officialRankVal}</div></div>
                <div class="stat-box highlight" onclick="showRankTable('Tour')"><div class="stat-label">Tour Rank</div><div class="stat-value rank-clickable">${tourRankVal}</div></div>
                <div class="stat-box highlight"><div class="stat-label">Best Official</div><div class="stat-value">${bestOfficialRank}</div></div>
                <div class="stat-box highlight" onclick="showRankTable('FEDEX')"><div class="stat-label" style="color:var(--highlight-gold)">FED EX Rank</div><div class="stat-value gold rank-clickable">${fedexRankVal}</div></div>
                <div class="stat-box highlight" onclick="showRankTable('EA')"><div class="stat-label" style="color:var(--accent-blue)">EA Rank</div><div class="stat-value blue rank-clickable">${eaRankVal}</div></div>
                <div class="stat-box highlight" onclick="showRankTable('Association')"><div class="stat-label" style="color:var(--accent-red)">Association</div><div class="stat-value rank-clickable" style="color:var(--accent-red)">${assocRankVal}</div></div>
                <div class="stat-box highlight" onclick="showRankTable('ELO')" style="border-color:#fff"><div class="stat-label">ELO Rank</div><div class="stat-value">${eloRank}</div></div>
                <div class="stat-box highlight" onclick="showRankTable('Amateur')"><div class="stat-label" style="color:#bdc3c7">Amateur Rank</div><div class="stat-value rank-clickable" style="color:#bdc3c7">${amateurRankVal}</div></div>
                <div class="stat-box highlight" title="Súčet všetkých 1., 2. a 3. miest"><div class="stat-label" style="color:#ffd700">Trofeje & Medaily</div><div class="stat-value" style="color:#fff">${stats.wins + stats.secondPlaces + stats.thirdPlaces}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label" style="font-weight:bold; color:var(--text-main)">Games</div><div class="stat-value white">${sStats.games}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label">Aces</div><div class="stat-value green">${sStats.aces}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label">D. Eagles</div><div class="stat-value green">${sStats.de}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label">Eagles</div><div class="stat-value green">${sStats.eagles}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label">Birdies</div><div class="stat-value blue">${sStats.birdies}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label">Pars</div><div class="stat-value">${sStats.pars}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label">Bogeys</div><div class="stat-value" style="color:#e67e22">${sStats.bogeys}</div></div>
                <div class="stat-box season-highlight"><div class="stat-label">D. Bogeys</div><div class="stat-value" style="color:var(--accent-red)">${sStats.db}</div></div>

                <div class="stat-box"><div class="stat-label">Jamiek</div><div class="stat-value green">${stats.totalHoles}</div></div>
                <div class="stat-box"><div class="stat-label">Odpalov</div><div class="stat-value">${stats.totalStrokes}</div></div>
                <div class="stat-box"><div class="stat-label">Priemer / Jamka</div><div class="stat-value">${strokesPerHole}</div></div>
                <div class="stat-box"><div class="stat-label">Priem. Úderov</div><div class="stat-value" title="Priemer na 18 jamiek">${avgStrokesRound}</div></div>
                <div class="stat-box"><div class="stat-label">Priem. Body</div><div class="stat-value gold" title="Priemerný počet bodov na turnaj">${avgPoints}</div></div>

                <div class="stat-box"><div class="stat-label">Par</div><div class="stat-value">${stats.totalPar}</div></div>
                <div class="stat-box"><div class="stat-label">Turnajov</div><div class="stat-value">${stats.tournamentCount}</div></div>
                <div class="stat-box"><div class="stat-label">Bodov</div><div class="stat-value">${stats.totalPoints.toFixed(2)}</div></div>
                <div class="stat-box"><div class="stat-label">Final Tour</div><div class="stat-value">${stats.majorCount}</div></div>
                <div class="stat-box"><div class="stat-label">Body Final</div><div class="stat-value">${stats.majorPoints.toFixed(2)}</div></div>

                <div class="stat-box"><div class="stat-label">Naj. Pozícia</div><div class="stat-value green">${bestPos}</div></div>
                <div class="stat-box"><div class="stat-label">Priem. Pozícia</div><div class="stat-value">${avgRank}</div></div>
                <div class="stat-box"><div class="stat-label">Naj. Kolo</div><div class="stat-value green">${bestR}</div></div>
                <div class="stat-box"><div class="stat-label" style="color:var(--accent-red)">Najh. Kolo</div><div class="stat-value" style="color:var(--accent-red)">${worstR}</div></div>

                <div class="stat-box"><div class="stat-label">CUT</div><div class="stat-value">${stats.cut}</div></div>
                <div class="stat-box"><div class="stat-label">Top 20</div><div class="stat-value">${stats.top20}</div></div>
                <div class="stat-box"><div class="stat-label">Top 5</div><div class="stat-value blue">${stats.top5}</div></div>
                <div class="stat-box"><div class="stat-label">Výhry</div><div class="stat-value gold">${stats.wins}</div></div>

                <div class="stat-box"><div class="stat-label">Priemer R1</div><div class="stat-value">${avg(stats.r1Sum, stats.r1Count)}</div></div>
                <div class="stat-box"><div class="stat-label">Priemer R2</div><div class="stat-value">${avg(stats.r2Sum, stats.r2Count)}</div></div>
                <div class="stat-box"><div class="stat-label">Priemer R3</div><div class="stat-value">${avg(stats.r3Sum, stats.r3Count)}</div></div>
                <div class="stat-box"><div class="stat-label">Priemer R4</div><div class="stat-value">${avg(stats.r4Sum, stats.r4Count)}</div></div>
            </div>

            <h3 style="margin-top:20px; border-bottom:1px solid #444; padding-bottom:5px;">História zápasov (${stats.history.length})</h3>
            <div class="table-container">
                <table>
                    <tbody>${stats.history.join('')}</tbody>
                </table>
            </div>
        `;

        const proTours = ['PGA', 'EA SPORTS', 'THE PLAYERS', 'FED EX'];
        const isProfessional = db.files.some(f => 
            proTours.includes(f.type) && 
            f.content.some(p => {
                const n = normalizeName(p.name);
                return n === normPlayer || getDistance(n, normPlayer) <= 1;
            })
        );
        const playerStatusLabel = isProfessional ? '(Professional Player)' : '(Amateur Player)';
        const playerStatusColor = isProfessional ? 'var(--highlight-gold)' : '#999';
        
        const eloBadge = `<span class="elo-badge" onclick="showRankTable('ELO')">ELO: ${eloVal}</span>`;

        if (innerOnly) return bodyContent;
        return `<div id="${modalId}"><div class="modal-header"><h2>${playerName} <span style="font-size:0.55em; color:${playerStatusColor}; margin-left:10px; vertical-align:middle; font-weight:normal; letter-spacing:0.5px;">${playerStatusLabel}</span> ${eloBadge}</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div><div class="modal-body">${bodyContent}</div></div>`;
    }
    
    function showTooltip(evt, text) {
        const tt = document.getElementById('graphTooltip');
        tt.style.display = 'block'; tt.innerHTML = text; tt.style.left = (evt.layerX + 15) + 'px'; tt.style.top = (evt.layerY - 30) + 'px';
    }
    function hideTooltip() { document.getElementById('graphTooltip').style.display = 'none'; }

    // --- NOVA FUNKCIA: GALERIA TROFEJI (GLOBAL) ---
    window.openTrophyGallery = function() {
        const limit = 45;


        let html = '<div class="gallery-grid">';
        for(let i=1; i<=limit; i++) {
            let numStr = i < 10 ? '0' + i : '' + i;
            let file = db.files.find(f => f.eventNum === i);

            if(file) {
                // Unlocked (Existuje súbor)
                html += `<div class="gallery-item unlocked" onclick="openTournamentDetails('${file.id}')">
                            <img src="${numStr}.png" style="width:60px; height:60px; object-fit:contain;" onerror="this.style.display='none'; this.nextElementSibling.innerHTML='🏆'">
                            <div class="gallery-label">${file.eventName}</div>
                         </div>`;
            } else {
                // Locked (Neexistuje súbor - zobrazi len placeholder)
                html += `<div class="gallery-item locked">
                            <img src="${numStr}.png" style="width:60px; height:60px; object-fit:contain; filter:grayscale(100%); opacity:0.3;" onerror="this.style.display='none'">
                            <div class="gallery-label">Turnaj ${numStr}</div>
                         </div>`;
            }
        }
        html += '</div>';
        
        const modalHtml = `
            <div class="modal-header">
                <h2>Galéria Všetkých Trofejí</h2>
                <button class="close-btn" onclick="closeTopModal()">&times;</button>
            </div>
            <div class="modal-body">
                ${html}
            </div>`;
        
        createModal(modalHtml);
    }

// --- Detail konkrétneho turnaja (UPRAVENÉ PRE VITRÍNU) ---
window.openTournamentDetails = function(fileId) {
    const file = db.files.find(f => f.id == fileId);
    if (!file) return;
    
    // Zoradenie hráčov
    let sortedPlayers = [...file.content].sort((a, b) => (a.rank !== b.rank) ? a.rank - b.rank : b.points - a.points);
    
    const rows = sortedPlayers.map(p => `
        <tr class="${p.name === 'Tiger Woods' ? 'important-row' : ''}" onclick="openPlayerProfile('${p.name}')" style="cursor:pointer"> 
            <td>${p.rank}.</td>
            <td style="text-align:left; font-weight:bold;">${p.name}</td><td>${p.par}</td>
            <td>${p.r1}</td><td>${p.r2}</td><td>${p.r3}</td><td>${p.r4}</td><td>${p.points}</td>
        </tr>`).join('');
    
    const html = `
        <div class="modal-header">
            <h2 class="clickable-header" onclick="openTrophyShowcase('${file.id}')" title="Klikni pre zobrazenie trofeje vo vitríne">
                ${file.eventName} 
                <span style="font-size:0.7em; color:#888; text-decoration:none;">(Sezóna ${file.season})</span>
            </h2>
            <button class="close-btn" onclick="closeTopModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:0.8rem;">
                (Klikni na názov turnaja vyššie pre zobrazenie trofeje)
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Poz.</th><th>Hráč</th><th>Par</th><th>R1</th><th>R2</th><th>R3</th><th>R4</th><th>Body</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;
    
    createModal(html);
};
 
/// --- VYLEPŠENÁ FUNKCIA: VITRÍNA S PAMÄŤOU, VÍŤAZOM A NAVIGÁCIOU ---
window.openTrophyShowcase = function(fileId) {
    const file = db.files.find(f => f.id == fileId);
    if (!file) return;

    // --- AUTO-DETEKCIA TÉMY ---
    let themeToUse = file.trophyTheme; 
    if (!themeToUse) {
        themeToUse = 'Clean White';
        let myEventNum = file.eventNum < 10 ? '0' + file.eventNum : '' + file.eventNum;
        for (const key in vitrineThemes) {
            if (key === 'Clean White') continue;
            const targetNumbers = key.split('-');
            if (targetNumbers.includes(myEventNum)) {
                themeToUse = key;
                break; 
            }
        }
    }

    // --- LOGIKA OBRÁZKA TROFEJE ---
    let eventNumFormatted = file.eventNum < 10 ? '0' + file.eventNum : '' + file.eventNum;
    if(file.eventNum === 0 && file.eventName.match(/^\d+/)) {
        let m = file.eventName.match(/^(\d+)/);
        if(m) eventNumFormatted = parseInt(m[1]) < 10 ? '0' + parseInt(m[1]) : m[1];
    }
    const imgSrc = eventNumFormatted + '.png';

    // --- LOGIKA VÍŤAZA ---
    const winner = file.content.find(p => p.rank === 1);
    const winnerName = winner ? winner.name : 'N/A';
    
    // --- LOGIKA NAVIGÁCIE ---
    const sameEventFiles = db.files.filter(f => {
        if (file.eventNum !== 0) return f.eventNum === file.eventNum;
        return f.eventName === file.eventName;
    }).sort((a,b) => parseInt(a.season) - parseInt(b.season));
    
    const currentIndex = sameEventFiles.findIndex(f => f.id === file.id);
    const prevFile = currentIndex > 0 ? sameEventFiles[currentIndex - 1] : null;
    const nextFile = currentIndex < sameEventFiles.length - 1 ? sameEventFiles[currentIndex + 1] : null;
    
    let navHtml = '';
    if(prevFile) navHtml += `<button class="vitrine-nav-btn v-prev" onclick="openTrophyShowcase('${prevFile.id}')" title="Sezóna ${prevFile.season}">&#10094;</button>`;
    if(nextFile) navHtml += `<button class="vitrine-nav-btn v-next" onclick="openTrophyShowcase('${nextFile.id}')" title="Sezóna ${nextFile.season}">&#10095;</button>`;

    // --- MENU TÉM ---
    let themesHtml = '';
    Object.keys(vitrineThemes).forEach(key => {
        const t = vitrineThemes[key];
        themesHtml += `
            <div class="v-theme-item" onclick="setVitrineTheme('${key}', '${file.id}')">
                <span class="v-preview-dot" style="background:${t.bg}"></span>
                ${key}
            </div>`;
    });

    const html = `
        <div class="vitrine-theme-wrapper">
            <button class="vitrine-theme-btn" onclick="document.getElementById('vitrineThemeList').classList.toggle('show')">
                📂 Témy
            </button>
            <div id="vitrineThemeList" class="vitrine-theme-list">
                ${themesHtml}
            </div>
        </div>

        <button class="vitrine-close" onclick="closeTopModal()">&times;</button>
        ${navHtml}
        
        <div class="vitrine-content">
            <div class="vitrine-title">${file.eventName}</div>

            <div class="vitrine-season-label">SEZÓNA ${file.season}</div>

            <div class="vitrine-winner" onclick="openPlayerProfile('${winnerName}')">${winnerName}</div>
            
            <img src="${imgSrc}" class="vitrine-img" alt="Trophy" 
                 onerror="this.outerHTML='<div style=&quot;font-size:8rem; margin:20px 0;&quot;>🏆</div><div style=&quot;color:#555; font-weight:bold;&quot;>Obrázok chýba</div>'">
            
        </div> 

        <img src="${winnerName}.png" 
             class="vitrine-player-img" 
             onerror="this.onerror=null;this.src='Nezname2.png';">
    `;


    createModal(html);
    
    // Aplikácia témy
    const overlays = document.querySelectorAll('.modal-overlay');
    const currentOverlay = overlays[overlays.length - 1];
    if (currentOverlay) {
        const modalBox = currentOverlay.querySelector('.modal');
        if (modalBox) {
            modalBox.className = 'modal vitrine-modal';
            setVitrineTheme(themeToUse, null); 
        }
    }
}



// --- VYLEPŠENÁ FUNKCIA NA ZMENU A ULOŽENIE TÉMY ---
window.setVitrineTheme = function(themeName, fileId = null) {
    const theme = vitrineThemes[themeName];
    if (!theme) return;

    // 1. AK MÁME ID SÚBORU, ULOŽÍME TÉMU DO DATABÁZY
    if (fileId) {
        const file = db.files.find(f => f.id == fileId);
        if (file) {
            file.trophyTheme = themeName; // Uložíme do objektu turnaja
            saveAuto(); // Uložíme celú DB do prehliadača
        }
    }

    // 2. APLIKUJEME VIZUÁLNE ZMENY
    const modalBox = document.querySelector('.vitrine-modal');
    if (modalBox) {
        modalBox.style.background = theme.bg;
        
        const title = modalBox.querySelector('.vitrine-title');
        const sub = modalBox.querySelector('.vitrine-subtitle');
        const winner = modalBox.querySelector('.vitrine-winner'); // Nové
        const closeBtn = modalBox.querySelector('.vitrine-close');
        
        if(title) title.style.color = theme.text;
        if(sub) sub.style.color = theme.text === '#fff' ? '#ddd' : '#666';
        if(winner) winner.style.color = theme.text === '#fff' ? '#f1c40f' : '#b8860b'; // Zlatá farba pre víťaza
        if(closeBtn) closeBtn.style.color = theme.text;
    }
    
    // Zatvoríme menu
    const list = document.getElementById('vitrineThemeList');
    if(list) list.classList.remove('show');
}


    // --- Global Rank Tables ---
    window.showRankTable = function(type) {
        let list = []; let title = '';
        if (type === 'PGA') { list = getPGARankList(); title = 'PGA Rank (Top 40 PGA Turnajov)'; }
        if (type === 'Official') { list = getOfficialRankList(); title = 'Official Rank (All Time)'; }
        if (type === 'Tour') { list = getTourRankList(); title = 'Tour Rank (Major/Important)'; }
        if (type === 'EA') { list = getEARankList(); title = 'EA Rank (EA Sports + FED EX)'; }
        if (type === 'Association') { list = getAssociationRankList(); title = 'Association Rank (The Players - Last 10)'; }
        if (type === 'FEDEX') { list = getFedExRankList(); title = 'FED EX Rank (Posledná sezóna - All Tours)'; }
        if (type === 'ELO') { list = getELORankList(); title = 'ELO Ranking (Skill Level)'; }
        // Pridaný AMATEUR RANK (KFT)
        if (type === 'Amateur') { list = getAmateurRankList(); title = 'Amateur Rank (KFT Tour)'; }

        if (!list) { alert('Nedostatok dát pre výpočet.'); return; }
        
        let rows = list.map(p => {
            const val = type === 'ELO' ? Math.round(p.points) : p.points.toFixed(3);
            return `<tr onclick="openPlayerProfile('${p.name}')" style="cursor:pointer"><td><b style="color:${p.rank===1?'gold':'white'}">${p.rank}.</b></td><td>${p.name}</td><td style="text-align:right">${val}</td></tr>`
        }).join('');
        
        const html = `<div class="modal-header"><h2>${title}</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div><div class="modal-body"><div class="table-container"><table><thead><tr><th>#</th><th>Hráč</th><th style="text-align:right">${type==='ELO'?'Rating':'Body'}</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
        createModal(html);
    }
    // --- GLOBÁLNY ZOZNAM ACHIEVEMENTOV ---
    window.openGlobalAchievementsList = function() {
        const allPlayers = new Set();
        db.files.forEach(f => f.content.forEach(p => allPlayers.add(normalizeName(p.name))));
        const totalPlayers = allPlayers.size;

        const calculatedList = achievementsDef.map(def => {
            const holders = window.globalBadgeHolders[def.id] || [];
            const count = holders.length;
            const percentage = totalPlayers > 0 ? (count / totalPlayers) * 100 : 0;
            return { def, count, percentage };
        });

        calculatedList.sort((a, b) => b.percentage - a.percentage);

        const listHtml = calculatedList.map(item => {
            const def = item.def;
            const percentageStr = item.percentage.toFixed(1);
            return `
            <div class="global-ach-item" onclick="showAchievementDetails('${def.id}', '${def.name}', '${def.desc}', '${def.icon}')">
                <div class="global-ach-icon">${def.icon}</div>
                <div class="global-ach-info">
                    <div class="global-ach-name">${def.name}</div>
                    <div class="global-ach-desc">${def.desc}</div>
                </div>
                <div style="text-align:right">
                    <div class="global-ach-count">${item.count}</div>
                    <small style="color:#777">${percentageStr}%</small>
                </div>
            </div>`;
        }).join('');

        const html = `
            <div class="modal-header">
                <h2>Rebríček Achievementov</h2>
                <button class="close-btn" onclick="closeTopModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="global-ach-list">${listHtml}</div>
            </div>
        `;
        createModal(html);
    }

    window.showAchievementDetails = function(badgeId, badgeName, badgeDesc, badgeIcon) {
        const holders = window.globalBadgeHolders[badgeId] || [];
        
        const allPlayers = new Set();
        db.files.forEach(f => f.content.forEach(p => allPlayers.add(normalizeName(p.name))));
        const totalPlayers = allPlayers.size;
        const percentage = totalPlayers > 0 ? ((holders.length / totalPlayers) * 100).toFixed(1) : 0;

        const holdersHtml = holders.map(h => `
            <div class="ach-player-card" onclick="openPlayerProfile('${h}')">
                <div style="font-weight:bold; color:#fff;">${h}</div>
            </div>
        `).join('');

        const html = `
            <div class="modal-header">
                <h2>Detail Odznaku</h2>
                <button class="close-btn" onclick="closeTopModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding:0;">
                <div class="ach-header">
                    <span class="ach-icon-large">${badgeIcon}</span>
                    <h3 class="ach-title">${badgeName}</h3>
                    <p class="ach-desc">${badgeDesc}</p>
                </div>
                <div class="ach-stat-bar"><div class="ach-fill" style="width: ${percentage}%"></div></div>
                <div class="ach-stat-text">Získalo ${holders.length} z ${totalPlayers} hráčov (${percentage}%)</div>
                <div style="background:#222; padding:10px; border-top:1px solid #444;">
                    <div class="ach-player-list">${holdersHtml}</div>
                </div>
            </div>
        `;
        createModal(html);
        setTimeout(() => { const bar = document.querySelector('.ach-fill'); if(bar) bar.style.width = percentage + '%'; }, 100);
    }

    // --- DETAIL REKORDU (TOP 20) ---
    window.showRecordDetails = function(recordId) {
        const def = recordsDef.find(r => r.id === recordId);
        if(!def) return;

        const allStats = calculateAllPlayerStatsForRecords();
        
        const list = allStats.map(p => {
             let val = getRecordValueForPlayer(p, recordId);
             return { name: p.realName, val: val };
        }).filter(item => item.val !== null && item.val !== undefined && item.val !== 999 && item.val !== -999 && item.val !== 0);

        // Zoznam rekordov, kde MENŠIE číslo je LEPŠIE (Ascending sort)
        const lowIsGoodRecords = [
            'lowest_rnd', 'lowest_r1', 'lowest_r2', 'lowest_r3',
            'avg_strokes', 'major_avg', 
            'mr_friday', 'mr_saturday', 'mr_sunday', 'fast_starter',
            'finisher', // Best R4
            'best_weekend', // Lowest sum
            'consistency_king', // Best Rank (1.0)
            'comeback_kid', // R4 - R3 (Negative is good)
            'under_par_total' // Most negative is good
        ];

        // Zoradenie
        if(lowIsGoodRecords.includes(recordId) || recordId.includes('lowest') || recordId.includes('avg')) {
            list.sort((a,b) => a.val - b.val); // Vzostupne (najnižšie prvé)
        } else {
            list.sort((a,b) => b.val - a.val); // Zostupne (najvyššie prvé)
        }

        const top20 = list.slice(0, 20);
        
        const rows = top20.map((item, idx) => `
            <tr onclick="openPlayerProfile('${item.name}')" style="cursor:pointer">
                <td>${idx+1}.</td>
                <td style="font-weight:bold; text-align:left;">${item.name}</td>
                <td style="color:var(--highlight-gold); text-align:right;">${def.format(item.val)}</td>
            </tr>
        `).join('');

        const html = `
            <div class="modal-header">
                <h2>${def.icon} ${def.name}</h2>
                <button class="close-btn" onclick="closeTopModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color:#aaa; text-align:center; font-style:italic; margin-bottom:15px;">${def.desc}</p>
                <div class="table-container">
                    <table>
                        <thead><tr><th>#</th><th>Hráč</th><th style="text-align:right">Hodnota</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>
        `;
        createModal(html);
    }

    
    function getRecordValueForPlayer(s, recId) {
        if(recId === 'most_wins') return s.wins;
        if(recId === 'most_points') return s.points;
        if(recId === 'iron_man') return s.tourneys;
        if(recId === 'lowest_rnd') return s.bestRound === 999 ? null : s.bestRound;
        if(recId === 'avg_strokes') return s.tourneys >= 5 ? s.avgStrokes : null;
        if(recId === 'most_cuts') return s.cuts;
        if(recId === 'most_top20') return s.top20;
        if(recId === 'top10_machine') return s.top10;
        if(recId === 'podium') return s.top5;
        if(recId === 'birdie_king') return s.sStats.birdies;
        if(recId === 'sniper') return s.sStats.aces;
        if(recId === 'eagle_master') return s.sStats.eagles;
        if(recId === 'par_machine') return s.sStats.pars;
        if(recId === 'mr_saturday') return s.r3c >= 3 ? s.avgR3 : null;
        if(recId === 'mr_sunday') return s.r4c >= 3 ? s.avgR4 : null;
        if(recId === 'slow_starter') return s.r1c >= 3 ? s.avgR1 : null; 
        if(recId === 'fast_starter') return s.r1c >= 3 ? s.avgR1 : null;
        if(recId === 'glass_chin') return s.worstR4 !== -999 ? s.worstR4 : null;
        if(recId === 'finisher') return s.bestR4 !== 999 ? s.bestR4 : null;
        if(recId === 'major_hunter') return s.majorWins;
        if(recId === 'major_avg') return s.majorCount >= 3 ? s.avgMajor : null;
        if(recId === 'runner_up') return s.secondPlaces;
        if(recId === 'consistency_king') return s.tourneys >= 10 ? s.avgRank : null;
        if(recId === 'marathon_man') return s.holes;
        if(recId === 'win_streak') return s.maxWinStreak;
        if(recId === 'best_weekend') return s.bestWeekend !== 999 ? s.bestWeekend : null;
        if(recId === 'worst_collapse') return s.r3_r4_diff_count >= 3 ? s.avgCollapse : null;
        if(recId === 'comeback_kid') return s.r3_r4_diff_count >= 3 ? s.avgCollapse : null;
        if(recId === 'scoring_machine') return s.sub70;
        if(recId === 'kft_king') return s.kftPoints;
        if(recId === 'pga_dominator') return s.pgaPoints;
        if(recId === 'under_par_total') return s.underParTotal;
        if(recId === 'sub60_count') return s.sub60;
        if(recId === 'unique_winner') return s.uniqueWinsCount;
        if(recId === 'efficiency') return s.tourneys >= 5 ? s.avgPoints : null;
        if(recId === 'mr_friday') return s.r2c >= 3 ? s.avgR2 : null;
        if(recId === 'ea_king') return s.eaPoints;
        if(recId === 'players_king') return s.playersPoints;
        if(recId === 'fedex_king') return s.fedexPoints;
        if(recId === 'weekend_golfer') return s.rounds80;
        if(recId === 'sub65_machine') return s.sub65;
        if(recId === 'bridesmaid') return s.wins === 0 ? s.top5 : null;
        if(recId === 'fireworks') return s.sStats.fireworks;
        if(recId === 'bogey_man') return s.sStats.bogeys;
        if(recId === 'disaster_artist') return s.sStats.doubleBogeys;
        if(recId === 'adapter') return s.r1_r4_diff_count >= 3 ? s.avgImprovement : null;
        if(recId === 'gas_out') return (s.r1_r4_diff_count >= 3 && s.avgImprovement < -0.1) ? Math.abs(s.avgImprovement) : null;
        if(recId === 'risk_taker') return s.sStats.pars > 50 ? s.sStats.riskRatio : null;
        if(recId === 'safe_hands') return s.sStats.bogeys > 0 ? s.sStats.safeRatio : null;
        if(recId === 'jekyll_hyde') return s.tourneys >= 5 ? s.roundDiffCareer : null;
        if(recId === 'major_contender') return s.majorTop10;
        if(recId === 'survivalist') return s.wins === 0 ? s.cuts : null;
        if(recId === 'points_per_round') return s.holes >= 180 ? s.pointsPerRound : null;
        if(recId === 'classic_king') return s.classicPoints;
        if(recId === 'career_aces') return s.sStats.aces;
        if(recId === 'career_eagles') return s.sStats.eagles;
        if(recId === 'career_birdies') return s.sStats.birdies;
        if(recId === 'career_pars') return s.sStats.pars;
        if(recId === 'career_bogeys') return s.sStats.bogeys;
        if(recId === 'career_doubles') return s.sStats.doubleBogeys;
        if(recId === 'win_pct') return s.tourneys >= 20 ? s.winPct : null;
        if(recId === 'top10_pct') return s.tourneys >= 20 ? s.top10Pct : null;
        if(recId === 'cut_pct') return s.tourneys >= 20 ? s.cutPct : null;
        if(recId === 'top5_pct') return s.tourneys >= 20 ? s.top5Pct : null;
        if(recId === 'streak_top10') return s.maxTop10Streak;
        if(recId === 'streak_cuts') return s.maxCutStreak;
        if(recId === 'lowest_r1') return s.lowestR1 !== 999 ? s.lowestR1 : null;
        if(recId === 'lowest_r2') return s.lowestR2 !== 999 ? s.lowestR2 : null;
        if(recId === 'lowest_r3') return s.lowestR3 !== 999 ? s.lowestR3 : null;
        if(recId === 'highest_rnd') return s.highestRnd !== -999 ? s.highestRnd : null;
        if(recId === 'season_best_wins') return s.maxSeasonWins;
        if(recId === 'season_best_pts') return s.maxSeasonPoints;
        if(recId === 'longevity') return s.seasonsCount;
        if(recId === 'missed_cuts') return s.missedCuts;
        return 0;
    }

    function calculateAllPlayerStatsForRecords() {
        const stats = {}; const seasonAgg = {};
        const sortedFiles = [...db.files].sort(compareFiles);
        sortedFiles.forEach(f => {
            f.content.forEach(p => {
                const name = normalizeName(p.name);
                if(!stats[name]) stats[name] = { 
                    realName: p.name, wins: 0, points: 0, tourneys: 0, cuts: 0, top20: 0, top10:0, top5:0, 
                    strokes: 0, holes: 0, bestRound: 999, worstRound: -999, 
                    r1s:0, r1c:0, r2s:0, r2c:0, r3s:0, r3c:0, r4s:0, r4c:0,
                    bestR4: 999, worstR4: -999, ranksSum: 0, secondPlaces: 0, 
                    majorWins: 0, majorSum:0, majorCount:0, majorTop10: 0,
                    r3_r4_diff_sum: 0, r3_r4_diff_count: 0, bestWeekend: 999, 
                    currentWinStreak: 0, maxWinStreak: 0, sub70: 0, sub60: 0, sub65: 0, rounds80: 0,
                    kftPoints: 0, pgaPoints: 0, eaPoints: 0, playersPoints: 0, fedexPoints: 0, classicPoints: 0,
                    underParTotal: 0, uniqueTours: new Set(), uniqueSeasons: new Set(),
                    r1_r4_diff_sum: 0, r1_r4_diff_count: 0,
                    curTop10Streak: 0, maxTop10Streak: 0, curCutStreak: 0, maxCutStreak: 0,
                    lowestR1: 999, lowestR2: 999, lowestR3: 999, highestRnd: -999,
                    missedCuts: 0, seasonMap: {} 
                };
                
                const s = stats[name]; 
                s.points += p.points; s.tourneys++; s.ranksSum += p.rank; s.underParTotal += p.par;
                s.uniqueSeasons.add(f.season);
                if(!s.seasonMap[f.season]) s.seasonMap[f.season] = { wins: 0, points: 0 };
                s.seasonMap[f.season].points += p.points;
                
                if(f.type === 'KFT') s.kftPoints += p.points; 
                if(f.type === 'PGA') s.pgaPoints += p.points;
                if(f.type === 'EA SPORTS') s.eaPoints += p.points;
                if(f.type === 'THE PLAYERS') s.playersPoints += p.points;
                if(f.type === 'FED EX') s.fedexPoints += p.points;
                if(!f.isImportant && !f.isSignificant) s.classicPoints += p.points;

                if(p.rank === 1) { 
                    s.wins++; s.currentWinStreak++; s.uniqueTours.add(f.type); s.seasonMap[f.season].wins++;
                    if(s.currentWinStreak > s.maxWinStreak) s.maxWinStreak = s.currentWinStreak; 
                    if(f.isImportant || f.isSignificant) s.majorWins++; 
                } else { s.currentWinStreak = 0; }
                
                if(p.rank === 2) s.secondPlaces++; 
                if(p.rank <= 3) s.top5++; 
                if(p.rank <= 10) {
                    s.top10++; s.curTop10Streak++;
                    if(s.curTop10Streak > s.maxTop10Streak) s.maxTop10Streak = s.curTop10Streak;
                } else { s.curTop10Streak = 0; }

                if(p.rank <= 20) s.top20++;
                if(p.points > 0) { s.cuts++; s.curCutStreak++; if(s.curCutStreak > s.maxCutStreak) s.maxCutStreak = s.curCutStreak; } 
                else { s.missedCuts++; s.curCutStreak = 0; }
                
                if(f.isImportant || f.isSignificant) { 
                    s.majorSum += p.rank; s.majorCount++; 
                    if(p.rank <= 10) s.majorTop10++;
                }

                let r1v=null, r3v=null, r4v=null;
                [p.r1, p.r2, p.r3, p.r4].forEach((r, idx) => {
                    if(r !== 'NA') { 
                        const v = parseInt(r); 
                        s.strokes += v; s.holes += 18; 
                        if(v < 70) s.sub70++; if(v < 65) s.sub65++; if(v < 60) s.sub60++; if(v >= 80) s.rounds80++;
                        if(v < s.bestRound) s.bestRound = v; if(v > s.worstRound) s.worstRound = v; if(v > s.highestRnd) s.highestRnd = v;
                        if(idx === 0) { s.r1s += v; s.r1c++; r1v=v; if(v < s.lowestR1) s.lowestR1 = v; }
                        if(idx === 1) { s.r2s += v; s.r2c++; if(v < s.lowestR2) s.lowestR2 = v; }
                        if(idx === 2) { s.r3s += v; s.r3c++; r3v=v; if(v < s.lowestR3) s.lowestR3 = v; }
                        if(idx === 3) { s.r4s += v; s.r4c++; r4v=v; if(v < s.bestR4) s.bestR4 = v; if(v > s.worstR4) s.worstR4 = v; } 
                    }
                });
                if(r3v !== null && r4v !== null) { s.r3_r4_diff_sum += (r4v - r3v); s.r3_r4_diff_count++; if((r3v + r4v) < s.bestWeekend) s.bestWeekend = (r3v + r4v); }
                if(r1v !== null && r4v !== null) { s.r1_r4_diff_sum += (r1v - r4v); s.r1_r4_diff_count++; }
            });
        });
        db.seasonStats.forEach(f => {
            f.content.forEach(p => { 
                const name = normalizeName(p.name); 
                if(!seasonAgg[name]) seasonAgg[name] = { birdies: 0, aces: 0, eagles: 0, pars: 0, bogeys: 0, doubleBogeys: 0 }; 
                seasonAgg[name].birdies += p.stats.birdies; seasonAgg[name].aces += p.stats.aces; 
                seasonAgg[name].eagles += p.stats.eagles; seasonAgg[name].pars += p.stats.pars;
                seasonAgg[name].bogeys += p.stats.bogeys; seasonAgg[name].doubleBogeys += p.stats.doubleBogeys;
            });
        });

        return Object.values(stats).map(s => { 
            s.avgStrokes = s.holes > 0 ? (s.strokes / (s.holes/18)) : 999; 
            s.avgR1 = s.r1c > 0 ? (s.r1s / s.r1c) : 999; s.avgR2 = s.r2c > 0 ? (s.r2s / s.r2c) : 999; 
            s.avgR3 = s.r3c > 0 ? (s.r3s / s.r3c) : 999; s.avgR4 = s.r4c > 0 ? (s.r4s / s.r4c) : 999; 
            s.avgRank = s.tourneys > 0 ? (s.ranksSum / s.tourneys) : 999; 
            s.avgMajor = s.majorCount > 0 ? (s.majorSum / s.majorCount) : 999; 
            s.avgCollapse = s.r3_r4_diff_count > 0 ? (s.r3_r4_diff_sum / s.r3_r4_diff_count) : -999; 
            s.avgImprovement = s.r1_r4_diff_count > 0 ? (s.r1_r4_diff_sum / s.r1_r4_diff_count) : -999;
            s.uniqueWinsCount = s.uniqueTours.size; 
            s.avgPoints = s.tourneys > 0 ? (s.points / s.tourneys) : 0; 
            s.pointsPerRound = s.holes > 0 ? (s.points / (s.holes/18)) : 0; 
            s.roundDiffCareer = (s.worstRound !== -999 && s.bestRound !== 999) ? (s.worstRound - s.bestRound) : 0;
            s.winPct = s.tourneys > 0 ? (s.wins / s.tourneys) * 100 : 0;
            s.top10Pct = s.tourneys > 0 ? (s.top10 / s.tourneys) * 100 : 0;
            s.cutPct = s.tourneys > 0 ? (s.cuts / s.tourneys) * 100 : 0;
            s.top5Pct = s.tourneys > 0 ? (s.top5 / s.tourneys) * 100 : 0;
            s.seasonsCount = s.uniqueSeasons.size;
            s.maxSeasonWins = 0; s.maxSeasonPoints = 0;
            Object.values(s.seasonMap).forEach(val => { if(val.wins > s.maxSeasonWins) s.maxSeasonWins = val.wins; if(val.points > s.maxSeasonPoints) s.maxSeasonPoints = val.points; });
            s.sStats = seasonAgg[normalizeName(s.realName)] || { birdies: 0, aces: 0, eagles: 0, pars: 0, bogeys: 0, doubleBogeys: 0 };
            s.sStats.fireworks = s.sStats.aces + s.sStats.eagles + s.sStats.birdies;
            s.sStats.riskRatio = s.sStats.pars > 0 ? (s.sStats.birdies / s.sStats.pars) : 0;
            s.sStats.safeRatio = s.sStats.bogeys > 0 ? (s.sStats.pars / s.sStats.bogeys) : s.sStats.pars;
            return s;
        });
    }

    window.calculateRecordLeaders = function() {
        const players = calculateAllPlayerStatsForRecords();
        const leaders = {};
        const proTours = ['PGA', 'EA SPORTS', 'THE PLAYERS', 'FED EX']; // Definícia Pro Tours

        // Zoznam rekordov, kde MENŠIE číslo je LEPŠIE (Ascending sort)
        const lowIsGoodRecords = [
            'lowest_rnd', 'lowest_r1', 'lowest_r2', 'lowest_r3',
            'avg_strokes', 'major_avg', 
            'mr_friday', 'mr_saturday', 'mr_sunday', 'fast_starter',
            'finisher', // Best R4
            'best_weekend', // Lowest sum
            'consistency_king', // Best Rank (1.0)
            'comeback_kid', // R4 - R3 (Negative is good)
            'under_par_total' // Most negative is good
        ];

        recordsDef.forEach(rec => {
             // 1. KROK: Filter hráčov (Iba PRO, s výnimkou KFT King)
             const eligiblePlayers = players.filter(p => {
                 if (rec.id === 'kft_king') return true; // KFT King môže byť aj amatér
                 
                 // Kontrola či hral na PRO tour (či má v zozname uniqueTours aspoň jednu PRO tour)
                 const isPro = [...p.uniqueTours].some(t => proTours.includes(t));
                 return isPro;
             });

             const candidates = eligiblePlayers.map(p => ({ realName: p.realName, val: getRecordValueForPlayer(p, rec.id) }))
                                       .filter(x => x.val !== null && x.val !== undefined && x.val !== 999 && x.val !== -999 && x.val !== 0);
             
             if(lowIsGoodRecords.includes(rec.id) || rec.id.includes('lowest') || rec.id.includes('avg')) {
                 candidates.sort((a,b) => a.val - b.val); // Vzostupne
             } else {
                 candidates.sort((a,b) => b.val - a.val); // Zostupne
             }
             
             if(candidates.length > 0) leaders[rec.id] = { holder: candidates[0].realName, val: candidates[0].val };
        });
        return leaders;
    }


    // --- Hall of Fame ---
    window.openHallOfFame = function() {
        const leaders = window.calculateRecordLeaders();
        let boxesHtml = '';
        recordsDef.forEach(rec => {
            const l = leaders[rec.id];
            if(l) {
                boxesHtml += `<div class="record-box" onclick="showRecordDetails('${rec.id}')"><div class="record-icon">${rec.icon}</div><div class="record-info"><div class="record-title">${rec.name}</div><div class="record-holder" onclick="event.stopPropagation(); openPlayerProfile('${l.holder}')" style="cursor:pointer">${l.holder}</div><div class="record-val">${rec.format(l.val)}</div></div></div>`;
            }
        });
        const html = `<div class="modal-header"><h2>Sieň Slávy (Rekordy)</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div><div class="modal-body"><div class="stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px;">${boxesHtml}</div></div>`;
        createModal(html);
    }
    // --- Enhanced Comparator (Head-to-Head) ---
    window.h2hState = { tour: 'ALL', season: 'ALL', event: 'ALL' };
    
    window.openComparator = function() {
        const uniqueNames = new Set(); 
        db.files.forEach(f => f.content.forEach(p => uniqueNames.add(p.name)));
        const sortedNames = [...uniqueNames].sort();
        const options = sortedNames.map(n => `<option value="${n}">${n}</option>`).join('');
        
        const tours = ['ALL', 'KFT', 'PGA', 'EA SPORTS', 'THE PLAYERS', 'FED EX'];
        const seasons = ['ALL', ...new Set(db.files.map(f => f.season))].sort((a,b) => { 
            if(a==='ALL') return -1; if(b==='ALL') return 1; return parseInt(a)-parseInt(b); 
        });
        const events = ['ALL', ...new Set(db.files.map(f => f.eventName))].sort();
        
        const tourOpts = tours.map(t => `<option value="${t}">${t}</option>`).join('');
        const seasonOpts = seasons.map(s => `<option value="${s}">${s === 'ALL' ? 'Všetky sezóny' : 'Sezóna '+s}</option>`).join('');
        const eventOpts = events.map(e => `<option value="${e}">${e === 'ALL' ? 'Všetky turnaje' : e}</option>`).join('');

        const html = `
            <div class="modal-header"><h2>Porovnávač</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div>
            <div class="modal-body">
                <div class="vs-filters">
                    <select id="h2hTour" class="vs-select" style="min-width:100px; font-size:0.8rem;" onchange="updateH2HFilter('tour', this.value)">${tourOpts}</select>
                    <select id="h2hSeason" class="vs-select" style="min-width:100px; font-size:0.8rem;" onchange="updateH2HFilter('season', this.value)">${seasonOpts}</select>
                    <select id="h2hEvent" class="vs-select" style="min-width:150px; font-size:0.8rem;" onchange="updateH2HFilter('event', this.value)">${eventOpts}</select>
                </div>
                <div class="vs-container">
                    <select id="vsPlayer1" class="vs-select" onchange="renderComparison()"><option value="">Hráč A...</option>${options}</select>
                    <div class="vs-badge">VS</div>
                    <select id="vsPlayer2" class="vs-select" onchange="renderComparison()"><option value="">Hráč B...</option>${options}</select>
                </div>
                <div id="vsResults"></div>
            </div>`;
        window.h2hState = { tour: 'ALL', season: 'ALL', event: 'ALL' };
        createModal(html);
    }

    window.updateH2HFilter = function(key, val) { 
        window.h2hState[key] = val; 
        renderComparison(); 
    }

    window.renderComparison = function() {
        const p1Name = document.getElementById('vsPlayer1').value; 
        const p2Name = document.getElementById('vsPlayer2').value; 
        const container = document.getElementById('vsResults');
        
        if(!p1Name || !p2Name) { container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Vyberte dvoch hráčov pre porovnanie.</div>'; return; }
        if(p1Name === p2Name) { container.innerHTML = '<div style="text-align:center; color:var(--accent-red); padding:20px;">Vyberte rozdielnych hráčov.</div>'; return; }
        
        const norm1 = normalizeName(p1Name); 
        const norm2 = normalizeName(p2Name);
        
        let activeFiles = db.files.filter(f => {
            if(window.h2hState.tour !== 'ALL' && f.type !== window.h2hState.tour) return false;
            if(window.h2hState.season !== 'ALL' && f.season !== window.h2hState.season) return false;
            if(window.h2hState.event !== 'ALL' && f.eventName !== window.h2hState.event) return false;
            return true;
        });

        let mutualTournaments = 0, p1BeatP2 = 0, p2BeatP1 = 0, draws = 0;
        let s1 = { pts:0, wins:0, top5:0, top10:0, top20:0, cuts:0, strokes:0, holes:0, best:999, worst:-999, r1s:0, r1c:0, r4s:0, r4c:0 };
        let s2 = { pts:0, wins:0, top5:0, top10:0, top20:0, cuts:0, strokes:0, holes:0, best:999, worst:-999, r1s:0, r1c:0, r4s:0, r4c:0 };
        
        activeFiles.forEach(f => {
            const player1 = f.content.find(pl => normalizeName(pl.name) === norm1 || getDistance(normalizeName(pl.name), norm1)<=1);
            const player2 = f.content.find(pl => normalizeName(pl.name) === norm2 || getDistance(normalizeName(pl.name), norm2)<=1);
            
            if(player1) { 
                s1.pts += player1.points; 
                if(player1.rank===1) s1.wins++; if(player1.rank<=5) s1.top5++; if(player1.rank<=10) s1.top10++; if(player1.rank<=20) s1.top20++; 
                if(player1.points>0) s1.cuts++; 
                [player1.r1, player1.r2, player1.r3, player1.r4].forEach((r, i)=>{ 
                    if(r!=='NA'){ const v=parseInt(r); s1.strokes+=v; s1.holes+=18; if(v<s1.best)s1.best=v; if(v>s1.worst)s1.worst=v; if(i===0){ s1.r1s+=v; s1.r1c++; } if(i===3){ s1.r4s+=v; s1.r4c++; } } 
                }); 
            }
            if(player2) { 
                s2.pts += player2.points; 
                if(player2.rank===1) s2.wins++; if(player2.rank<=5) s2.top5++; if(player2.rank<=10) s2.top10++; if(player2.rank<=20) s2.top20++; 
                if(player2.points>0) s2.cuts++; 
                [player2.r1, player2.r2, player2.r3, player2.r4].forEach((r, i)=>{ 
                    if(r!=='NA'){ const v=parseInt(r); s2.strokes+=v; s2.holes+=18; if(v<s2.best)s2.best=v; if(v>s2.worst)s2.worst=v; if(i===0){ s2.r1s+=v; s2.r1c++; } if(i===3){ s2.r4s+=v; s2.r4c++; } } 
                }); 
            }
            if(player1 && player2) { 
                mutualTournaments++; 
                if(player1.rank < player2.rank) p1BeatP2++; 
                else if(player2.rank < player1.rank) p2BeatP1++; 
                else draws++; 
            }
        });

        const avg1 = s1.holes ? (s1.strokes/(s1.holes/18)).toFixed(2) : '-'; const avg2 = s2.holes ? (s2.strokes/(s2.holes/18)).toFixed(2) : '-';
        const r1_1 = s1.r1c ? (s1.r1s/s1.r1c).toFixed(2) : '-'; const r1_2 = s2.r1c ? (s2.r1s/s2.r1c).toFixed(2) : '-';
        const r4_1 = s1.r4c ? (s1.r4s/s1.r4c).toFixed(2) : '-'; const r4_2 = s2.r4c ? (s2.r4s/s2.r4c).toFixed(2) : '-';
        
        const row = (label, v1, v2, lowIsGood=false) => { 
            let c1='', c2=''; 
            let n1 = parseFloat(v1); let n2 = parseFloat(v2); 
            if(isNaN(n1)) n1 = lowIsGood ? 9999 : -1; if(isNaN(n2)) n2 = lowIsGood ? 9999 : -1; 
            if(v1 === v2) { c1='val-draw'; c2='val-draw'; } 
            else if(lowIsGood) { if(n1 < n2) { c1='val-better'; c2='val-worse'; } else { c1='val-worse'; c2='val-better'; } } 
            else { if(n1 > n2) { c1='val-better'; c2='val-worse'; } else { c1='val-worse'; c2='val-better'; } } 
            if(v1==999) v1='-'; if(v2==999) v2='-'; if(v1==-999) v1='-'; if(v2==-999) v2='-'; 
            return `<div class="vs-cell ${c1}">${v1}</div><div class="vs-label-cell">${label}</div><div class="vs-cell ${c2}">${v2}</div>`; 
        };

        container.innerHTML = `
            <div class="vs-detailed-grid">
                <div class="vs-header">${p1Name}</div><div class="vs-header">ŠTATISTIKA</div><div class="vs-header">${p2Name}</div>
                <div style="grid-column:1/-1; padding:15px; background:#222; text-align:center; margin-bottom:10px; border:1px solid #444; border-radius:8px;">
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">VZÁJOMNÉ ZÁPASY (Spoločné turnaje: ${mutualTournaments})</div>
                    <div style="display:flex; justify-content:center; align-items:center; gap:20px; font-size:1.8rem; font-weight:bold;">
                        <span style="color:${p1BeatP2 > p2BeatP1 ? 'var(--accent-green)' : '#fff'}">${p1BeatP2}</span>
                        <span style="font-size:1rem; color:#555;">vs</span>
                        <span style="color:${p2BeatP1 > p1BeatP2 ? 'var(--accent-green)' : '#fff'}">${p2BeatP1}</span>
                    </div>
                    ${draws > 0 ? `<div style="font-size:0.7rem; color:#555; margin-top:2px;">(Remízy: ${draws})</div>` : ''}
                </div>
                ${row('Body Celkovo', s1.pts.toFixed(0), s2.pts.toFixed(0))}
                ${row('Výhry', s1.wins, s2.wins)}
                ${row('Top 5', s1.top5, s2.top5)}
                ${row('Top 10', s1.top10, s2.top10)}
                ${row('Top 20', s1.top20, s2.top20)}
                ${row('Prejdené Cuty', s1.cuts, s2.cuts)}
                ${row('Priemer Úderov', avg1, avg2, true)}
                ${row('Priemer 1. Kola', r1_1, r1_2, true)}
                ${row('Priemer 4. Kola', r4_1, r4_2, true)}
                ${row('Najlepšie Kolo', s1.best, s2.best, true)}
                ${row('Najhoršie Kolo', s1.worst, s2.worst, true)}
            </div>`;
    }

    // --- Settings & Utils ---
function createModal(contentHtml, id = null) {
    const layer = document.getElementById('popupsLayer');
    const overlay = document.createElement('div');
    
    // OPRAVA: Ak už je nejaké okno otvorené (stack > 0), pridáme triedu 'stacked'
    if (modalStack.length > 0) {
        overlay.className = 'modal-overlay stacked';
    } else {
        overlay.className = 'modal-overlay';
    }

    overlay.style.zIndex = 1000 + modalStack.length * 10;
    if (id) overlay.id = id + '-overlay';
    overlay.innerHTML = `<div class="modal">${contentHtml}</div>`;
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeTopModal(); });
    layer.appendChild(overlay);
    modalStack.push(overlay);
    document.body.style.overflow = 'hidden';
    window.history.pushState({ modal: true }, "");
    if (appState.settings.zoom === 2) updateViewport();
}


    function closeTopModal(backHistory = true) {
        if (modalStack.length === 0) return;
        const overlay = modalStack.pop();
        overlay.remove();
        if (modalStack.length === 0) document.body.style.overflow = 'auto';
        
        if (backHistory) {
            // Nastavíme vlajku, že toto zatvorenie sme vyvolali my (krížikom), nie tlačidlom späť
            isProgrammaticBack = true;
            window.history.back();
        }
        
        if (appState.settings.zoom === 2) updateViewport();
    }


    function toggleZoom() { appState.settings.zoom = (appState.settings.zoom + 1) % 3; updateViewport(); saveAuto(); }
    function updateViewport() { applyZoom(appState.settings.zoom); }
    function applyZoom(mode) {
        const meta = document.getElementById('viewportMeta'); const btn = document.querySelector('button[title="Zoom Mode"]');
        let targetContent = 'width=device-width, initial-scale=1.0'; let btnColor = 'var(--text-main)';
        if (mode === 1) { targetContent = 'width=1200, initial-scale=0.5'; btnColor = 'var(--accent-green)'; } 
        else if (mode === 2) { btnColor = 'var(--accent-blue)'; targetContent = modalStack.length > 0 ? 'width=1200, initial-scale=0.5' : 'width=device-width, initial-scale=1.0'; }
        meta.setAttribute('content', targetContent); if(btn) btn.style.color = btnColor;
    }
    function openSettings() {
        let themeBtns = '';
        Object.keys(colorSchemes).forEach(k => {
            const sch = colorSchemes[k];
            const borderColor = (appState.settings.theme === k) ? '#fff' : 'transparent';
            themeBtns += `<div class="theme-btn" style="background:${sch.bg}; border-color:${borderColor}; color:${sch.text}" onclick="changeTheme('${k}')">${k}</div>`;
        });
        const zoomLabels = ['Mobilný', 'Desktop', 'Hybridný'];
        const currentZoomLabel = zoomLabels[appState.settings.zoom] || 'Mobilný';
        const themesDisplay = appState.settings.themesOpen ? 'grid' : 'none';
        const toggleBtnText = appState.settings.themesOpen ? 'Skryť Témy' : 'Zobraziť Témy';

        const html = `
            <div class="modal-header"><h2>Nastavenia</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div>
            <div class="modal-body">
                <h3>Štatistiky & Zoznamy</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
                    <button class="btn btn-full-width" style="background:linear-gradient(135deg, #f1c40f 0%, #b8860b 100%); color:black; font-weight:bold; border:1px solid #fff;" onclick="openGlobalAchievementsList()">🏆 Zoznam Achievementov</button>
                </div>

                <h3>Nástroje</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
                    <button class="btn btn-green" onclick="document.getElementById('fileInput').click()">Vložiť .txt</button>
                    <button class="btn btn-blue" onclick="document.getElementById('seasonFileInput').click()">Vložiť Sezónu</button>
                    <button class="btn btn-grey" onclick="openFileManager()">Správca súborov</button>
                    <button class="btn btn-red" onclick="clearDB()">Vymazať DB</button>
                    <button class="btn btn-grey" onclick="toggleZoomInSettings()">Režim: ${currentZoomLabel}</button>
                </div>
                <h3>Vzhľad</h3>
                <button class="btn btn-full-width btn-grey" onclick="toggleThemes(this)" style="margin-bottom:10px;">${toggleBtnText}</button>
                <div class="theme-grid" id="themeContainer" style="display:${themesDisplay};">${themeBtns}</div>
                <h3>Sloty (Uložiť / Načítať)</h3>
                <div class="slot-grid" id="slotContainer"></div>
            </div>`;
        createModal(html);
        renderSlots();
    }

    function toggleThemes(btn) {
        appState.settings.themesOpen = !appState.settings.themesOpen;
        const container = document.getElementById('themeContainer');
        if (appState.settings.themesOpen) { container.style.display = 'grid'; btn.innerText = 'Skryť Témy'; } 
        else { container.style.display = 'none'; btn.innerText = 'Zobraziť Témy'; }
        saveAuto();
    }

    function toggleZoomInSettings() { toggleZoom(); closeTopModal(); openSettings(); }
    function changeTheme(name) { appState.settings.theme = name; applyTheme(name); saveAuto(); closeTopModal(); openSettings(); }
    function applyTheme(name) {
        const t = colorSchemes[name] || colorSchemes['Default'];
        const root = document.documentElement;
        root.style.setProperty('--bg-color', t.bg); root.style.setProperty('--card-bg', t.card); root.style.setProperty('--text-main', t.text); root.style.setProperty('--accent-green', t.accent);
    }

    function openFileManager() {
        const files = [...db.files].sort(compareFiles);
        const list = files.map(f => {
            let label = f.name, style = '';
            if (f.isImportant) { label = '★ ' + label; style = 'color: var(--highlight-gold); font-weight: bold;'; } 
            else if (f.isSignificant) { label = '= ' + label; style = 'color: var(--accent-blue);'; }
            
            // Pridané tlačidlo na stiahnutie (⬇)
            return `
            <div style="display:flex; justify-content:space-between; background:#222; padding:8px; margin-bottom:5px; border-radius:4px; align-items:center;">
                <span style="${style}; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:10px;">${label}</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-blue btn-sm" onclick="downloadOriginalFile(${f.id})" title="Stiahnuť originál TXT">⬇</button>
                    <button class="btn btn-red btn-sm" onclick="deleteFile(${f.id})" title="Vymazať">X</button>
                </div>
            </div>`
        }).join('');
        
        const seasonList = db.seasonStats.map(s => `<div style="display:flex; justify-content:space-between; background:#1a3a3a; padding:8px; margin-bottom:5px; border-radius:4px; align-items:center; border:1px solid #2ecc71"><span>SEZÓNA ${s.season} (${s.filename})</span><button class="btn btn-red btn-sm" onclick="deleteSeasonFile('${s.season}')">X</button></div>`).join('');
        const html = `<div class="modal-header"><h2>Správca súborov</h2><button class="close-btn" onclick="closeTopModal()">&times;</button></div><div class="modal-body"><h3>Sezónne Štatistiky</h3>${seasonList || '<small>Žiadne sezónne súbory.</small>'}<h3 style="margin-top:15px">Turnajové Súbory (${files.length})</h3>${list || '<small>Žiadne turnaje.</small>'}</div>`;
        createModal(html);
    }

    // --- NOVÁ FUNKCIA NA REKONŠTRUKCIU A STIAHNUTIE TXT ---
    function downloadOriginalFile(id) {
        const f = db.files.find(x => x.id === id);
        if(!f) return;
        
        let content = "";
        // Zoradíme podľa umiestnenia, ako v pôvodnom súbore zvyčajne býva
        const players = [...f.content].sort((a,b) => a.rank - b.rank);
        
        players.forEach((p, idx) => {
            content += `${p.name}\n${p.par}\n${p.r1}\n${p.r2}\n${p.r3}\n${p.r4}\n${p.points}`;
            if(idx < players.length - 1) content += "\n";
        });

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = f.name.endsWith('.txt') ? f.name : f.name + '.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function deleteFile(id) { db.files = db.files.filter(f => f.id !== id); calculateELO(); calculateGlobalAchievements(); saveAuto(); closeTopModal(); openFileManager(); renderApp(); }
    function deleteSeasonFile(season) { db.seasonStats = db.seasonStats.filter(s => s.season !== season); calculateGlobalAchievements(); saveAuto(); closeTopModal(); openFileManager(); renderApp(); }
    function clearDB() { 
        if(confirm('Naozaj vymazať celú databázu a všetky získané odznaky?')) { 
            db.files = []; 
            db.seasonStats = []; 
            appState.filters.events = []; 
            appState.filters.seasons = []; 
            appState.unlockedBadges = {}; 
            calculateELO(); 
            calculateGlobalAchievements(); 
            renderApp(); 
            saveAuto(); 
            closeTopModal(); 
        } 
    }

    function renderSlots() {
        const container = document.getElementById('slotContainer'); if(!container) return; container.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
            const key = `ArciWeb_Slot_${i}`; const exists = localStorage.getItem(key) !== null;
            const div = document.createElement('div'); div.className = 'slot-card';
            div.innerHTML = `<strong style="color:${exists?'var(--accent-green)':'#555'}">Slot ${i}</strong><div style="margin-top:5px; display:flex; flex-direction:column; gap:4px;"><button class="btn btn-sm btn-green" onclick="saveToSlot(${i})">Uložiť</button><button class="btn btn-sm btn-grey" onclick="loadFromSlot(${i})" ${!exists?'disabled':''}>Načítať</button><button class="btn btn-sm btn-red" onclick="deleteSlot(${i})" ${!exists?'disabled':''}>Zmazať</button><div style="display:flex; gap:2px;"><button class="btn btn-sm btn-blue" style="flex:1" onclick="downloadSlot(${i})" ${!exists?'disabled':''}>⬇</button><button class="btn btn-sm btn-blue" style="flex:1" onclick="uploadSlotTrigger(${i})">⬆</button></div></div>`;
            container.appendChild(div);
        }
    }

    function saveToSlot(i) { 
        if(confirm("Naozaj chcete uložiť hru do Slotu " + i + "? (Prepíše to staré dáta)")) {
            const data = JSON.stringify({ db, appState }); 
            localStorage.setItem(`ArciWeb_Slot_${i}`, data); 
            renderSlots(); 
        }
    }


    function loadFromSlot(i) {
        if(confirm("Naozaj chcete načítať hru zo Slotu " + i + "? (Stratíte neuložené zmeny)")) {
            const data = localStorage.getItem(`ArciWeb_Slot_${i}`);
            if(data) {
                const parsed = JSON.parse(data);
                db = parsed.db; if(!db.seasonStats) db.seasonStats = [];
                appState = parsed.appState;
                calculateELO();
                calculateGlobalAchievements();
                applyTheme(appState.settings.theme); updateViewport(); renderApp(); saveAuto(); closeTopModal();
            }
        }
    }

    function deleteSlot(i) { 
        if(confirm("Naozaj chcete vymazať hru v Slote " + i + "?")) {
            localStorage.removeItem(`ArciWeb_Slot_${i}`); 
            renderSlots(); 
        }
    }
    function saveAuto() { localStorage.setItem('autosave_v380', JSON.stringify({ db, appState })); }
    function loadAutoSave() {
        const data = localStorage.getItem('autosave_v380');
        if(data) { try { const parsed = JSON.parse(data); if(parsed.db && parsed.appState) { db = parsed.db; if(!db.seasonStats) db.seasonStats = []; appState = parsed.appState; } } catch(e) {} }
    }

    function downloadSlot(i) {
        const data = localStorage.getItem(`ArciWeb_Slot_${i}`); if (!data) return;
        const blob = new Blob([data], { type: 'application/json' }); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `ArciWeb_Slot_${i}_Backup.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function uploadSlotTrigger(i) { slotToUpload = i; document.getElementById('slotFileInput').click(); }
    function finishSlotUpload(files) {
        if (files.length === 0 || slotToUpload === null) return;
        const file = files[0]; const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(!json.db) throw new Error('Invalid format');
                if(!json.db.seasonStats) json.db.seasonStats = [];
                localStorage.setItem(`ArciWeb_Slot_${slotToUpload}`, JSON.stringify(json));
                renderSlots();
            } catch (err) { alert('Neplatný JSON súbor!'); }
            slotToUpload = null; document.getElementById('slotFileInput').value = '';
        };
        reader.readAsText(file);
    }
    
    let playerCardsData = [];
    let playerCardsSort = { col: 'ovr', dir: 'desc' };

    window.showGlobalPlayerCards = function() {
        playerCardsData = calculateAllPlayersAttributes();
        sortPlayerCardsData();
        renderPlayerCardsModal();
    };

    function renderPlayerCardsModal() {
        const rows = playerCardsData.map((p, index) => {
            const rank = index + 1;
            let ovrColor = '#fff';
            if(p.ovr >= 90) ovrColor = 'var(--highlight-gold)';
            else if(p.ovr >= 80) ovrColor = 'var(--accent-green)';
            else if(p.ovr >= 70) ovrColor = 'var(--accent-blue)';

            let rankColor = '#e74c3c'; 
            if (rank === 1) rankColor = '#ffd700';
            else if (rank === 2) rankColor = '#c0c0c0';
            else if (rank === 3) rankColor = '#cd7f32';
            else if (rank <= 10) rankColor = '#2ecc71';
            else if (rank <= 100) rankColor = '#e67e22';

            return `
            <tr onclick="openPlayerProfile('${p.name}')" style="cursor:pointer">
                <td><span style="font-weight:bold; color:${rankColor}">${rank}.</span></td>
                <td style="text-align:left; font-weight:bold;">${p.name}</td>
                <td style="font-weight:bold; color:${ovrColor}; font-size:1.1rem;">${p.ovr}</td>
                <td class="${p.pwr >= 85 ? 'val-better' : ''}">${p.pwr}</td>
                <td class="${p.acc >= 85 ? 'val-better' : ''}">${p.acc}</td>
                <td class="${p.mnt >= 85 ? 'val-better' : ''}">${p.mnt}</td>
                <td class="${p.con >= 85 ? 'val-better' : ''}">${p.con}</td>
                <td class="${p.frm >= 85 ? 'val-better' : ''}">${p.frm}</td>
                <td style="color:#aaa;">${p.xp}</td>
            </tr>`;
        }).join('');

        const sortIcon = (col) => playerCardsSort.col === col ? (playerCardsSort.dir === 'asc' ? '▲' : '▼') : '';

        const html = `
            <div class="modal-header">
                <h2>Rebríček Hráčov (FIFA Cards)</h2>
                <button class="close-btn" onclick="closeTopModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background:#252525; padding:12px; border-radius:8px; border:1px solid #444; margin-bottom:15px; font-size:0.8rem; color:#bbb; line-height:1.4;">
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:10px;">
                        <div><strong style="color:#fff">1. PWR (Power):</strong> Sila útoku (Birdies/Eagles + Wins)</div>
                        <div><strong style="color:#fff">2. ACC (Accuracy):</strong> Presnosť (Par vs Bogey)</div>
                        <div><strong style="color:#fff">3. MNT (Mental):</strong> Psychika (R4 vs R1 + Majors)</div>
                        <div><strong style="color:#fff">4. CON (Consistency):</strong> Konzistencia (Cuts + Top 20)</div>
                        <div><strong style="color:#fff">5. FRM (Form):</strong> Forma (Posledné 3 turnaje)</div>
                        <div><strong style="color:#fff">XP:</strong> Počet turnajov</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th onclick="sortPlayerCards('name')">Meno ${sortIcon('name')}</th>
                                <th onclick="sortPlayerCards('ovr')" style="color:var(--highlight-gold)">OVR ${sortIcon('ovr')}</th>
                                <th onclick="sortPlayerCards('pwr')" title="Power">PWR ${sortIcon('pwr')}</th>
                                <th onclick="sortPlayerCards('acc')" title="Accuracy">ACC ${sortIcon('acc')}</th>
                                <th onclick="sortPlayerCards('mnt')" title="Mental">MNT ${sortIcon('mnt')}</th>
                                <th onclick="sortPlayerCards('con')" title="Consistency">CON ${sortIcon('con')}</th>
                                <th onclick="sortPlayerCards('frm')" title="Form">FRM ${sortIcon('frm')}</th>
                                <th onclick="sortPlayerCards('xp')" title="Experience (Turnaje)">XP ${sortIcon('xp')}</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>
        `;
        const existingOverlay = document.getElementById('cards-overlay');
        if (existingOverlay) {
            existingOverlay.querySelector('.modal').innerHTML = html;
        } else {
            createModal(html, 'cards-overlay');
        }
    }

    window.sortPlayerCards = function(col) {
        if (playerCardsSort.col === col) {
            playerCardsSort.dir = playerCardsSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            playerCardsSort.col = col;
            playerCardsSort.dir = 'desc'; 
            if(col === 'name') playerCardsSort.dir = 'asc';
        }
        sortPlayerCardsData();
        renderPlayerCardsModal();
    }

    function sortPlayerCardsData() {
        const col = playerCardsSort.col;
        const dir = playerCardsSort.dir === 'asc' ? 1 : -1;
        
        playerCardsData.sort((a, b) => {
            let valA = a[col];
            let valB = b[col];
            if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
            return (valA - valB) * dir;
        });
    }

    function calculateAllPlayersAttributes() {
        const pMap = {};
        const sMap = {}; 

        const sortedFiles = [...db.files].sort(compareFiles);
        sortedFiles.forEach(f => {
            // --- KFT IZOLÁCIA: KFT turnaje sa nepočítajú do kariet ---
            if (f.type === 'KFT') return;

            f.content.forEach(p => {
                const name = normalizeName(p.name);
                if (!pMap[name]) pMap[name] = { 
                    realName: p.name, wins: 0, top5: 0, top20: 0, cut: 0, tourneys: 0, majorCount: 0,
                    r1Sum: 0, r1Count: 0, r4Sum: 0, r4Count: 0, totalHoles: 0,
                    historyRanks: [] 
                };
                
                const s = pMap[name];
                s.tourneys++;
                s.historyRanks.push(p.rank);
                
                if (p.rank === 1) s.wins++;
                if (p.rank <= 5) s.top5++;
                if (p.rank <= 20) s.top20++;
                if (p.points > 0) s.cut++;
                if (f.isImportant || f.isSignificant) s.majorCount++;

                if (p.r1 !== 'NA') { s.r1Sum += parseInt(p.r1); s.r1Count++; s.totalHoles += 18; }
                if (p.r4 !== 'NA') { s.r4Sum += parseInt(p.r4); s.r4Count++; s.totalHoles += 18; }
                if (p.r2 !== 'NA') s.totalHoles += 18;
                if (p.r3 !== 'NA') s.totalHoles += 18;
            });
        });

        db.seasonStats.forEach(f => {
            f.content.forEach(p => {
                const name = normalizeName(p.name);
                if (!sMap[name]) sMap[name] = { birdies: 0, eagles: 0, pars: 0, bogeys: 0 };
                sMap[name].birdies += p.stats.birdies;
                sMap[name].eagles += p.stats.eagles;
                sMap[name].pars += p.stats.pars;
                sMap[name].bogeys += p.stats.bogeys;
            });
        });

        const results = [];
        const clamp = (v) => Math.max(40, Math.min(99, Math.round(v)));

        Object.keys(pMap).forEach(key => {
            const stats = pMap[key];
            const sStats = sMap[key] || { birdies: 0, eagles: 0, pars: 0, bogeys: 0 };
            
            const holesPlayed = stats.totalHoles || 1;
            const birdieRatio = (sStats.birdies + (sStats.eagles*3)) / holesPlayed;
            let pwr = 50 + (birdieRatio * 120) + (stats.wins * 1.5);

            const safeRatio = sStats.bogeys > 0 ? (sStats.pars / sStats.bogeys) : (sStats.pars > 0 ? 15 : 5);
            let acc = 55 + (safeRatio * 2.5);

            const r1Avg = stats.r1Count ? stats.r1Sum/stats.r1Count : 72;
            const r4Avg = stats.r4Count ? stats.r4Sum/stats.r4Count : 72;
            const clutchFactor = (r1Avg - r4Avg);
            let mnt = 60 + (clutchFactor * 5) + (stats.top5 * 1.5) + (stats.majorCount * 1);

            const cutPct = stats.tourneys ? (stats.cut / stats.tourneys) : 0;
            const top20Pct = stats.tourneys ? (stats.top20 / stats.tourneys) : 0;
            let con = 40 + (cutPct * 30) + (top20Pct * 30);

            let form = 70;
            if(stats.historyRanks.length > 0) {
                const last3 = stats.historyRanks.slice(Math.max(0, stats.historyRanks.length - 3));
                const avgPos = last3.reduce((a,b) => a + b, 0) / last3.length;
                form = 99 - (avgPos * 1.2);
            }

            pwr = clamp(pwr); acc = clamp(acc); mnt = clamp(mnt); con = clamp(con); form = clamp(form);
            const ovr = Math.round((pwr + acc + mnt + con + form) / 5);

            results.push({
                name: stats.realName,
                ovr: ovr, pwr: pwr, acc: acc, mnt: mnt, con: con, frm: form,
                xp: stats.tourneys
            });
        });

        return results;
    }






</script>
</body>
</html>
